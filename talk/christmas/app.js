var Z9=Object.create;var{getPrototypeOf:G9,defineProperty:qw,getOwnPropertyNames:N9}=Object;var J9=Object.prototype.hasOwnProperty;var X9=(u,W,N)=>{N=u!=null?Z9(G9(u)):{};let J=W||!u||!u.__esModule?qw(N,"default",{value:u,enumerable:!0}):N;for(let H of N9(u))if(!J9.call(J,H))qw(J,H,{get:()=>u[H],enumerable:!0});return J};var e=(u,W)=>()=>(W||u((W={exports:{}}).exports,W),W.exports);var fw=e((jq,L5)=>{(function(u,W){if(typeof jq=="object"&&typeof L5=="object")L5.exports=W();else if(typeof define=="function"&&define.amd)define([],W);else if(typeof jq=="object")jq.Ably=W();else u.Ably=W()})(jq,()=>{var u={},W={exports:u},N=Object.defineProperty,J=Object.defineProperties,H=Object.getOwnPropertyDescriptor,K=Object.getOwnPropertyDescriptors,V=Object.getOwnPropertyNames,h=Object.getOwnPropertySymbols,Y=Object.prototype.hasOwnProperty,b=Object.prototype.propertyIsEnumerable,S=(q,$,w)=>($ in q)?N(q,$,{enumerable:!0,configurable:!0,writable:!0,value:w}):q[$]=w,_=(q,$)=>{for(var w in $||($={}))if(Y.call($,w))S(q,w,$[w]);if(h){for(var w of h($))if(b.call($,w))S(q,w,$[w])}return q},E=(q,$)=>J(q,K($)),$0=(q,$)=>{var w={};for(var Z in q)if(Y.call(q,Z)&&$.indexOf(Z)<0)w[Z]=q[Z];if(q!=null&&h){for(var Z of h(q))if($.indexOf(Z)<0&&b.call(q,Z))w[Z]=q[Z]}return w},v=(q,$)=>{for(var w in $)N(q,w,{get:$[w],enumerable:!0})},P=(q,$,w,Z)=>{if($&&typeof $==="object"||typeof $==="function"){for(let G of V($))if(!Y.call(q,G)&&G!==w)N(q,G,{get:()=>$[G],enumerable:!(Z=H($,G))||Z.enumerable})}return q},f=(q)=>P(N({},"__esModule",{value:!0}),q),g={};v(g,{ErrorInfo:()=>D,Realtime:()=>q5,Rest:()=>o8,default:()=>u9,makeProtocolMessageFromDeserialized:()=>_7,msgpack:()=>J5}),W.exports=f(g);var B=class{},a=typeof global<"u"?global:typeof window<"u"?window:self;function G0(q,$){return`${q}`.padStart($?3:2,"0")}function s(q){return B.Config.logTimestamps?function($){let w=new Date;q(G0(w.getHours())+":"+G0(w.getMinutes())+":"+G0(w.getSeconds())+"."+G0(w.getMilliseconds(),1)+" "+$)}:function($){q($)}}var W0=()=>{var q;let $,w;if(typeof((q=a==null?void 0:a.console)==null?void 0:q.log)==="function")$=function(...Z){console.log.apply(console,Z)},w=console.warn?function(...Z){console.warn.apply(console,Z)}:$;else $=w=function(){};return[$,w].map(s)},m=class q{constructor(){this.deprecated=($,w)=>{this.deprecationWarning(`${$} is deprecated and will be removed in a future version. ${w}`)},this.shouldLog=($)=>{return $<=this.logLevel},this.setLog=($,w)=>{if($!==void 0)this.logLevel=$;if(w!==void 0)this.logHandler=this.logErrorHandler=w},this.logLevel=q.defaultLogLevel,this.logHandler=q.defaultLogHandler,this.logErrorHandler=q.defaultLogErrorHandler}static initLogHandlers(){let[$,w]=W0();this.defaultLogHandler=$,this.defaultLogErrorHandler=w,this.defaultLogger=new q}static logActionNoStrip($,w,Z,G){$.logAction(w,Z,G)}logAction($,w,Z){if(this.shouldLog($))($===1?this.logErrorHandler:this.logHandler)("Ably: "+w+": "+Z,$)}renamedClientOption($,w){this.deprecationWarning(`The \`${$}\` client option has been renamed to \`${w}\`. Please update your code to use \`${w}\` instead. \`${$}\` will be removed in a future version.`)}renamedMethod($,w,Z){this.deprecationWarning(`\`${$}\`’s \`${w}\` method has been renamed to \`${Z}\`. Please update your code to use \`${Z}\` instead. \`${w}\` will be removed in a future version.`)}deprecationWarning($){if(this.shouldLog(1))this.logErrorHandler(`Ably: Deprecation warning - ${$}`,1)}};m.defaultLogLevel=1,m.LOG_NONE=0,m.LOG_ERROR=1,m.LOG_MAJOR=2,m.LOG_MINOR=3,m.LOG_MICRO=4,m.logAction=(q,$,w,Z)=>{m.logActionNoStrip(q,$,w,Z)};var H0=m,Q=H0,z0={};v(z0,{Format:()=>B$,allSame:()=>D$,allToLowerCase:()=>S8,allToUpperCase:()=>M$,arrChooseN:()=>A$,arrDeleteValue:()=>z$,arrEquals:()=>S$,arrIntersect:()=>O$,arrIntersectOb:()=>V$,arrPopRandomElement:()=>_8,arrWithoutValue:()=>Mu,cheapRandStr:()=>iq,containsValue:()=>Au,copy:()=>B1,createMissingPluginError:()=>pq,dataSizeBytes:()=>I$,decodeBody:()=>F0,encodeBody:()=>P0,ensureArray:()=>H$,forInOwnNonNullProperties:()=>h$,getBackoffCoefficient:()=>L$,getGlobalObject:()=>E8,getJitterCoefficient:()=>R$,getRetryTime:()=>T8,inherits:()=>ju,inspectBody:()=>Y$,inspectError:()=>w0,intersect:()=>K$,isEmpty:()=>Yu,isErrorInfoOrPartialErrorInfo:()=>b8,isNil:()=>c0,isObject:()=>Y1,keysArray:()=>l1,matchDerivedChannel:()=>b$,mixin:()=>n,parseQueryString:()=>yq,prototypicalClone:()=>U$,randomString:()=>j$,shallowClone:()=>Iu,shallowEquals:()=>_$,throwMissingPluginError:()=>h0,toBase64:()=>gq,toQueryString:()=>r1,valuesArray:()=>F$,whenPromiseSettles:()=>j0,withTimeoutAsync:()=>T$});function i0(q){let $="["+q.constructor.name;if(q.message)$+=": "+q.message;if(q.statusCode)$+="; statusCode="+q.statusCode;if(q.code)$+="; code="+q.code;if(q.cause)$+="; cause="+w0(q.cause);if(q.href&&!(q.message&&q.message.indexOf("help.ably.io")>-1))$+="; see "+q.href+" ";return $+="]",$}var D=class q extends Error{constructor($,w,Z,G){super($);if(typeof Object.setPrototypeOf<"u")Object.setPrototypeOf(this,q.prototype);this.code=w,this.statusCode=Z,this.cause=G}toString(){return i0(this)}static fromValues($){let{message:w,code:Z,statusCode:G}=$;if(typeof w!=="string"||typeof Z!=="number"||typeof G!=="number")throw Error("ErrorInfo.fromValues(): invalid values: "+B.Config.inspect($));let X=Object.assign(new q(w,Z,G),$);if(X.code&&!X.href)X.href="https://help.ably.io/error/"+X.code;return X}},o=class q extends Error{constructor($,w,Z,G){super($);if(typeof Object.setPrototypeOf<"u")Object.setPrototypeOf(this,q.prototype);this.code=w,this.statusCode=Z,this.cause=G}toString(){return i0(this)}static fromValues($){let{message:w,code:Z,statusCode:G}=$;if(typeof w!=="string"||!c0(Z)&&typeof Z!=="number"||!c0(G)&&typeof G!=="number")throw Error("PartialErrorInfo.fromValues(): invalid values: "+B.Config.inspect($));let X=Object.assign(new q(w,Z,G),$);if(X.code&&!X.href)X.href="https://help.ably.io/error/"+X.code;return X}};function U1(q){return Math.floor(Math.random()*q.length)}function n(q,...$){for(let w=0;w<$.length;w++){let Z=$[w];if(!Z)break;for(let G in Z)if(Object.prototype.hasOwnProperty.call(Z,G))q[G]=Z[G]}return q}function B1(q){return n({},q)}function H$(q){if(c0(q))return[];if(Array.isArray(q))return q;return[q]}function Y1(q){return Object.prototype.toString.call(q)=="[object Object]"}function Yu(q){for(let $ in q)return!1;return!0}function c0(q){return q==null}function Iu(q){let $={};for(let w in q)$[w]=q[w];return $}function U$(q,$){class w{}w.prototype=q;let Z=new w;if($)n(Z,$);return Z}var ju=function(q,$){if(B.Config.inherits){B.Config.inherits(q,$);return}q.super_=$,q.prototype=U$($.prototype,{constructor:q})};function Au(q,$){for(let w in q)if(q[w]==$)return!0;return!1}function K$(q,$){return Array.isArray($)?O$(q,$):V$(q,$)}function O$(q,$){let w=[];for(let Z=0;Z<q.length;Z++){let G=q[Z];if($.indexOf(G)!=-1)w.push(G)}return w}function V$(q,$){let w=[];for(let Z=0;Z<q.length;Z++){let G=q[Z];if(G in $)w.push(G)}return w}function z$(q,$){let w=q.indexOf($),Z=w!=-1;if(Z)q.splice(w,1);return Z}function Mu(q,$){let w=q.slice();return z$(w,$),w}function l1(q,$){let w=[];for(let Z in q){if($&&!Object.prototype.hasOwnProperty.call(q,Z))continue;w.push(Z)}return w}function F$(q,$){let w=[];for(let Z in q){if($&&!Object.prototype.hasOwnProperty.call(q,Z))continue;w.push(q[Z])}return w}function h$(q,$){for(let w in q)if(Object.prototype.hasOwnProperty.call(q,w)&&q[w])$(w)}function D$(q,$){if(q.length===0)return!0;let w=q[0][$];return q.every(function(Z){return Z[$]===w})}var B$=((q)=>{return q.msgpack="msgpack",q.json="json",q})(B$||{});function _8(q){return q.splice(U1(q),1)[0]}function r1(q){let $=[];if(q)for(let w in q)$.push(encodeURIComponent(w)+"="+encodeURIComponent(q[w]));return $.length?"?"+$.join("&"):""}function yq(q){let $,w=/([^?&=]+)=?([^&]*)/g,Z={};while($=w.exec(q))Z[decodeURIComponent($[1])]=decodeURIComponent($[2]);return Z}function b8(q){return typeof q=="object"&&q!==null&&(q instanceof D||q instanceof o)}function w0(q){var $,w;if(q instanceof Error||(($=q==null?void 0:q.constructor)==null?void 0:$.name)==="ErrorInfo"||((w=q==null?void 0:q.constructor)==null?void 0:w.name)==="PartialErrorInfo")return q.toString();return B.Config.inspect(q)}function Y$(q){if(B.BufferUtils.isBuffer(q))return q.toString();else if(typeof q==="string")return q;else return B.Config.inspect(q)}function I$(q){if(B.BufferUtils.isBuffer(q))return B.BufferUtils.byteLength(q);if(typeof q==="string")return B.Config.stringByteSize(q);if(typeof q==="number")return 8;if(typeof q==="boolean")return 1;throw Error(`Expected input of Utils.dataSizeBytes to be a string, a number, a boolean or a buffer, but was: ${typeof q}`)}function iq(){return String(Math.random()).substr(2)}var j$=async(q)=>{let $=await B.Config.getRandomArrayBuffer(q);return B.BufferUtils.base64Encode($)};function A$(q,$){let w=Math.min($,q.length),Z=q.slice(),G=[];for(let X=0;X<w;X++)G.push(_8(Z));return G}function j0(q,$){q.then((w)=>{$==null||$(null,w)}).catch((w)=>{$==null||$(w)})}function F0(q,$,w){if(w=="msgpack"){if(!$)h0("MsgPack");return $.decode(q)}return JSON.parse(String(q))}function P0(q,$,w){if(w=="msgpack"){if(!$)h0("MsgPack");return $.encode(q,!0)}return JSON.stringify(q)}function S8(q){return q.map(function($){return $&&$.toLowerCase()})}function M$(q){return q.map(function($){return $&&$.toUpperCase()})}function L$(q){return Math.min((q+2)/3,2)}function R$(){return 1-Math.random()*0.2}function T8(q,$){return q*L$($)*R$()}function E8(){if(typeof global<"u")return global;if(typeof window<"u")return window;return self}function _$(q,$){return Object.keys(q).every((w)=>q[w]===$[w])&&Object.keys($).every((w)=>$[w]===q[w])}function b$(q){let $=/^(\[([^?]*)(?:(.*))\])?(.+)$/,w=q.match($);if(!w||!w.length||w.length<5)throw new D("regex match failed",400,40010);if(w[2])throw new D(`cannot use a derived option with a ${w[2]} channel`,400,40010);return{qualifierParam:w[3]||"",channelName:w[4]}}function gq(q){let $=B.BufferUtils,w=$.utf8Encode(q);return $.base64Encode(w)}function S$(q,$){return q.length===$.length&&q.every(function(w,Z){return w===$[Z]})}function pq(q){return new D(`${q} plugin not provided`,40019,400)}function h0(q){throw pq(q)}async function T$(q,$=5000,w="Timeout expired"){let Z=new D(w,50000,500);return Promise.race([q,new Promise((G,X)=>setTimeout(()=>X(Z),$))])}var E$="2.15.0",Lu="ably-js/"+E$,C0={ENDPOINT:"main",ENVIRONMENT:"",REST_HOST:"rest.ably.io",REALTIME_HOST:"realtime.ably.io",FALLBACK_HOSTS:["main.a.fallback.ably-realtime.com","main.b.fallback.ably-realtime.com","main.c.fallback.ably-realtime.com","main.d.fallback.ably-realtime.com","main.e.fallback.ably-realtime.com"],PORT:80,TLS_PORT:443,TIMEOUTS:{disconnectedRetryTimeout:15000,suspendedRetryTimeout:30000,httpRequestTimeout:1e4,httpMaxRetryDuration:15000,channelRetryTimeout:15000,fallbackRetryTimeout:600000,connectionStateTtl:120000,realtimeRequestTimeout:1e4,recvTimeout:90000,webSocketConnectTimeout:1e4,webSocketSlowTimeout:4000},httpMaxRetryCount:3,maxMessageSize:65536,version:E$,protocolVersion:4,agent:Lu,getPort:Ru,getHttpScheme:_u,getPrimaryDomainFromEndpoint:P$,getEndpointFallbackHosts:C$,getFallbackHosts:n$,getHosts:bu,checkHost:y$,objectifyOptions:Tu,normaliseOptions:cu,defaultGetHeaders:Pu,defaultPostHeaders:Cu};function Ru(q,$){return $||q.tls?q.tlsPort:q.port}function _u(q){return q.tls?"https://":"http://"}function c$(q){return q.includes(".")||q.includes("::")||q==="localhost"}function P$(q){if(c$(q))return q;if(q.startsWith("nonprod:"))return`${q.replace("nonprod:","")}.realtime.ably-nonprod.net`;return`${q}.realtime.ably.net`}function C$(q){if(c$(q))return[];if(q.startsWith("nonprod:")){let $=q.replace("nonprod:","");return k$($,"ably-realtime-nonprod.com")}return k$(q,"ably-realtime.com")}function k$(q,$){return["a","b","c","d","e"].map((w)=>`${q}.${w}.fallback.${$}`)}function n$(q){let $=q.fallbackHosts,w=typeof q.httpMaxRetryCount<"u"?q.httpMaxRetryCount:C0.httpMaxRetryCount;return $?A$($,w):[]}function bu(q){return[q.primaryDomain].concat(n$(q))}function y$(q){if(typeof q!=="string")throw new D("host must be a string; was a "+typeof q,40000,400);if(!q.length)throw new D("host must not be zero-length",40000,400)}function Su(q){let $={};for(let w in C0.TIMEOUTS)$[w]=q[w]||C0.TIMEOUTS[w];return $}function c8(q){let $=C0.agent;if(q.agents)for(var w in q.agents)$+=" "+w+"/"+q.agents[w];return $}function Tu(q,$,w,Z,G){if(q===void 0){let U=$?`${w} must be initialized with either a client options object, an Ably API key, or an Ably Token`:`${w} must be initialized with a client options object`;throw Q.logAction(Z,Q.LOG_ERROR,`${w}()`,U),Error(U)}let X;if(typeof q==="string")if(q.indexOf(":")==-1){if(!$){let U=`${w} cannot be initialized with just an Ably Token; you must provide a client options object with a \`plugins\` property. (Set this Ably Token as the object’s \`token\` property.)`;throw Q.logAction(Z,Q.LOG_ERROR,`${w}()`,U),Error(U)}X={token:q}}else{if(!$){let U=`${w} cannot be initialized with just an Ably API key; you must provide a client options object with a \`plugins\` property. (Set this Ably API key as the object’s \`key\` property.)`;throw Q.logAction(Z,Q.LOG_ERROR,`${w}()`,U),Error(U)}X={key:q}}else X=q;if(G)X=E(_({},X),{plugins:_(_({},G),X.plugins)});return X}function Eu(q){if(q.endpoint&&(q.environment||q.restHost||q.realtimeHost))throw new D("The `endpoint` option cannot be used in conjunction with the `environment`, `restHost`, or `realtimeHost` options.",40106,400);if(q.environment&&(q.restHost||q.realtimeHost))throw new D("The `environment` option cannot be used in conjunction with the `restHost`, or `realtimeHost` options.",40106,400)}function cu(q,$,w){let Z=w!=null?w:Q.defaultLogger;if(q.environment)Z.deprecated("The `environment` client option","Use the `endpoint` client option instead.");if(q.restHost)Z.deprecated("The `restHost` client option","Use the `endpoint` client option instead.");if(q.realtimeHost)Z.deprecated("The `realtimeHost` client option","Use the `endpoint` client option instead.");if(Eu(q),typeof q.recover==="function"&&q.closeOnUnload===!0)Q.logAction(Z,Q.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),q.recover=void 0;if(!("closeOnUnload"in q))q.closeOnUnload=!q.recover;if(!("queueMessages"in q))q.queueMessages=!0;let G=q.endpoint||C0.ENDPOINT;if(!q.fallbackHosts&&!q.restHost&&!q.realtimeHost&&!q.port&&!q.tlsPort)q.fallbackHosts=C$(q.environment||G);let X=q.environment&&`${q.environment}.realtime.ably.net`,O=q.restHost||q.realtimeHost||X||P$(G);if((q.fallbackHosts||[]).concat(O).forEach(y$),q.port=q.port||C0.PORT,q.tlsPort=q.tlsPort||C0.TLS_PORT,!("tls"in q))q.tls=!0;let F=Su(q);if($)if("useBinaryProtocol"in q)q.useBinaryProtocol=B.Config.supportsBinary&&q.useBinaryProtocol;else q.useBinaryProtocol=B.Config.preferBinary;else q.useBinaryProtocol=!1;let z={};if(q.clientId)z["X-Ably-ClientId"]=B.BufferUtils.base64Encode(B.BufferUtils.utf8Encode(q.clientId));if(!("idempotentRestPublishing"in q))q.idempotentRestPublishing=!0;let I=null,j=q.connectivityCheckUrl;if(q.connectivityCheckUrl){let[M,c]=q.connectivityCheckUrl.split("?");if(I=c?yq(c):{},M.indexOf("://")===-1)M="https://"+M;j=M}let A=q.wsConnectivityCheckUrl;if(A&&A.indexOf("://")===-1)A="wss://"+A;return E(_({},q),{primaryDomain:O,maxMessageSize:q.maxMessageSize||C0.maxMessageSize,timeouts:F,connectivityCheckParams:I,connectivityCheckUrl:j,wsConnectivityCheckUrl:A,headers:z})}function vq(q,$,w){let Z=w||{};if(Z.cipher){if(!q)h0("Crypto");let G=q.getCipher(Z.cipher,$);Z.cipher=G.cipherParams,Z.channelCipher=G.cipher}else if("cipher"in Z)Z.cipher=void 0,Z.channelCipher=null;return Z}var i$={json:"application/json",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack",text:"text/plain"},g$={format:"json",protocolVersion:C0.protocolVersion};function Pu(q,{format:$,protocolVersion:w=g$.protocolVersion}={}){return{accept:i$[$!=null?$:q.useBinaryProtocol?"msgpack":"json"],"X-Ably-Version":w.toString(),"Ably-Agent":c8(q)}}function Cu(q,{format:$,protocolVersion:w=g$.protocolVersion}={}){let Z=i$[$!=null?$:q.useBinaryProtocol?"msgpack":"json"];return{accept:Z,"content-type":Z,"X-Ably-Version":w.toString(),"Ably-Agent":c8(q)}}var k=C0;function ku(q){return Object.assign(C0,q)}var nu=class q{constructor($,w){this.logger=$,this.members=w||[]}call($,w){for(let Z of this.members)if(Z)try{Z($,w)}catch(G){Q.logAction(this.logger,Q.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+G+"; stack = "+G.stack)}}push(...$){this.members.push(...$)}createPromise(){return new Promise(($,w)=>{this.push((Z,G)=>{Z?w(Z):$(G)})})}resolveAll($){this.call(null,$)}rejectAll($){this.call($)}static create($,w){let Z=new q($,w);return Object.assign((G,X)=>Z.call(G,X),{push:(G)=>Z.push(G),createPromise:()=>Z.createPromise(),resolveAll:(G)=>Z.resolveAll(G),rejectAll:(G)=>Z.rejectAll(G)})}},P8=nu,p$=((q)=>{return q.Get="get",q.Delete="delete",q.Post="post",q.Put="put",q.Patch="patch",q})(p$||{}),U0=p$,v$=((q)=>{return q[q.Success=200]="Success",q[q.NoContent=204]="NoContent",q[q.BadRequest=400]="BadRequest",q[q.Unauthorized=401]="Unauthorized",q[q.Forbidden=403]="Forbidden",q[q.RequestTimeout=408]="RequestTimeout",q[q.InternalServerError=500]="InternalServerError",q})(v$||{});function yu(q){return q>=200&&q<400}var xq=v$,C8=Math.pow(2,17);function iu(){return("000000"+Math.floor(Math.random()*10000000000000000)).slice(-16)}function gu(q){return!!q.connection}function x$(q){if(!b8(q))return new D(w0(q),q.code||40170,q.statusCode||401);if(!q.code)if(q.statusCode===403)q.code=40300;else q.code=40170,q.statusCode=401;return q}var pu=(q,$)=>{let w=B.BufferUtils,Z=w.utf8Encode(q),G=w.utf8Encode($),X=w.hmacSha256(Z,G);return w.base64Encode(X)};function d$(q){if(!q)return"";if(typeof q=="string")q=JSON.parse(q);let $=Object.create(null),w=l1(q,!0);if(!w)return"";w.sort();for(let Z=0;Z<w.length;Z++)$[w[Z]]=q[w[Z]].sort();return JSON.stringify($)}function t$(q,$){if(q.authCallback)Q.logAction($,Q.LOG_MINOR,"Auth()","using token auth with authCallback");else if(q.authUrl)Q.logAction($,Q.LOG_MINOR,"Auth()","using token auth with authUrl");else if(q.key)Q.logAction($,Q.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(q.tokenDetails)Q.logAction($,Q.LOG_MINOR,"Auth()","using token auth with supplied token only");else throw Q.logAction($,Q.LOG_ERROR,"Auth()","authOptions must include valid authentication parameters"),Error("authOptions must include valid authentication parameters")}function vu(q){return"useTokenAuth"in q&&!q.useTokenAuth}function f$(q){return q.useTokenAuth||!vu(q)&&(q.authCallback||q.authUrl||q.token||q.tokenDetails)}function xu(q){return!q.key&&!q.authCallback&&!q.authUrl}var du=0;function tu(){return du++}var fu=class{constructor(q,$){if(this.authOptions={},this.client=q,this.tokenParams=$.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,f$($)){if(xu($))Q.logAction(this.logger,Q.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help");this._saveTokenOptions($.defaultTokenParams,$),t$(this.authOptions,this.logger)}else{if(!$.key)throw Q.logAction(this.logger,Q.LOG_ERROR,"Auth()","No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)"),new D("No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)",40160,401);Q.logAction(this.logger,Q.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions($)}}get logger(){return this.client.logger}async authorize(q,$){if($&&$.key&&this.authOptions.key!==$.key)throw new D("Unable to update auth options with incompatible key",40102,401);try{let w=await this._forceNewToken(q!=null?q:null,$!=null?$:null);if(gu(this.client))return new Promise((Z,G)=>{this.client.connection.connectionManager.onAuthUpdated(w,(X,U)=>X?G(X):Z(U))});else return w}catch(w){if(this.client.connection&&w.statusCode===xq.Forbidden)this.client.connection.connectionManager.actOnErrorFromAuthorize(w);throw w}}async _forceNewToken(q,$){this.tokenDetails=null,this._saveTokenOptions(q,$),t$(this.authOptions,this.logger);try{return this._ensureValidAuthCredentials(!0)}finally{delete this.tokenParams.timestamp,delete this.authOptions.queryTime}}async requestToken(q,$){let w=$||this.authOptions,Z=q||B1(this.tokenParams),G,X=this.client;if(w.authCallback)Q.logAction(this.logger,Q.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),G=w.authCallback;else if(w.authUrl)Q.logAction(this.logger,Q.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),G=(O,F)=>{let z=n({accept:"application/json, text/plain"},w.authHeaders),I=w.authMethod&&w.authMethod.toLowerCase()==="post",j,A=w.authUrl.indexOf("?");if(A>-1){if(j=yq(w.authUrl.slice(A)),w.authUrl=w.authUrl.slice(0,A),!I)w.authParams=n(j,w.authParams)}let M=n({},w.authParams||{},O),c=(T)=>{var x,t;let l=(x=T.body)!=null?x:null,D0=null;if(T.error)Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+w0(T.error));else{let B0=(t=T.headers["content-type"])!=null?t:null;if(Array.isArray(B0))D0=B0.join(", ");else D0=B0;Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+D0+"; body: "+Y$(l))}if(T.error){F(T.error,null);return}if(T.unpacked){F(null,l);return}if(B.BufferUtils.isBuffer(l))l=l.toString();if(!D0){F(new D("authUrl response is missing a content-type header",40170,401),null);return}let y=D0.indexOf("application/json")>-1,R0=D0.indexOf("text/plain")>-1||D0.indexOf("application/jwt")>-1;if(!y&&!R0){F(new D("authUrl responded with unacceptable content-type "+D0+", should be either text/plain, application/jwt or application/json",40170,401),null);return}if(y){if(l.length>C8){F(new D("authUrl response exceeded max permitted length",40170,401),null);return}try{l=JSON.parse(l)}catch(B0){F(new D("Unexpected error processing authURL response; err = "+B0.message,40170,401),null);return}}F(null,l,D0)};if(Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+w.authUrl+"; Params: "+JSON.stringify(M)+"; method: "+(I?"POST":"GET")),I){let T=z||{};T["content-type"]="application/x-www-form-urlencoded";let x=r1(M).slice(1);j0(this.client.http.doUri(U0.Post,w.authUrl,T,x,j),(t,l)=>t?c(t):c(l))}else j0(this.client.http.doUri(U0.Get,w.authUrl,z||{},null,M),(T,x)=>T?c(T):c(x))};else if(w.key)Q.logAction(this.logger,Q.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),G=(O,F)=>{j0(this.createTokenRequest(O,w),(z,I)=>F(z,I!=null?I:null))};else throw Q.logAction(this.logger,Q.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),new D("Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)",40171,403);if("capability"in Z)Z.capability=d$(Z.capability);let U=(O,F)=>{let z=O.keyName,I="/keys/"+z+"/requestToken",j=function(M){return X.baseUri(M)+I},A=k.defaultPostHeaders(this.client.options,{format:"json"});if(w.requestHeaders)n(A,w.requestHeaders);Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+I+"; Token params: "+JSON.stringify(O)),j0(this.client.http.do(U0.Post,j,A,JSON.stringify(O),null),(M,c)=>M?F(M):F(c.error,c.body,c.unpacked))};return new Promise((O,F)=>{let z=!1,I=this.client.options.timeouts.realtimeRequestTimeout,j=setTimeout(()=>{z=!0;let A="Token request callback timed out after "+I/1000+" seconds";Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()",A),F(new D(A,40170,401))},I);G(Z,(A,M,c)=>{if(z)return;if(clearTimeout(j),A){Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+w0(A)),F(x$(A));return}if(typeof M==="string"){if(M.length===0)F(new D("Token string is empty",40170,401));else if(M.length>C8)F(new D("Token string exceeded max permitted length (was "+M.length+" bytes)",40170,401));else if(M==="undefined"||M==="null")F(new D("Token string was literal null/undefined",40170,401));else if(M[0]==="{"&&!(c&&c.indexOf("application/jwt")>-1))F(new D("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401));else O({token:M});return}if(typeof M!=="object"||M===null){let x="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof M;Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()",x),F(new D(x,40170,401));return}let T=JSON.stringify(M).length;if(T>C8&&!w.suppressMaxLengthCheck){F(new D("Token request/details object exceeded max permitted stringified size (was "+T+" bytes)",40170,401));return}if("issued"in M){O(M);return}if(!("keyName"in M)){Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()","Expected token request callback to call back with a token string, token request object, or token details object"),F(new D("Expected token request callback to call back with a token string, token request object, or token details object",40170,401));return}U(M,(x,t,l)=>{if(x){Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+w0(x)),F(x$(x));return}if(!l)t=JSON.parse(t);Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getToken()","token received"),O(t)})})})}async createTokenRequest(q,$){$=$||this.authOptions,q=q||B1(this.tokenParams);let w=$.key;if(!w)throw new D("No key specified",40101,403);let Z=w.split(":"),G=Z[0],X=Z[1];if(!X)throw new D("Invalid key specified",40101,403);if(q.clientId==="")throw new D("clientId can’t be an empty string",40012,400);if("capability"in q)q.capability=d$(q.capability);let U=n({keyName:G},q),O=q.clientId||"",F=q.ttl||"",z=q.capability||"";if(!U.timestamp)U.timestamp=await this._getTimestamp($&&$.queryTime);let I=U.nonce||(U.nonce=iu()),j=U.timestamp,A=U.keyName+`
`+F+`
`+z+`
`+O+`
`+j+`
`+I+`
`;return U.mac=U.mac||pu(A,X),Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),U}async getAuthParams(){if(this.method=="basic")return{key:this.key};else{let q=await this._ensureValidAuthCredentials(!1);if(!q)throw Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{access_token:q.token}}}async getAuthHeaders(){if(this.method=="basic")return{authorization:"Basic "+this.basicKey};else{let q=await this._ensureValidAuthCredentials(!1);if(!q)throw Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{authorization:"Bearer "+gq(q.token)}}}_saveBasicOptions(q){if(this.method="basic",this.key=q.key,this.basicKey=gq(q.key),this.authOptions=q||{},"clientId"in q)this._userSetClientId(q.clientId)}_saveTokenOptions(q,$){if(this.method="token",q)this.tokenParams=q;if($){if($.token)$.tokenDetails=typeof $.token==="string"?{token:$.token}:$.token;if($.tokenDetails)this.tokenDetails=$.tokenDetails;if("clientId"in $)this._userSetClientId($.clientId);this.authOptions=$}}async _ensureValidAuthCredentials(q){let $=this.tokenDetails;if($){if(this._tokenClientIdMismatch($.clientId))throw new D("Mismatch between clientId in token ("+$.clientId+") and current clientId ("+this.clientId+")",40102,403);if(!this.client.isTimeOffsetSet()||!$.expires||$.expires>=this.client.getTimestampUsingOffset())return Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+$.expires),$;Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}let w=(this.waitingForTokenRequest||(this.waitingForTokenRequest=P8.create(this.logger))).createPromise();if(this.currentTokenRequestId!==null&&!q)return w;let Z=this.currentTokenRequestId=tu(),G,X=null;try{G=await this.requestToken(this.tokenParams,this.authOptions)}catch(O){X=O}if(this.currentTokenRequestId>Z)return Q.logAction(this.logger,Q.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one"),w;this.currentTokenRequestId=null;let U=this.waitingForTokenRequest;if(this.waitingForTokenRequest=null,X)return U==null||U.rejectAll(X),w;return U==null||U.resolveAll(this.tokenDetails=G),w}_userSetClientId(q){if(!(typeof q==="string"||q===null))throw new D("clientId must be either a string or null",40012,400);else if(q==="*")throw new D('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);else{let $=this._uncheckedSetClientId(q);if($)throw $}}_uncheckedSetClientId(q){if(this._tokenClientIdMismatch(q)){let $="Unexpected clientId mismatch: client has "+this.clientId+", requested "+q,w=new D($,40102,401);return Q.logAction(this.logger,Q.LOG_ERROR,"Auth._uncheckedSetClientId()",$),w}else return this.clientId=this.tokenParams.clientId=q,null}_tokenClientIdMismatch(q){return!!(this.clientId&&this.clientId!=="*"&&q&&q!=="*"&&this.clientId!==q)}static isTokenErr(q){return q.code&&q.code>=40140&&q.code<40150}revokeTokens(q,$){return this.client.rest.revokeTokens(q,$)}async _getTimestamp(q){return this.client.getTimestamp(q||!!this.authOptions.queryTime)}},d0=fu;function k8(q){let $=[];if(q)for(let w in q)$.push(w+"="+q[w]);return $.join("&")}function I1(q,$){return q+($?"?":"")+k8($)}function mu(q,$,w,Z,G){if(q.error)Q.logActionNoStrip(G,Q.LOG_MICRO,"Http."+$+"()","Received Error; "+I1(w,Z)+"; Error: "+w0(q.error));else Q.logActionNoStrip(G,Q.LOG_MICRO,"Http."+$+"()","Received; "+I1(w,Z)+"; Headers: "+k8(q.headers)+"; StatusCode: "+q.statusCode+"; Body"+(B.BufferUtils.isBuffer(q.body)?" (Base64): "+B.BufferUtils.base64Encode(q.body):": "+q.body))}function ou(q,$,w,Z,G){if(G.shouldLog(Q.LOG_MICRO))Q.logActionNoStrip(G,Q.LOG_MICRO,"Http."+q+"()","Sending; "+I1($,Z)+"; Body"+(B.BufferUtils.isBuffer(w)?" (Base64): "+B.BufferUtils.base64Encode(w):": "+w))}var n8=class{constructor(q){this.client=q,this.platformHttp=new B.Http(q),this.checkConnectivity=this.platformHttp.checkConnectivity?()=>this.platformHttp.checkConnectivity():void 0}get logger(){var q,$;return($=(q=this.client)==null?void 0:q.logger)!=null?$:Q.defaultLogger}get supportsAuthHeaders(){return this.platformHttp.supportsAuthHeaders}get supportsLinkHeaders(){return this.platformHttp.supportsLinkHeaders}_getHosts(q){let $=q.connection,w=$&&$.connectionManager.host;if(w)return[w].concat(k.getFallbackHosts(q.options));return k.getHosts(q.options)}async do(q,$,w,Z,G){try{let X=this.client;if(!X)return{error:new D("http.do called without client",50000,500)};let U=typeof $==="function"?$:function(j){return X.baseUri(j)+$},O=X._currentFallback;if(O)if(O.validUntil>Date.now()){let j=await this.doUri(q,U(O.host),w,Z,G);if(j.error&&this.platformHttp.shouldFallback(j.error))return X._currentFallback=null,this.do(q,$,w,Z,G);return j}else X._currentFallback=null;let F=this._getHosts(X);if(F.length===1)return this.doUri(q,U(F[0]),w,Z,G);let z=null,I=async(j,A)=>{let M=j.shift();z=z!=null?z:new Date;let c=await this.doUri(q,U(M),w,Z,G);if(c.error&&this.platformHttp.shouldFallback(c.error)&&j.length){if(Date.now()-z.getTime()>X.options.timeouts.httpMaxRetryDuration)return{error:new D(`Timeout for trying fallback hosts retries. Total elapsed time exceeded the ${X.options.timeouts.httpMaxRetryDuration}ms limit`,50003,500)};return I(j,!0)}if(A)X._currentFallback={host:M,validUntil:Date.now()+X.options.timeouts.fallbackRetryTimeout};return c};return I(F)}catch(X){return{error:new D(`Unexpected error in Http.do: ${w0(X)}`,500,50000)}}}async doUri(q,$,w,Z,G){try{ou(q,$,Z,G,this.logger);let X=await this.platformHttp.doUri(q,$,w,Z,G);if(this.logger.shouldLog(Q.LOG_MICRO))mu(X,q,$,G,this.logger);return X}catch(X){return{error:new D(`Unexpected error in Http.doUri: ${w0(X)}`,500,50000)}}}};function lu(q,$,w,Z){try{w.apply($,Z)}catch(G){Q.logAction(q,Q.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+G+"; stack = "+(G&&G.stack))}}function y8(q,$,w){let Z,G,X;for(let U=0;U<q.length;U++){if(Z=q[U],w)Z=Z[w];if(Array.isArray(Z)){while((G=Z.indexOf($))!==-1)Z.splice(G,1);if(w&&Z.length===0)delete q[U][w]}else if(Y1(Z)){for(X in Z)if(Object.prototype.hasOwnProperty.call(Z,X)&&Array.isArray(Z[X]))y8([Z],$,X)}}}var ru=class{constructor(q){this.logger=q,this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null)}on(...q){if(q.length===1){let $=q[0];if(typeof $==="function")this.any.push($);else throw Error("EventListener.on(): Invalid arguments: "+B.Config.inspect(q))}if(q.length===2){let[$,w]=q;if(typeof w!=="function")throw Error("EventListener.on(): Invalid arguments: "+B.Config.inspect(q));if(c0($))this.any.push(w);else if(Array.isArray($))$.forEach((Z)=>{this.on(Z,w)});else{if(typeof $!=="string")throw Error("EventListener.on(): Invalid arguments: "+B.Config.inspect(q));(this.events[$]||(this.events[$]=[])).push(w)}}}off(...q){if(q.length==0||c0(q[0])&&c0(q[1])){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null);return}let[$,w]=q,Z=null,G=null;if(q.length===1||!w)if(typeof $==="function")Z=$;else G=$;else{if(typeof w!=="function")throw Error("EventEmitter.off(): invalid arguments:"+B.Config.inspect(q));[G,Z]=[$,w]}if(Z&&c0(G)){y8([this.any,this.events,this.anyOnce,this.eventsOnce],Z);return}if(Array.isArray(G)){G.forEach((X)=>{this.off(X,Z)});return}if(typeof G!=="string")throw Error("EventEmitter.off(): invalid arguments:"+B.Config.inspect(q));if(Z)y8([this.events,this.eventsOnce],Z,G);else delete this.events[G],delete this.eventsOnce[G]}listeners(q){if(q){let $=this.events[q]||[];if(this.eventsOnce[q])Array.prototype.push.apply($,this.eventsOnce[q]);return $.length?$:null}return this.any.length?this.any:null}emit(q,...$){let w={event:q},Z=[];if(this.anyOnce.length)Array.prototype.push.apply(Z,this.anyOnce),this.anyOnce=[];if(this.any.length)Array.prototype.push.apply(Z,this.any);let G=this.eventsOnce[q];if(G)Array.prototype.push.apply(Z,G),delete this.eventsOnce[q];let X=this.events[q];if(X)Array.prototype.push.apply(Z,X);Z.forEach((U)=>{lu(this.logger,w,U,$)})}once(...q){let $=q.length;if($===0||$===1&&typeof q[0]!=="function"){let G=q[0];return new Promise((X)=>{this.once(G,X)})}let[w,Z]=q;if(q.length===1&&typeof w==="function")this.anyOnce.push(w);else if(c0(w)){if(typeof Z!=="function")throw Error("EventEmitter.once(): Invalid arguments:"+B.Config.inspect(q));this.anyOnce.push(Z)}else if(Array.isArray(w)){let G=this,X=function(){let U=Array.prototype.slice.call(arguments);if(w.forEach(function(O){G.off(O,X)}),typeof Z!=="function")throw Error("EventEmitter.once(): Invalid arguments:"+B.Config.inspect(q));Z.apply(this,U)};w.forEach(function(U){G.on(U,X)})}else{if(typeof w!=="string")throw Error("EventEmitter.once(): Invalid arguments:"+B.Config.inspect(q));let G=this.eventsOnce[w]||(this.eventsOnce[w]=[]);if(Z){if(typeof Z!=="function")throw Error("EventEmitter.once(): Invalid arguments:"+B.Config.inspect(q));G.push(Z)}}}async whenState(q,$){if(typeof q!=="string"||typeof $!=="string")throw Error("whenState requires a valid state String argument");if(q===$)return null;else return this.once(q)}},V0=ru,C={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17,ACTIVATE:18,OBJECT:19,OBJECT_SYNC:20,ANNOTATION:21},m$=[];Object.keys(C).forEach(function(q){m$[C[q]]=q});var A0={HAS_PRESENCE:1,HAS_BACKLOG:2,RESUMED:4,TRANSIENT:16,ATTACH_RESUME:32,HAS_OBJECTS:128,PRESENCE:65536,PUBLISH:131072,SUBSCRIBE:262144,PRESENCE_SUBSCRIBE:524288,ANNOTATION_PUBLISH:2097152,ANNOTATION_SUBSCRIBE:4194304,OBJECT_SUBSCRIBE:16777216,OBJECT_PUBLISH:33554432},au=Object.keys(A0);A0.MODE_ALL=A0.PRESENCE|A0.PUBLISH|A0.SUBSCRIBE|A0.PRESENCE_SUBSCRIBE|A0.ANNOTATION_PUBLISH|A0.ANNOTATION_SUBSCRIBE|A0.OBJECT_SUBSCRIBE|A0.OBJECT_PUBLISH;var o$=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE","ANNOTATION_PUBLISH","ANNOTATION_SUBSCRIBE","OBJECT_SUBSCRIBE","OBJECT_PUBLISH"];function su(q){if(!q||!q.channelOptions)return{channelOptions:q,plugins:{},baseEncodedPreviousPayload:void 0};return q}function l$(q,$,w){if(w&&w.cipher){if(!q)h0("Crypto");let Z=q.getCipher(w.cipher,$);return{cipher:Z.cipherParams,channelCipher:Z.cipher}}return w!=null?w:{}}async function eu(q,$){let{data:w,encoding:Z}=await r$(q.data,q.encoding,$);return q.data=w,q.encoding=Z,q}async function r$(q,$,w){let Z=w.channelCipher,G=q,X=$?$+"/":"";if(!B.BufferUtils.isBuffer(G))G=B.BufferUtils.utf8Encode(String(G)),X=X+"utf-8/";let U=await Z.encrypt(G);return X=X+"cipher+"+Z.algorithm,{data:U,encoding:X}}async function i8(q,$){let{data:w,encoding:Z}=a$(q.data,q.encoding);if(q.data=w,q.encoding=Z,$!=null&&$.cipher)return eu(q,$);else return q}function a$(q,$){if(typeof q=="string"||B.BufferUtils.isBuffer(q)||q===null||q===void 0)return{data:q,encoding:$};if(Y1(q)||Array.isArray(q))return{data:JSON.stringify(q),encoding:$?$+"/json":"json"};throw new D("Data type is unsupported",40013,400)}async function g8(q,$){let{data:w,encoding:Z,error:G}=await s$(q.data,q.encoding,$);if(q.data=w,q.encoding=Z,G)throw G}async function s$(q,$,w){let Z=su(w),G=q,X=q,U=$,O;if($){let F=$.split("/"),z,I=F.length,j="";try{while((z=I)>0){let A=F[--I].match(/([-\w]+)(\+([\w-]+))?/);if(!A)break;switch(j=A[1],j){case"base64":if(X=B.BufferUtils.base64Decode(String(X)),z==F.length)G=X;continue;case"utf-8":X=B.BufferUtils.utf8Decode(X);continue;case"json":X=JSON.parse(X);continue;case"cipher":if(Z.channelOptions!=null&&Z.channelOptions.cipher&&Z.channelOptions.channelCipher){let M=A[3],c=Z.channelOptions.channelCipher;if(M!=c.algorithm)throw Error("Unable to decrypt message with given cipher; incompatible cipher params");X=await c.decrypt(X);continue}else throw Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!Z.plugins||!Z.plugins.vcdiff)throw new D("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if(typeof Uint8Array>"u")throw new D("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{let M=Z.baseEncodedPreviousPayload;if(typeof M==="string")M=B.BufferUtils.utf8Encode(M);let c=B.BufferUtils.toBuffer(M);X=B.BufferUtils.toBuffer(X),X=B.BufferUtils.arrayBufferViewToBuffer(Z.plugins.vcdiff.decode(X,c)),G=X}catch(M){throw new D("Vcdiff delta decode failed with "+M,40018,400)}continue;default:throw Error("Unknown encoding")}}}catch(A){let M=A;O=new D(`Error processing the ${j} encoding, decoder returned ‘${M.message}’`,M.code||40013,400)}finally{U=z<=0?null:F.slice(0,z).join("/")}}if(O)return{error:O,data:X,encoding:U};return Z.baseEncodedPreviousPayload=G,{data:X,encoding:U}}function p8(...q){let $=q.length>0?"json":"msgpack",{data:w,encoding:Z}=e$(this.data,this.encoding,$);return Object.assign({},this,{encoding:Z,data:w})}function e$(q,$,w){if(!q||!B.BufferUtils.isBuffer(q))return{data:q,encoding:$};if(w==="msgpack")return{data:B.BufferUtils.toBuffer(q),encoding:$};return{data:B.BufferUtils.base64Encode(q),encoding:$?$+"/base64":"base64"}}var dq={encryptData:r$,encodeData:a$,encodeDataForWire:e$,decodeData:s$};function tq(q){let{id:$,connectionId:w,timestamp:Z}=q,G;switch(q.action){case C.MESSAGE:{G=q.messages;break}case C.PRESENCE:case C.SYNC:G=q.presence;break;case C.ANNOTATION:G=q.annotations;break;case C.OBJECT:case C.OBJECT_SYNC:G=q.state;break;default:throw new D("Unexpected action "+q.action,40000,400)}for(let X=0;X<G.length;X++){let U=G[X];if(!U.connectionId)U.connectionId=w;if(!U.timestamp)U.timestamp=Z;if($&&!U.id)U.id=$+":"+X}}function j1(q,$){let w="["+$;for(let Z in q)if(Z==="data"){if(typeof q.data=="string")w+="; data="+q.data;else if(B.BufferUtils.isBuffer(q.data))w+="; data (buffer)="+B.BufferUtils.base64Encode(q.data);else if(typeof q.data<"u")w+="; data (json)="+JSON.stringify(q.data)}else if(Z&&(Z==="extras"||Z==="operation"))w+="; "+Z+"="+JSON.stringify(q[Z]);else if(Z==="version")w+="; version="+JSON.stringify(q[Z]);else if(Z==="annotations")w+="; annotations="+JSON.stringify(q[Z]);else if(q[Z]!==void 0)w+="; "+Z+"="+q[Z];return w+="]",w}var A1=class{},q7=class{constructor(q){this.Platform=B,this.ErrorInfo=D,this.Logger=Q,this.Defaults=k,this.Utils=z0,this.EventEmitter=V0,this.MessageEncoding=dq;var $,w,Z,G,X,U,O,F,z,I;this._additionalHTTPRequestImplementations=($=q.plugins)!=null?$:null,this.logger=new Q,this.logger.setLog(q.logLevel,q.logHandler),Q.logAction(this.logger,Q.LOG_MICRO,"BaseClient()","initialized with clientOptions "+B.Config.inspect(q)),this._MsgPack=(Z=(w=q.plugins)==null?void 0:w.MsgPack)!=null?Z:null;let j=this.options=k.normaliseOptions(q,this._MsgPack,this.logger);if(j.key){let A=j.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!A)throw Q.logAction(this.logger,Q.LOG_ERROR,"BaseClient()","invalid key parameter"),new D("invalid key parameter",40400,404);j.keyName=A[1],j.keySecret=A[2]}if("clientId"in j){if(!(typeof j.clientId==="string"||j.clientId===null))throw new D("clientId must be either a string or null",40012,400);else if(j.clientId==="*")throw new D('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}Q.logAction(this.logger,Q.LOG_MINOR,"BaseClient()","started; version = "+k.version),this._currentFallback=null,this.serverTimeOffset=null,this.http=new n8(this),this.auth=new d0(this,j),this._rest=((G=q.plugins)==null?void 0:G.Rest)?new q.plugins.Rest(this):null,this._Crypto=(U=(X=q.plugins)==null?void 0:X.Crypto)!=null?U:null,this.__FilteredSubscriptions=(F=(O=q.plugins)==null?void 0:O.MessageInteractions)!=null?F:null,this._Annotations=(I=(z=q.plugins)==null?void 0:z.Annotations)!=null?I:null}get rest(){if(!this._rest)h0("Rest");return this._rest}get _FilteredSubscriptions(){if(!this.__FilteredSubscriptions)h0("MessageInteractions");return this.__FilteredSubscriptions}get channels(){return this.rest.channels}get push(){return this.rest.push}device(){var q;if(!((q=this.options.plugins)==null?void 0:q.Push)||!this.push.LocalDevice)h0("Push");if(!this._device)this._device=this.push.LocalDevice.load(this);return this._device}baseUri(q){return k.getHttpScheme(this.options)+q+":"+k.getPort(this.options,!1)}async stats(q){return this.rest.stats(q)}async time(q){return this.rest.time(q)}async request(q,$,w,Z,G,X){return this.rest.request(q,$,w,Z,G,X)}batchPublish(q){return this.rest.batchPublish(q)}batchPresence(q){return this.rest.batchPresence(q)}setLog(q){this.logger.setLog(q.level,q.handler)}async getTimestamp(q){if(!this.isTimeOffsetSet()&&q)return this.time();return this.getTimestampUsingOffset()}getTimestampUsingOffset(){return Date.now()+(this.serverTimeOffset||0)}isTimeOffsetSet(){return this.serverTimeOffset!==null}};q7.Platform=B;var $7=q7,q4=class q{toJSON(){var $,w,Z;return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:($=this.push)==null?void 0:$.recipient,state:(w=this.push)==null?void 0:w.state,error:(Z=this.push)==null?void 0:Z.error}}}toString(){var $,w,Z,G;let X="[DeviceDetails";if(this.id)X+="; id="+this.id;if(this.platform)X+="; platform="+this.platform;if(this.formFactor)X+="; formFactor="+this.formFactor;if(this.clientId)X+="; clientId="+this.clientId;if(this.metadata)X+="; metadata="+this.metadata;if(this.deviceIdentityToken)X+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken);if(($=this.push)==null?void 0:$.recipient)X+="; push.recipient="+JSON.stringify(this.push.recipient);if((w=this.push)==null?void 0:w.state)X+="; push.state="+this.push.state;if((Z=this.push)==null?void 0:Z.error)X+="; push.error="+JSON.stringify(this.push.error);if((G=this.push)==null?void 0:G.metadata)X+="; push.metadata="+this.push.metadata;return X+="]",X}static toRequestBody($,w,Z){return P0($,w,Z)}static fromResponseBody($,w,Z){if(Z)$=F0($,w,Z);if(Array.isArray($))return q.fromValuesArray($);else return q.fromValues($)}static fromValues($){return $.error=$.error&&D.fromValues($.error),Object.assign(new q,$)}static fromLocalDevice($){return Object.assign(new q,$)}static fromValuesArray($){let w=$.length,Z=Array(w);for(let G=0;G<w;G++)Z[G]=q.fromValues($[G]);return Z}},M1=q4;async function w7(q,$,w,Z){if(q.http.supportsAuthHeaders){let G=await q.auth.getAuthHeaders();return Z(n(G,$),w)}else{let G=await q.auth.getAuthParams();return Z($,n(G,w))}}function $4(q,$,w){if(q.err&&!q.body)return{err:q.err};if(q.statusCode===xq.NoContent)return E(_({},q),{body:[],unpacked:!0});let Z=q.body;if(!q.unpacked)try{Z=F0(Z,$,w)}catch(O){if(b8(O))return{err:O};else return{err:new o(w0(O),null)}}if(!Z)return{err:new o("unenvelope(): Response body is missing",null)};let{statusCode:G,response:X,headers:U}=Z;if(G===void 0)return E(_({},q),{body:Z,unpacked:!0});if(G<200||G>=300){let O=X&&X.error||q.err;if(!O)O=Error("Error in unenveloping "+Z),O.statusCode=G;return{err:O,body:X,headers:U,unpacked:!0,statusCode:G}}return{err:q.err,body:X,headers:U,unpacked:!0,statusCode:G}}function w4(q,$,w,Z,G){if(q.err)Q.logAction(G,Q.LOG_MICRO,"Resource."+$+"()","Received Error; "+I1(w,Z)+"; Error: "+w0(q.err));else Q.logAction(G,Q.LOG_MICRO,"Resource."+$+"()","Received; "+I1(w,Z)+"; Headers: "+k8(q.headers)+"; StatusCode: "+q.statusCode+"; Body: "+(B.BufferUtils.isBuffer(q.body)?" (Base64): "+B.BufferUtils.base64Encode(q.body):": "+B.Config.inspect(q.body)))}var u4=class q{static async get($,w,Z,G,X,U){return q.do(U0.Get,$,w,null,Z,G,X,U!=null?U:!1)}static async delete($,w,Z,G,X,U){return q.do(U0.Delete,$,w,null,Z,G,X,U)}static async post($,w,Z,G,X,U,O){return q.do(U0.Post,$,w,Z,G,X,U,O)}static async patch($,w,Z,G,X,U,O){return q.do(U0.Patch,$,w,Z,G,X,U,O)}static async put($,w,Z,G,X,U,O){return q.do(U0.Put,$,w,Z,G,X,U,O)}static async do($,w,Z,G,X,U,O,F){if(O)(U=U||{}).envelope=O;let z=w.logger;async function I(A,M){var c;if(z.shouldLog(Q.LOG_MICRO)){let x=G;if(((c=A["content-type"])==null?void 0:c.indexOf("msgpack"))>0)try{if(!w._MsgPack)h0("MsgPack");x=w._MsgPack.decode(G)}catch(t){Q.logAction(z,Q.LOG_MICRO,"Resource."+$+"()","Sending MsgPack Decoding Error: "+w0(t))}Q.logAction(z,Q.LOG_MICRO,"Resource."+$+"()","Sending; "+I1(Z,M)+"; Body: "+x)}let T=await w.http.do($,Z,A,G,M);if(T.error&&d0.isTokenErr(T.error))return await w.auth.authorize(null,null),w7(w,A,M,I);return{err:T.error,body:T.body,headers:T.headers,unpacked:T.unpacked,statusCode:T.statusCode}}let j=await w7(w,X,U,I);if(O)j=$4(j,w._MsgPack,O);if(z.shouldLog(Q.LOG_MICRO))w4(j,$,Z,U,z);if(F)if(j.err)throw j.err;else{let A=_({},j);return delete A.err,A}return j}},X0=u4;function W4(q){let $=q.match(/^\.\/(\w+)\?(.*)$/);return $&&$[2]&&yq($[2])}function Z4(q){if(typeof q=="string")q=q.split(",");let $={};for(let w=0;w<q.length;w++){let Z=q[w].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);if(Z){let G=W4(Z[1]);if(G)$[Z[2]]=G}}return $}function G4(q,$,w){return!(w&&($||typeof q.code==="number"))}var N4=class{constructor(q,$,w,Z,G,X){this.client=q,this.path=$,this.headers=w,this.envelope=Z!=null?Z:null,this.bodyHandler=G,this.useHttpPaginatedResponse=X||!1}get logger(){return this.client.logger}async get(q){let $=await X0.get(this.client,this.path,this.headers,q,this.envelope,!1);return this.handlePage($)}async delete(q){let $=await X0.delete(this.client,this.path,this.headers,q,this.envelope,!1);return this.handlePage($)}async post(q,$){let w=await X0.post(this.client,this.path,$,this.headers,q,this.envelope,!1);return this.handlePage(w)}async put(q,$){let w=await X0.put(this.client,this.path,$,this.headers,q,this.envelope,!1);return this.handlePage(w)}async patch(q,$){let w=await X0.patch(this.client,this.path,$,this.headers,q,this.envelope,!1);return this.handlePage(w)}async handlePage(q){if(q.err&&G4(q.err,q.body,this.useHttpPaginatedResponse))throw Q.logAction(this.logger,Q.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+w0(q.err)),q.err;let $,w,Z;try{$=q.statusCode==xq.NoContent?[]:await this.bodyHandler(q.body,q.headers||{},q.unpacked)}catch(G){throw q.err||G}if(q.headers&&(w=q.headers.Link||q.headers.link))Z=Z4(w);if(this.useHttpPaginatedResponse)return new J4(this,$,q.headers||{},q.statusCode,Z,q.err);else return new u7(this,$,Z)}},u7=class{constructor(q,$,w){this.resource=q,this.items=$,this._relParams=w}async first(){if(this.hasFirst())return this.get(this._relParams.first);throw new D("No link to the first page of results",40400,404)}async current(){if(this.hasCurrent())return this.get(this._relParams.current);throw new D("No link to the current page of results",40400,404)}async next(){if(this.hasNext())return this.get(this._relParams.next);return null}hasFirst(){return this._relParams!=null&&"first"in this._relParams}hasCurrent(){return this._relParams!=null&&"current"in this._relParams}hasNext(){return this._relParams!=null&&"next"in this._relParams}isLast(){return!this.hasNext()}async get(q){let $=this.resource,w=await X0.get($.client,$.path,$.headers,q,$.envelope,!1);return $.handlePage(w)}},J4=class extends u7{constructor(q,$,w,Z,G,X){super(q,$,G);this.statusCode=Z,this.success=Z<300&&Z>=200,this.headers=w,this.errorCode=X&&X.code,this.errorMessage=X&&X.message}toJSON(){return{items:this.items,statusCode:this.statusCode,success:this.success,headers:this.headers,errorCode:this.errorCode,errorMessage:this.errorMessage}}},k0=N4,W7=class q{toJSON(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}}toString(){let $="[PushChannelSubscription";if(this.channel)$+="; channel="+this.channel;if(this.deviceId)$+="; deviceId="+this.deviceId;if(this.clientId)$+="; clientId="+this.clientId;return $+="]",$}static fromResponseBody($,w,Z){if(Z)$=F0($,w,Z);if(Array.isArray($))return q.fromValuesArray($);else return q.fromValues($)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){let w=$.length,Z=Array(w);for(let G=0;G<w;G++)Z[G]=q.fromValues($[G]);return Z}};W7.toRequestBody=P0;var X4=W7,fq=X4,Q4=class{constructor(q){var $;if(this.client=q,this.admin=new H4(q),B.Config.push&&(($=q.options.plugins)==null?void 0:$.Push))this.stateMachine=new q.options.plugins.Push.ActivationStateMachine(q),this.LocalDevice=q.options.plugins.Push.localDeviceFactory(M1)}async activate(q,$){await new Promise((w,Z)=>{var G;if(!((G=this.client.options.plugins)==null?void 0:G.Push)){Z(pq("Push"));return}if(!this.stateMachine){Z(new D("This platform is not supported as a target of push notifications",40000,400));return}if(this.stateMachine.activatedCallback){Z(new D("Activation already in progress",40000,400));return}this.stateMachine.activatedCallback=(X)=>{if(X){Z(X);return}w()},this.stateMachine.updateFailedCallback=$,this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledActivate(this.stateMachine,q))})}async deactivate(q){await new Promise(($,w)=>{var Z;if(!((Z=this.client.options.plugins)==null?void 0:Z.Push)){w(pq("Push"));return}if(!this.stateMachine){w(new D("This platform is not supported as a target of push notifications",40000,400));return}if(this.stateMachine.deactivatedCallback){w(new D("Deactivation already in progress",40000,400));return}this.stateMachine.deactivatedCallback=(G)=>{if(G){w(G);return}$()},this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledDeactivate(this.stateMachine,q))})}},H4=class{constructor(q){this.client=q,this.deviceRegistrations=new U4(q),this.channelSubscriptions=new K4(q)}async publish(q,$){let w=this.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=k.defaultPostHeaders(w.options),X={},U=n({recipient:q},$);if(n(G,w.options.headers),w.options.pushFullWait)n(X,{fullWait:"true"});let O=P0(U,w._MsgPack,Z);await X0.post(w,"/push/publish",O,G,X,null,!0)}},U4=class{constructor(q){this.client=q}async save(q){let $=this.client,w=M1.fromValues(q),Z=$.options.useBinaryProtocol?"msgpack":"json",G=k.defaultPostHeaders($.options),X={};if(n(G,$.options.headers),$.options.pushFullWait)n(X,{fullWait:"true"});let U=P0(w,$._MsgPack,Z),O=await X0.put($,"/push/deviceRegistrations/"+encodeURIComponent(q.id),U,G,X,null,!0);return M1.fromResponseBody(O.body,$._MsgPack,O.unpacked?void 0:Z)}async get(q){let $=this.client,w=$.options.useBinaryProtocol?"msgpack":"json",Z=k.defaultGetHeaders($.options),G=q.id||q;if(typeof G!=="string"||!G.length)throw new D("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",40000,400);n(Z,$.options.headers);let X=await X0.get($,"/push/deviceRegistrations/"+encodeURIComponent(G),Z,{},null,!0);return M1.fromResponseBody(X.body,$._MsgPack,X.unpacked?void 0:w)}async list(q){let $=this.client,w=$.options.useBinaryProtocol?"msgpack":"json",Z=this.client.http.supportsLinkHeaders?void 0:w,G=k.defaultGetHeaders($.options);return n(G,$.options.headers),new k0($,"/push/deviceRegistrations",G,Z,async function(X,U,O){return M1.fromResponseBody(X,$._MsgPack,O?void 0:w)}).get(q)}async remove(q){let $=this.client,w=k.defaultGetHeaders($.options),Z={},G=q.id||q;if(typeof G!=="string"||!G.length)throw new D("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",40000,400);if(n(w,$.options.headers),$.options.pushFullWait)n(Z,{fullWait:"true"});await X0.delete($,"/push/deviceRegistrations/"+encodeURIComponent(G),w,Z,null,!0)}async removeWhere(q){let $=this.client,w=$.options.useBinaryProtocol?"msgpack":"json",Z=k.defaultGetHeaders($.options,{format:w});if(n(Z,$.options.headers),$.options.pushFullWait)n(q,{fullWait:"true"});await X0.delete($,"/push/deviceRegistrations",Z,q,null,!0)}},K4=class q{constructor($){this.remove=q.prototype.removeWhere,this.client=$}async save($){let w=this.client,Z=fq.fromValues($),G=w.options.useBinaryProtocol?"msgpack":"json",X=k.defaultPostHeaders(w.options),U={};if(n(X,w.options.headers),w.options.pushFullWait)n(U,{fullWait:"true"});let O=P0(Z,w._MsgPack,G),F=await X0.post(w,"/push/channelSubscriptions",O,X,U,null,!0);return fq.fromResponseBody(F.body,w._MsgPack,F.unpacked?void 0:G)}async list($){let w=this.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=this.client.http.supportsLinkHeaders?void 0:Z,X=k.defaultGetHeaders(w.options);return n(X,w.options.headers),new k0(w,"/push/channelSubscriptions",X,G,async function(U,O,F){return fq.fromResponseBody(U,w._MsgPack,F?void 0:Z)}).get($)}async removeWhere($){let w=this.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=k.defaultGetHeaders(w.options,{format:Z});if(n(G,w.options.headers),w.options.pushFullWait)n($,{fullWait:"true"});await X0.delete(w,"/push/channelSubscriptions",G,$,null,!0)}async listChannels($){let w=this.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=this.client.http.supportsLinkHeaders?void 0:Z,X=k.defaultGetHeaders(w.options);if(n(X,w.options.headers),w.options.pushFullWait)n($,{fullWait:"true"});return new k0(w,"/push/channels",X,G,async function(U,O,F){let z=!F&&Z?F0(U,w._MsgPack,Z):U;for(let I=0;I<z.length;I++)z[I]=String(z[I]);return z}).get($)}},O4=Q4,Z7=["absent","present","enter","leave","update"];async function G7(q,$,w,Z){let G=l$($,q,Z!=null?Z:null);return a1.fromValues(w).decode(G,q)}async function V4(q,$,w,Z){return Promise.all(w.map(function(G){return G7(q,$,G,Z)}))}async function z4(q,$){return a1.fromValues(q).decode($.channelOptions,$.logger)}async function N7(q,$){return Promise.all(q.map(function(w){return z4(w,$)}))}var J7=class q extends A1{isSynthesized(){if(!this.id||!this.connectionId)return!0;return this.id.substring(this.connectionId.length,0)!==this.connectionId}parseId(){if(!this.id)throw Error("parseId(): Presence message does not contain an id");let $=this.id.split(":");return{connectionId:$[0],msgSerial:parseInt($[1],10),index:parseInt($[2],10)}}async encode($){let w=Object.assign(new a1,this,{action:Z7.indexOf(this.action||"present")});return i8(w,$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}static fromData($){if($ instanceof q)return $;return q.fromValues({data:$})}toString(){return j1(this,"PresenceMessage")}},a1=class q extends A1{toJSON(...$){return p8.call(this,...$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}async decode($,w){let Z=Object.assign(new J7,E(_({},this),{action:Z7[this.action]}));try{await g8(Z,$)}catch(G){Q.logAction(w,Q.LOG_ERROR,"WirePresenceMessage.decode()",w0(G))}return Z}toString(){return j1(this,"WirePresenceMessage")}},t0=J7,F4=class{constructor(q){this.channel=q}get logger(){return this.channel.logger}async get(q){Q.logAction(this.logger,Q.LOG_MICRO,"RestPresence.get()","channel = "+this.channel.name);let $=this.channel.client,w=$.options.useBinaryProtocol?"msgpack":"json",Z=this.channel.client.http.supportsLinkHeaders?void 0:w,G=k.defaultGetHeaders($.options);return n(G,$.options.headers),new k0($,this.channel.client.rest.presenceMixin.basePath(this),G,Z,async(X,U,O)=>{let F=O?X:F0(X,$._MsgPack,w);return N7(F,this.channel)}).get(q)}async history(q){return Q.logAction(this.logger,Q.LOG_MICRO,"RestPresence.history()","channel = "+this.channel.name),this.channel.client.rest.presenceMixin.history(this,q)}},h4=F4,X7=["message.create","message.update","message.delete","meta","message.summary"];function D4(q){return X7[q||0]||"unknown"}function B4(q){let $=0;if(q.name)$+=q.name.length;if(q.clientId)$+=q.clientId.length;if(q.extras)$+=JSON.stringify(q.extras).length;if(q.data)$+=I$(q.data);return $}async function Q7(q,$,w,Z){let G=l$($,q,Z!=null?Z:null);return s1.fromValues(w).decode(G,q)}async function Y4(q,$,w,Z){return Promise.all(w.map(function(G){return Q7(q,$,G,Z)}))}async function H7(q,$){return s1.fromValues(q).decode($.channelOptions,$.logger)}async function U7(q,$){return Promise.all(q.map(function(w){return H7(w,$)}))}async function K7(q,$){return Promise.all(q.map((w)=>w.encode($)))}var O7=P0;function v8(q){let $,w=0;for(let Z=0;Z<q.length;Z++)$=q[Z],w+=$.size||($.size=B4($));return w}var V7=class q extends A1{expandFields(){if(!this.version)this.version={};if(!this.version.serial&&this.serial)this.version.serial=this.serial;if(!this.version.timestamp&&this.timestamp)this.version.timestamp=this.timestamp;if(!this.annotations)this.annotations={summary:{}};else if(!this.annotations.summary)this.annotations.summary={};if(this.annotations&&this.annotations.summary){for(let[$,w]of Object.entries(this.annotations.summary))if($.endsWith(":distinct.v1")||$.endsWith(":unique.v1")||$.endsWith(":multiple.v1")){for(let[,Z]of Object.entries(w))if(!Z.clipped)Z.clipped=!1}else if($.endsWith(":flag.v1")){if(!w.clipped)w.clipped=!1}}}async encode($){let w=Object.assign(new s1,this,{action:X7.indexOf(this.action||"message.create")});return i8(w,$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}toString(){return j1(this,"Message")}},s1=class q extends A1{toJSON(...$){return p8.call(this,...$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}async decodeWithErr($,w){let Z=Object.assign(new V7,E(_({},this),{action:D4(this.action)})),G;try{await g8(Z,$)}catch(X){Q.logAction(w,Q.LOG_ERROR,"WireMessage.decode()",w0(X)),G=X}return Z.expandFields(),{decoded:Z,err:G}}async decode($,w){let{decoded:Z}=await this.decodeWithErr($,w);return Z}toString(){return j1(this,"WireMessage")}},f0=V7,I4=9;function j4(q){return q.every(function($){return!$.id})}var A4=class{constructor(q,$,w){this._annotations=null;var Z,G;if(Q.logAction(q.logger,Q.LOG_MINOR,"RestChannel()","started; name = "+$),this.name=$,this.client=q,this.presence=new h4(this),this.channelOptions=vq((Z=q._Crypto)!=null?Z:null,this.logger,w),(G=q.options.plugins)==null?void 0:G.Push)this._push=new q.options.plugins.Push.PushChannel(this);if(q._Annotations)this._annotations=new q._Annotations.RestAnnotations(this)}get annotations(){if(!this._annotations)h0("Annotations");return this._annotations}get push(){if(!this._push)h0("Push");return this._push}get logger(){return this.client.logger}setOptions(q){var $;this.channelOptions=vq(($=this.client._Crypto)!=null?$:null,this.logger,q)}async history(q){return Q.logAction(this.logger,Q.LOG_MICRO,"RestChannel.history()","channel = "+this.name),this.client.rest.channelMixin.history(this,q)}async publish(...q){let $=q[0],w=q[1],Z,G;if(typeof $==="string"||$===null)Z=[f0.fromValues({name:$,data:w})],G=q[2];else if(Y1($))Z=[f0.fromValues($)],G=q[1];else if(Array.isArray($))Z=f0.fromValuesArray($),G=q[1];else throw new D("The single-argument form of publish() expects a message object or an array of message objects",40013,400);if(!G)G={};let X=this.client,U=X.options,O=U.useBinaryProtocol?"msgpack":"json",F=X.options.idempotentRestPublishing,z=k.defaultPostHeaders(X.options);if(n(z,U.headers),F&&j4(Z)){let M=await j$(I4);Z.forEach(function(c,T){c.id=M+":"+T.toString()})}let I=await K7(Z,this.channelOptions),j=v8(I),A=U.maxMessageSize;if(j>A)throw new D(`Maximum size of messages that can be published at once exceeded (was ${j} bytes; limit is ${A} bytes)`,40009,400);await this._publish(O7(I,X._MsgPack,O),z,G)}async _publish(q,$,w){await X0.post(this.client,this.client.rest.channelMixin.basePath(this)+"/messages",q,$,w,null,!0)}async status(){return this.client.rest.channelMixin.status(this)}async getMessage(q){return Q.logAction(this.logger,Q.LOG_MICRO,"RestChannel.getMessage()","channel = "+this.name),this.client.rest.channelMixin.getMessage(this,q)}async updateMessage(q,$,w){return Q.logAction(this.logger,Q.LOG_MICRO,"RestChannel.updateMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!1},q,$,w)}async deleteMessage(q,$,w){return Q.logAction(this.logger,Q.LOG_MICRO,"RestChannel.deleteMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!0},q,$,w)}async getMessageVersions(q,$){return Q.logAction(this.logger,Q.LOG_MICRO,"RestChannel.getMessageVersions()","channel = "+this.name),this.client.rest.channelMixin.getMessageVersions(this,q,$)}},M4=A4,L4=class q{constructor($){this.entries=$&&$.entries||void 0,this.schema=$&&$.schema||void 0,this.appId=$&&$.appId||void 0,this.inProgress=$&&$.inProgress||void 0,this.unit=$&&$.unit||void 0,this.intervalId=$&&$.intervalId||void 0}static fromValues($){return new q($)}},R4=L4,z7=class{static basePath(q){return"/channels/"+encodeURIComponent(q.name)}static history(q,$){let w=q.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=q.client.http.supportsLinkHeaders?void 0:Z,X=k.defaultGetHeaders(w.options);return n(X,w.options.headers),new k0(w,this.basePath(q)+"/messages",X,G,async function(U,O,F){let z=F?U:F0(U,w._MsgPack,Z);return U7(z,q)}).get($)}static async status(q){let $=q.client.options.useBinaryProtocol?"msgpack":"json",w=k.defaultPostHeaders(q.client.options);return(await X0.get(q.client,this.basePath(q),w,{},$,!0)).body}static async getMessage(q,$){let w=typeof $==="string"?$:$.serial;if(!w)throw new D('This message lacks a serial. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let Z=q.client,G=Z.options.useBinaryProtocol?"msgpack":"json",X=k.defaultGetHeaders(Z.options);n(X,Z.options.headers);let{body:U,unpacked:O}=await X0.get(Z,this.basePath(q)+"/messages/"+encodeURIComponent(w),X,{},null,!0),F=O?U:F0(U,Z._MsgPack,G);return H7(F,q)}static async updateDeleteMessage(q,$,w,Z,G){if(!w.serial)throw new D('This message lacks a serial and cannot be updated. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let X=q.client,U=X.options.useBinaryProtocol?"msgpack":"json",O=k.defaultPostHeaders(X.options);n(O,X.options.headers);let F=null;if(w.data!==void 0)F=await f0.fromValues(w).encode(q.channelOptions);let z={serial:w.serial,operation:Z,name:w.name,data:F&&F.data,encoding:F&&F.encoding,extras:w.extras},I=O7(z,X._MsgPack,U),j=$.isDelete?X0.post:X0.patch,A=$.isDelete?"/delete":"";await j(X,this.basePath(q)+"/messages/"+encodeURIComponent(w.serial)+A,I,O,G||{},null,!0)}static getMessageVersions(q,$,w){let Z=typeof $==="string"?$:$.serial;if(!Z)throw new D('This message lacks a serial. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let G=q.client,X=G.options.useBinaryProtocol?"msgpack":"json",U=q.client.http.supportsLinkHeaders?void 0:X,O=k.defaultGetHeaders(G.options);return n(O,G.options.headers),new k0(G,this.basePath(q)+"/messages/"+encodeURIComponent(Z)+"/versions",O,U,async(F,z,I)=>{let j=I?F:F0(F,G._MsgPack,X);return U7(j,q)}).get(w||{})}},_4=class{static basePath(q){return z7.basePath(q.channel)+"/presence"}static async history(q,$){let w=q.channel.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=q.channel.client.http.supportsLinkHeaders?void 0:Z,X=k.defaultGetHeaders(w.options);return n(X,w.options.headers),new k0(w,this.basePath(q)+"/history",X,G,async(U,O,F)=>{let z=F?U:F0(U,w._MsgPack,Z);return N7(z,q.channel)}).get($)}},F7=class{constructor(q){this.channelMixin=z7,this.presenceMixin=_4,this.Resource=X0,this.PaginatedResource=k0,this.DeviceDetails=M1,this.PushChannelSubscription=fq,this.client=q,this.channels=new b4(this.client),this.push=new O4(this.client)}async stats(q){let $=k.defaultGetHeaders(this.client.options),w=this.client.options.useBinaryProtocol?"msgpack":"json",Z=this.client.http.supportsLinkHeaders?void 0:w;return n($,this.client.options.headers),new k0(this.client,"/stats",$,Z,async(G,X,U)=>{let O=U?G:F0(G,this.client._MsgPack,w);for(let F=0;F<O.length;F++)O[F]=R4.fromValues(O[F]);return O}).get(q)}async time(q){let $=k.defaultGetHeaders(this.client.options,{format:"json"});if(this.client.options.headers)n($,this.client.options.headers);let w=(O)=>{return this.client.baseUri(O)+"/time"},{error:Z,body:G,unpacked:X}=await this.client.http.do(U0.Get,w,$,null,q);if(Z)throw Z;if(!X)G=JSON.parse(G);let U=G[0];if(!U)throw new D("Internal error (unexpected result type from GET /time)",50000,500);return this.client.serverTimeOffset=U-Date.now(),U}async request(q,$,w,Z,G,X){var U;let[O,F,z]=(()=>{if(this.client.options.useBinaryProtocol){if(!this.client._MsgPack)h0("MsgPack");return[this.client._MsgPack.encode,this.client._MsgPack.decode,"msgpack"]}else return[JSON.stringify,JSON.parse,"json"]})(),I=this.client.http.supportsLinkHeaders?void 0:z;Z=Z||{};let j=q.toLowerCase(),A=j=="get"?k.defaultGetHeaders(this.client.options,{format:z,protocolVersion:w}):k.defaultPostHeaders(this.client.options,{format:z,protocolVersion:w});if(typeof G!=="string")G=(U=O(G))!=null?U:null;if(n(A,this.client.options.headers),X)n(A,X);let M=new k0(this.client,$,A,I,async function(c,T,x){return H$(x?c:F(c))},!0);if(!B.Http.methods.includes(j))throw new D("Unsupported method "+j,40500,405);if(B.Http.methodsWithBody.includes(j))return M[j](Z,G);else return M[j](Z)}async batchPublish(q){let $,w;if(Array.isArray(q))$=q,w=!1;else $=[q],w=!0;let Z=this.client.options.useBinaryProtocol?"msgpack":"json",G=k.defaultPostHeaders(this.client.options);if(this.client.options.headers)n(G,this.client.options.headers);let X=P0($,this.client._MsgPack,Z),U=await X0.post(this.client,"/messages",X,G,{},null,!0),O=U.unpacked?U.body:F0(U.body,this.client._MsgPack,Z);if(w)return O[0];else return O}async batchPresence(q){let $=this.client.options.useBinaryProtocol?"msgpack":"json",w=k.defaultGetHeaders(this.client.options);if(this.client.options.headers)n(w,this.client.options.headers);let Z=q.join(","),G=await X0.get(this.client,"/presence",w,{channels:Z},null,!0);return G.unpacked?G.body:F0(G.body,this.client._MsgPack,$)}async revokeTokens(q,$){if(f$(this.client.options))throw new D("Cannot revoke tokens when using token auth",40162,401);let w=this.client.options.keyName,Z=$!=null?$:{},G=_({targets:q.map((z)=>`${z.type}:${z.value}`)},Z),X=this.client.options.useBinaryProtocol?"msgpack":"json",U=k.defaultPostHeaders(this.client.options);if(this.client.options.headers)n(U,this.client.options.headers);let O=P0(G,this.client._MsgPack,X),F=await X0.post(this.client,`/keys/${w}/revokeTokens`,O,U,{},null,!0);return F.unpacked?F.body:F0(F.body,this.client._MsgPack,X)}},b4=class{constructor(q){this.client=q,this.all=Object.create(null)}get(q,$){q=String(q);let w=this.all[q];if(!w)this.all[q]=w=new M4(this.client,q,$);else if($)w.setOptions($);return w}release(q){delete this.all[String(q)]}},S4=class extends $7{constructor(q){super(k.objectifyOptions(q,!1,"BaseRest",Q.defaultLogger,{Rest:F7}))}},h7={Rest:F7},D7=class extends f0{static async fromEncoded(q,$){return Q7(Q.defaultLogger,B.Crypto,q,$)}static async fromEncodedArray(q,$){return Y4(Q.defaultLogger,B.Crypto,q,$)}static fromValues(q){return f0.fromValues(q)}},B7=class extends t0{static async fromEncoded(q,$){return G7(Q.defaultLogger,B.Crypto,q,$)}static async fromEncodedArray(q,$){return V4(Q.defaultLogger,B.Crypto,q,$)}static fromValues(q){return t0.fromValues(q)}},Y7=["annotation.create","annotation.delete"];async function I7(q,$,w){return L1.fromValues($).decode(w||{},q)}async function T4(q,$,w){return Promise.all($.map(function(Z){return I7(q,Z,w)}))}async function E4(q,$){return L1.fromValues(q).decode($.channelOptions,$.logger)}async function c4(q,$){return Promise.all(q.map(function(w){return E4(w,$)}))}var j7=class q extends A1{async encode(){let $=Object.assign(new L1,this,{action:Y7.indexOf(this.action||"annotation.create")});return i8($,{})}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}toString(){return j1(this,"Annotation")}},L1=class q extends A1{toJSON(...$){return p8.call(this,...$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}async decode($,w){let Z=Object.assign(new j7,E(_({},this),{action:Y7[this.action]}));try{await g8(Z,$)}catch(G){Q.logAction(w,Q.LOG_ERROR,"WireAnnotation.decode()",w0(G))}return Z}toString(){return j1(this,"WireAnnotation")}},R1=j7,A7=class extends R1{static async fromEncoded(q,$){return I7(Q.defaultLogger,q,$)}static async fromEncodedArray(q,$){return T4(Q.defaultLogger,q,$)}static fromValues(q){return R1.fromValues(q)}};function M7(q){let $;switch(typeof q){case"string":$=q;break;case"object":$=q.serial;break}if(!$||typeof $!=="string")throw new D("First argument of annotations.publish() must be either a Message (or at least an object with a string `serial` property) or a message serial (string)",40003,400);return $}function L7(q,$){let w=M7(q);if(!$||typeof $!=="object")throw new D("Second argument of annotations.publish() must be an object (the intended annotation to publish)",40003,400);let Z=R1.fromValues($);if(Z.messageSerial=w,!Z.action)Z.action="annotation.create";return Z}function R7(q,$){return q.client.rest.channelMixin.basePath(q)+"/messages/"+encodeURIComponent($)+"/annotations"}var P4=class{constructor(q){this.channel=q}async publish(q,$){let w=L7(q,$),Z=await w.encode(),G=this.channel.client,X=G.options,U=X.useBinaryProtocol?"msgpack":"json",O=k.defaultPostHeaders(G.options),F={};n(O,G.options.headers);let z=P0([Z],G._MsgPack,U);await X0.post(G,R7(this.channel,w.messageSerial),z,O,F,null,!0)}async delete(q,$){return $.action="annotation.delete",this.publish(q,$)}async get(q,$){let w=this.channel.client,Z=M7(q),G=w.options.useBinaryProtocol?"msgpack":"json",X=w.http.supportsLinkHeaders?void 0:G,U=k.defaultGetHeaders(w.options);return n(U,w.options.headers),new k0(w,R7(this.channel,Z),U,X,async(O,F,z)=>{let I=z?O:F0(O,w._MsgPack,G);return c4(I,this.channel)}).get($)}},mq=P4,C4=P0;function oq(q){let $=[];if(q)for(let w=0;w<q.length;w++)$.push(q[w].toString());return"[ "+$.join(", ")+" ]"}function k4(q,$,w,Z,G,X){let U=F0(q,$,X);return x8(U,w,Z,G)}function x8(q,$,w,Z){let G;if(q.error)G=D.fromValues(q.error);let X;if(q.messages)X=s1.fromValuesArray(q.messages);let U;if($&&q.presence)U=$.WirePresenceMessage.fromValuesArray(q.presence);let O;if(w&&q.annotations)O=w.WireAnnotation.fromValuesArray(q.annotations);let F;if(Z&&q.state)F=Z.WireObjectMessage.fromValuesArray(q.state,z0,dq);return Object.assign(new t8,E(_({},q),{presence:U,messages:X,annotations:O,state:F,error:G}))}function _7(q){return($)=>{var w;return x8($,{PresenceMessage:t0,WirePresenceMessage:a1},{Annotation:R1,WireAnnotation:L1,RealtimeAnnotations:m8,RestAnnotations:mq},(w=q==null?void 0:q.ObjectsPlugin)!=null?w:null)}}function L0(q){return Object.assign(new t8,q)}function d8(q,$,w,Z){let G="[ProtocolMessage";if(q.action!==void 0)G+="; action="+m$[q.action]||q.action;let X=["id","channel","channelSerial","connectionId","count","msgSerial","timestamp"],U;for(let O=0;O<X.length;O++)if(U=X[O],q[U]!==void 0)G+="; "+U+"="+q[U];if(q.messages)G+="; messages="+oq(s1.fromValuesArray(q.messages));if(q.presence&&$)G+="; presence="+oq($.WirePresenceMessage.fromValuesArray(q.presence));if(q.annotations&&w)G+="; annotations="+oq(w.WireAnnotation.fromValuesArray(q.annotations));if(q.state&&Z)G+="; state="+oq(Z.WireObjectMessage.fromValuesArray(q.state,z0,dq));if(q.error)G+="; error="+D.fromValues(q.error).toString();if(q.auth&&q.auth.accessToken)G+="; token="+q.auth.accessToken;if(q.flags)G+="; flags="+au.filter(q.hasFlag).join(",");if(q.params){let O="";if(h$(q.params,function(F){if(O.length>0)O+="; ";O+=F+"="+q.params[F]}),O.length>0)G+="; params=["+O+"]"}return G+="]",G}var t8=class{constructor(){this.hasFlag=(q)=>{return(this.flags&A0[q])>0}}setFlag(q){return this.flags=this.flags|A0[q]}getMode(){return(this.flags||0)&A0.MODE_ALL}encodeModesToFlags(q){q.forEach(($)=>this.setFlag($))}decodeModesFromFlags(){let q=[];return o$.forEach(($)=>{if(this.hasFlag($))q.push($)}),q.length>0?q:void 0}},n4=t8,y4=class{constructor(q,$,w,Z,G){if(this.previous=q,this.current=$,$==="attached")this.resumed=w,this.hasBacklog=Z;if(G)this.reason=G}},f8=y4,b7=function(){};function i4(q){if(q&&"params"in q&&!Y1(q.params))return new D("options.params must be an object",40000,400);if(q&&"modes"in q){if(!Array.isArray(q.modes))return new D("options.modes must be an array",40000,400);for(let $=0;$<q.modes.length;$++){let w=q.modes[$];if(!w||typeof w!=="string"||!o$.includes(String.prototype.toUpperCase.call(w)))return new D("Invalid channel mode: "+w,40000,400)}}}var g4=class q extends V0{constructor($,w,Z){var G,X,U;super($.logger);if(this._annotations=null,this._mode=0,this.retryCount=0,this.history=async function(O){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name);let F=this.client.rest.channelMixin;if(O&&O.untilAttach){if(this.state!=="attached")throw new D("option untilAttach requires the channel to be attached",40000,400);if(!this.properties.attachSerial)throw new D("untilAttach was specified and channel is attached, but attachSerial is not defined",40000,400);delete O.untilAttach,O.from_serial=this.properties.attachSerial}return F.history(this,O)},this.whenState=(O)=>{return V0.prototype.whenState.call(this,O,this.state)},Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel()","started; name = "+w),this.name=w,this.channelOptions=vq((G=$._Crypto)!=null?G:null,this.logger,Z),this.client=$,this._presence=$._RealtimePresence?new $._RealtimePresence.RealtimePresence(this):null,$._Annotations)this._annotations=new $._Annotations.RealtimeAnnotations(this);if(this.connectionManager=$.connection.connectionManager,this.state="initialized",this.subscriptions=new V0(this.logger),this.syncChannelSerial=void 0,this.properties={attachSerial:void 0,channelSerial:void 0},this.setOptions(Z),this.errorReason=null,this._attachResume=!1,this._decodingContext={channelOptions:this.channelOptions,plugins:$.options.plugins||{},baseEncodedPreviousPayload:void 0},this._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},this._allChannelChanges=new V0(this.logger),(X=$.options.plugins)==null?void 0:X.Push)this._push=new $.options.plugins.Push.PushChannel(this);if((U=$.options.plugins)==null?void 0:U.Objects)this._objects=new $.options.plugins.Objects.Objects(this)}get presence(){if(!this._presence)h0("RealtimePresence");return this._presence}get annotations(){if(!this._annotations)h0("Annotations");return this._annotations}get push(){if(!this._push)h0("Push");return this._push}get objects(){if(!this._objects)h0("Objects");return this._objects}invalidStateError(){return new D("Channel operation failed as channel state is "+this.state,90001,400,this.errorReason||void 0)}static processListenerArgs($){if($=Array.prototype.slice.call($),typeof $[0]==="function")$.unshift(null);return $}async setOptions($){var w;let Z=this.channelOptions,G=i4($);if(G)throw G;if(this.channelOptions=vq((w=this.client._Crypto)!=null?w:null,this.logger,$),this._decodingContext)this._decodingContext.channelOptions=this.channelOptions;if(this._shouldReattachToSetOptions($,Z))return this.attachImpl(),new Promise((X,U)=>{this._allChannelChanges.once(["attached","update","detached","failed"],function(O){switch(this.event){case"update":case"attached":X();break;default:U(O.reason)}})})}_shouldReattachToSetOptions($,w){if(!(this.state==="attached"||this.state==="attaching"))return!1;if($==null?void 0:$.params){let Z=S7($.params),G=S7(w.params);if(Object.keys(Z).length!==Object.keys(G).length)return!0;if(!_$(G,Z))return!0}if($==null?void 0:$.modes){if(!w.modes||!S$($.modes,w.modes))return!0}return!1}async publish(...$){let w;if($.length==1)if(Y1($[0]))w=[f0.fromValues($[0])];else if(Array.isArray($[0]))w=f0.fromValuesArray($[0]);else throw new D("The single-argument form of publish() expects a message object or an array of message objects",40013,400);else w=[f0.fromValues({name:$[0],data:$[1]})];let G=this.client.options.maxMessageSize,X=await K7(w,this.channelOptions),U=v8(X);if(U>G)throw new D(`Maximum size of messages that can be published at once exceeded (was ${U} bytes; limit is ${G} bytes)`,40009,400);this.throwIfUnpublishableState(),Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+this.state+", message count = "+X.length);let O=L0({action:C.MESSAGE,channel:this.name,messages:X});return this.sendMessage(O)}throwIfUnpublishableState(){if(!this.connectionManager.activeState())throw this.connectionManager.getError();if(this.state==="failed"||this.state==="suspended")throw this.invalidStateError()}onEvent($){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.onEvent()","received message");let w=this.subscriptions;for(let Z=0;Z<$.length;Z++){let G=$[Z];w.emit(G.name,G)}}async attach(){if(this.state==="attached")return null;return new Promise(($,w)=>{this._attach(!1,null,(Z,G)=>Z?w(Z):$(G))})}_attach($,w,Z){if(!Z)Z=(X)=>{if(X)Q.logAction(this.logger,Q.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+X.toString())};let G=this.connectionManager;if(!G.activeState()){Z(G.getError());return}if(this.state!=="attaching"||$)this.requestState("attaching",w);this.once(function(X){switch(this.event){case"attached":Z==null||Z(null,X);break;case"detached":case"suspended":case"failed":Z==null||Z(X.reason||G.getError()||new D("Unable to attach; reason unknown; state = "+this.event,90000,500));break;case"detaching":Z==null||Z(new D("Attach request superseded by a subsequent detach request",90000,409));break}})}attachImpl(){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");let $=L0({action:C.ATTACH,channel:this.name,params:this.channelOptions.params,channelSerial:this.properties.channelSerial});if(this.channelOptions.modes)$.encodeModesToFlags(M$(this.channelOptions.modes));if(this._attachResume)$.setFlag("ATTACH_RESUME");if(this._lastPayload.decodeFailureRecoveryInProgress)$.channelSerial=this._lastPayload.protocolMessageChannelSerial;this.sendMessage($).catch(b7)}async detach(){let $=this.connectionManager;if(!$.activeState())throw $.getError();switch(this.state){case"suspended":this.notifyState("detached");return;case"detached":return;case"failed":throw new D("Unable to detach; channel state = failed",90001,400);default:this.requestState("detaching");case"detaching":return new Promise((w,Z)=>{this.once(function(G){switch(this.event){case"detached":w();break;case"attached":case"suspended":case"failed":Z(G.reason||$.getError()||new D("Unable to detach; reason unknown; state = "+this.event,90000,500));break;case"attaching":Z(new D("Detach request superseded by a subsequent attach request",90000,409));break}})})}}detachImpl(){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message");let $=L0({action:C.DETACH,channel:this.name});this.sendMessage($).catch(b7)}async subscribe(...$){let[w,Z]=q.processListenerArgs($);if(this.state==="failed")throw D.fromValues(this.invalidStateError());if(w&&typeof w==="object"&&!Array.isArray(w))this.client._FilteredSubscriptions.subscribeFilter(this,w,Z);else this.subscriptions.on(w,Z);if(this.channelOptions.attachOnSubscribe!==!1)return this.attach();else return null}unsubscribe(...$){var w;let[Z,G]=q.processListenerArgs($);if(typeof Z==="object"&&!G||((w=this.filteredSubscriptions)==null?void 0:w.has(G))){this.client._FilteredSubscriptions.getAndDeleteFilteredSubscriptions(this,Z,G).forEach((X)=>this.subscriptions.off(X));return}this.subscriptions.off(Z,G)}sync(){switch(this.state){case"initialized":case"detaching":case"detached":throw new o("Unable to sync to channel; not attached",40000);default:}let $=this.connectionManager;if(!$.activeState())throw $.getError();let w=L0({action:C.SYNC,channel:this.name});if(this.syncChannelSerial)w.channelSerial=this.syncChannelSerial;$.send(w)}async sendMessage($){return new Promise((w,Z)=>{this.connectionManager.send($,this.client.options.queueMessages,(G)=>{if(G)Z(G);else w()})})}async sendPresence($){let w=L0({action:C.PRESENCE,channel:this.name,presence:$});return this.sendMessage(w)}sendState($){let w=L0({action:C.OBJECT,channel:this.name,state:$});return this.sendMessage(w)}async processMessage($){if($.action===C.ATTACHED||$.action===C.MESSAGE||$.action===C.PRESENCE||$.action===C.OBJECT||$.action===C.ANNOTATION)this.setChannelSerial($.channelSerial);let w,Z=!1;switch($.action){case C.ATTACHED:{this.properties.attachSerial=$.channelSerial,this._mode=$.getMode(),this.params=$.params||{};let G=$.decodeModesFromFlags();this.modes=G&&S8(G)||void 0;let X=$.hasFlag("RESUMED"),U=$.hasFlag("HAS_PRESENCE"),O=$.hasFlag("HAS_BACKLOG"),F=$.hasFlag("HAS_OBJECTS");if(this.state==="attached"){if(!X){if(this._presence)this._presence.onAttached(U);if(this._objects)this._objects.onAttached(F)}let z=new f8(this.state,this.state,X,O,$.error);if(this._allChannelChanges.emit("update",z),!X||this.channelOptions.updateOnAttached)this.emit("update",z)}else if(this.state==="detaching")this.checkPendingState();else this.notifyState("attached",$.error,X,U,O,F);break}case C.DETACHED:{let G=$.error?D.fromValues($.error):new D("Channel detached",90001,404);if(this.state==="detaching")this.notifyState("detached",G);else if(this.state==="attaching")this.notifyState("suspended",G);else if(this.state==="attached"||this.state==="suspended")this.requestState("attaching",G);break}case C.SYNC:if(Z=!0,w=this.syncChannelSerial=$.channelSerial,!$.presence)break;case C.PRESENCE:{if(!$.presence)break;tq($);let G=this.channelOptions;if(this._presence){let X=await Promise.all($.presence.map((U)=>{return U.decode(G,this.logger)}));this._presence.setPresence(X,Z,w)}break}case C.OBJECT:case C.OBJECT_SYNC:{if(!this._objects||!$.state)return;tq($);let G=this.client.connection.connectionManager.getActiveTransportFormat(),X=$.state.map((U)=>U.decode(this.client,G));if($.action===C.OBJECT)this._objects.handleObjectMessages(X);else this._objects.handleObjectSyncMessages(X,$.channelSerial);break}case C.MESSAGE:{if(this.state!=="attached"){Q.logAction(this.logger,Q.LOG_MAJOR,"RealtimeChannel.processMessage()",'Message "'+$.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');return}tq($);let G=$.messages,X=G[0],U=G[G.length-1];if(X.extras&&X.extras.delta&&X.extras.delta.from!==this._lastPayload.messageId){let F='Delta message decode failure - previous message not available for message "'+$.id+'" on this channel "'+this.name+'".';Q.logAction(this.logger,Q.LOG_ERROR,"RealtimeChannel.processMessage()",F),this._startDecodeFailureRecovery(new D(F,40018,400));break}let O=[];for(let F=0;F<G.length;F++){let{decoded:z,err:I}=await G[F].decodeWithErr(this._decodingContext,this.logger);if(O[F]=z,I)switch(I.code){case 40018:this._startDecodeFailureRecovery(I);return;case 40019:case 40021:this.notifyState("failed",I);return;default:}}this._lastPayload.messageId=U.id,this._lastPayload.protocolMessageChannelSerial=$.channelSerial,this.onEvent(O);break}case C.ANNOTATION:{tq($);let G=this.channelOptions;if(this._annotations){let X=await Promise.all(($.annotations||[]).map((U)=>{return U.decode(G,this.logger)}));this._annotations._processIncoming(X)}break}case C.ERROR:{let G=$.error;if(G&&G.code==80016)this.checkPendingState();else this.notifyState("failed",D.fromValues(G));break}default:Q.logAction(this.logger,Q.LOG_MAJOR,"RealtimeChannel.processMessage()","Protocol error: unrecognised message action ("+$.action+")")}}_startDecodeFailureRecovery($){if(!this._lastPayload.decodeFailureRecoveryInProgress)Q.logAction(this.logger,Q.LOG_MAJOR,"RealtimeChannel.processMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,$,()=>{this._lastPayload.decodeFailureRecoveryInProgress=!1})}onAttached(){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)}notifyState($,w,Z,G,X,U){if(Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+$),this.clearStateTimer(),["detached","suspended","failed"].includes($))this.properties.channelSerial=null;if($===this.state)return;if(this._presence)this._presence.actOnChannelState($,G,w);if(this._objects)this._objects.actOnChannelState($,U);if($==="suspended"&&this.connectionManager.state.sendEvents)this.startRetryTimer();else this.cancelRetryTimer();if(w)this.errorReason=w;let O=new f8(this.state,$,Z,X,w),F='Channel state for channel "'+this.name+'"',z=$+(w?"; reason: "+w:"");if($==="failed")Q.logAction(this.logger,Q.LOG_ERROR,F,z);else Q.logAction(this.logger,Q.LOG_MAJOR,F,z);if($!=="attaching"&&$!=="suspended")this.retryCount=0;if($==="attached")this.onAttached();if($==="attached")this._attachResume=!0;else if($==="detaching"||$==="failed")this._attachResume=!1;this.state=$,this._allChannelChanges.emit($,O),this.emit($,O)}requestState($,w){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+$),this.notifyState($,w),this.checkPendingState()}checkPendingState(){if(!this.connectionManager.state.sendEvents){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state);return}switch(Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync();break;default:break}}timeoutPendingState(){switch(this.state){case"attaching":{let $=new D("Channel attach timed out",90007,408);this.notifyState("suspended",$);break}case"detaching":{let $=new D("Channel detach timed out",90007,408);this.notifyState("attached",$);break}default:this.checkPendingState();break}}startStateTimerIfNotRunning(){if(!this.stateTimer)this.stateTimer=setTimeout(()=>{Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),this.stateTimer=null,this.timeoutPendingState()},this.client.options.timeouts.realtimeRequestTimeout)}clearStateTimer(){let $=this.stateTimer;if($)clearTimeout($),this.stateTimer=null}startRetryTimer(){if(this.retryTimer)return;this.retryCount++;let $=T8(this.client.options.timeouts.channelRetryTimeout,this.retryCount);this.retryTimer=setTimeout(()=>{if(this.state==="suspended"&&this.connectionManager.state.sendEvents)this.retryTimer=null,Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),this.requestState("attaching")},$)}cancelRetryTimer(){if(this.retryTimer)clearTimeout(this.retryTimer),this.retryTimer=null}getReleaseErr(){let $=this.state;if($==="initialized"||$==="detached"||$==="failed")return null;return new D("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+$,90001,400)}setChannelSerial($){if(Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.setChannelSerial()","Updating channel serial; serial = "+$+"; previous = "+this.properties.channelSerial),$)this.properties.channelSerial=$}async status(){return this.client.rest.channelMixin.status(this)}async getMessage($){return Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.getMessage()","channel = "+this.name),this.client.rest.channelMixin.getMessage(this,$)}async updateMessage($,w,Z){return Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.updateMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!1},$,w,Z)}async deleteMessage($,w,Z){return Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.deleteMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!0},$,w,Z)}async getMessageVersions($,w){return Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.getMessageVersions()","channel = "+this.name),this.client.rest.channelMixin.getMessageVersions(this,$,w)}};function S7(q){let $=q||{},{agent:w}=$;return $0($,["agent"])}var e1=g4,p4=class{constructor(q){this.channel=q,this.logger=q.logger,this.subscriptions=new V0(this.logger)}async publish(q,$){let w=this.channel.name,Z=L7(q,$),G=await Z.encode();this.channel.throwIfUnpublishableState(),Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeAnnotations.publish()","channelName = "+w+", sending annotation with messageSerial = "+Z.messageSerial+", type = "+Z.type);let X=L0({action:C.ANNOTATION,channel:w,annotations:[G]});return this.channel.sendMessage(X)}async delete(q,$){return $.action="annotation.delete",this.publish(q,$)}async subscribe(...q){let $=e1.processListenerArgs(q),w=$[0],Z=$[1],G=this.channel;if(G.state==="failed")throw D.fromValues(G.invalidStateError());if(this.subscriptions.on(w,Z),this.channel.channelOptions.attachOnSubscribe!==!1)await G.attach();if((this.channel.state==="attached"&&this.channel._mode&A0.ANNOTATION_SUBSCRIBE)===0)throw new D("You are trying to add an annotation listener, but you haven't requested the annotation_subscribe channel mode in ChannelOptions, so this won't do anything (we only deliver annotations to clients who have explicitly requested them)",93001,400)}unsubscribe(...q){let $=e1.processListenerArgs(q),w=$[0],Z=$[1];this.subscriptions.off(w,Z)}_processIncoming(q){for(let $ of q)this.subscriptions.emit($.type||"",$)}async get(q,$){return mq.prototype.get.call(this,q,$)}},m8=p4,K1=class q extends S4{constructor($){var w,Z;if(!q._MsgPack)throw Error("Expected DefaultRest._MsgPack to have been set");super(k.objectifyOptions($,!0,"Rest",Q.defaultLogger,E(_({},h7),{Crypto:(w=q.Crypto)!=null?w:void 0,MsgPack:(Z=q._MsgPack)!=null?Z:void 0,Annotations:{Annotation:R1,WireAnnotation:L1,RealtimeAnnotations:m8,RestAnnotations:mq}})))}static get Crypto(){if(this._Crypto===null)throw Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto($){this._Crypto=$}};K1._Crypto=null,K1.Message=D7,K1.PresenceMessage=B7,K1.Annotation=A7,K1._MsgPack=null,K1._Http=n8;var o8=K1,v4=class extends V0{constructor(q){super(q);this.messages=[]}count(){return this.messages.length}push(q){this.messages.push(q)}shift(){return this.messages.shift()}last(){return this.messages[this.messages.length-1]}copyAll(){return this.messages.slice()}append(q){this.messages.push.apply(this.messages,q)}prepend(q){this.messages.unshift.apply(this.messages,q)}completeMessages(q,$,w){Q.logAction(this.logger,Q.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+q+"; count = "+$),w=w||null;let Z=this.messages;if(Z.length===0)throw Error("MessageQueue.completeMessages(): completeMessages called on any empty MessageQueue");let G=Z[0];if(G){let X=G.message.msgSerial,U=q+$;if(U>X){let O=Z.splice(0,U-X);for(let F of O)F.callback(w)}if(Z.length==0)this.emit("idle")}}completeAllMessages(q){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,q)}resetSendAttempted(){for(let q of this.messages)q.sendAttempted=!1}clear(){Q.logAction(this.logger,Q.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")}},T7=v4,E7=class{constructor(q,$){this.message=q,this.callback=$,this.merged=!1;let w=q.action;this.sendAttempted=!1,this.ackRequired=typeof w==="number"&&[C.MESSAGE,C.PRESENCE,C.ANNOTATION,C.OBJECT].includes(w)}},x4=class extends V0{constructor(q){super(q.logger);this.transport=q,this.messageQueue=new T7(this.logger),q.on("ack",($,w)=>{this.onAck($,w)}),q.on("nack",($,w,Z)=>{this.onNack($,w,Z)})}onAck(q,$){Q.logAction(this.logger,Q.LOG_MICRO,"Protocol.onAck()","serial = "+q+"; count = "+$),this.messageQueue.completeMessages(q,$)}onNack(q,$,w){if(Q.logAction(this.logger,Q.LOG_ERROR,"Protocol.onNack()","serial = "+q+"; count = "+$+"; err = "+w0(w)),!w)w=new D("Unable to send message; channel not responding",50001,500);this.messageQueue.completeMessages(q,$,w)}onceIdle(q){let $=this.messageQueue;if($.count()===0){q();return}$.once("idle",q)}send(q){if(q.ackRequired)this.messageQueue.push(q);if(this.logger.shouldLog(Q.LOG_MICRO))Q.logActionNoStrip(this.logger,Q.LOG_MICRO,"Protocol.send()","sending msg; "+d8(q.message,this.transport.connectionManager.realtime._RealtimePresence,this.transport.connectionManager.realtime._Annotations,this.transport.connectionManager.realtime._objectsPlugin));q.sendAttempted=!0,this.transport.send(q.message)}getTransport(){return this.transport}getPendingMessages(){return this.messageQueue.copyAll()}clearPendingMessages(){return this.messageQueue.clear()}finish(){let q=this.transport;this.onceIdle(function(){q.disconnect()})}},d4=x4,t4=class{constructor(q,$,w,Z){if(this.previous=q,this.current=$,w)this.retryIn=w;if(Z)this.reason=Z}},lq=t4,q1={DISCONNECTED:80003,SUSPENDED:80002,FAILED:80000,CLOSING:80017,CLOSED:80017,UNKNOWN_CONNECTION_ERR:50002,UNKNOWN_CHANNEL_ERR:50001},f4={disconnected:()=>D.fromValues({statusCode:400,code:q1.DISCONNECTED,message:"Connection to server temporarily unavailable"}),suspended:()=>D.fromValues({statusCode:400,code:q1.SUSPENDED,message:"Connection to server unavailable"}),failed:()=>D.fromValues({statusCode:400,code:q1.FAILED,message:"Connection failed or disconnected by server"}),closing:()=>D.fromValues({statusCode:400,code:q1.CLOSING,message:"Connection closing"}),closed:()=>D.fromValues({statusCode:400,code:q1.CLOSED,message:"Connection closed"}),unknownConnectionErr:()=>D.fromValues({statusCode:500,code:q1.UNKNOWN_CONNECTION_ERR,message:"Internal connection error"}),unknownChannelErr:()=>D.fromValues({statusCode:500,code:q1.UNKNOWN_CONNECTION_ERR,message:"Internal channel error"})};function m4(q){if(!q.statusCode||!q.code||q.statusCode>=500)return!0;return Object.values(q1).includes(q.code)}var O1=f4,o4=L0({action:C.CLOSE}),l4=L0({action:C.DISCONNECT}),r4=class extends V0{constructor(q,$,w,Z){super(q.logger);if(Z)w.format=void 0,w.heartbeats=!0;this.connectionManager=q,this.auth=$,this.params=w,this.timeouts=w.options.timeouts,this.format=w.format,this.isConnected=!1,this.isFinished=!1,this.isDisposed=!1,this.maxIdleInterval=null,this.idleTimer=null,this.lastActivity=null}connect(){}close(){if(this.isConnected)this.requestClose();this.finish("closed",O1.closed())}disconnect(q){if(this.isConnected)this.requestDisconnect();this.finish("disconnected",q||O1.disconnected())}fail(q){if(this.isConnected)this.requestDisconnect();this.finish("failed",q||O1.failed())}finish(q,$){var w;if(this.isFinished)return;this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout((w=this.idleTimer)!=null?w:void 0),this.idleTimer=null,this.emit(q,$),this.dispose()}onProtocolMessage(q){if(this.logger.shouldLog(Q.LOG_MICRO))Q.logActionNoStrip(this.logger,Q.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+d8(q,this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin)+"; connectionId = "+this.connectionManager.connectionId);switch(this.onActivity(),q.action){case C.HEARTBEAT:Q.logActionNoStrip(this.logger,Q.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",q.id);break;case C.CONNECTED:this.onConnect(q),this.emit("connected",q.error,q.connectionId,q.connectionDetails,q);break;case C.CLOSED:this.onClose(q);break;case C.DISCONNECTED:this.onDisconnect(q);break;case C.ACK:this.emit("ack",q.msgSerial,q.count);break;case C.NACK:this.emit("nack",q.msgSerial,q.count,q.error);break;case C.SYNC:this.connectionManager.onChannelMessage(q,this);break;case C.ACTIVATE:break;case C.AUTH:j0(this.auth.authorize(),($)=>{if($)Q.logAction(this.logger,Q.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+w0($))});break;case C.ERROR:if(Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+B.Config.inspect(q.error)+(q.channel?", channel: "+q.channel:"")),q.channel===void 0){this.onFatalError(q);break}this.connectionManager.onChannelMessage(q,this);break;default:this.connectionManager.onChannelMessage(q,this)}}onConnect(q){if(this.isConnected=!0,!q.connectionDetails)throw Error("Transport.onConnect(): Connect message recieved without connectionDetails");let $=q.connectionDetails.maxIdleInterval;if($)this.maxIdleInterval=$+this.timeouts.realtimeRequestTimeout,this.onActivity()}onDisconnect(q){let $=q&&q.error;Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onDisconnect()","err = "+w0($)),this.finish("disconnected",$)}onFatalError(q){let $=q&&q.error;Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onFatalError()","err = "+w0($)),this.finish("failed",$)}onClose(q){let $=q&&q.error;Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onClose()","err = "+w0($)),this.finish("closed",$)}requestClose(){Q.logAction(this.logger,Q.LOG_MINOR,"Transport.requestClose()",""),this.send(o4)}requestDisconnect(){Q.logAction(this.logger,Q.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(l4)}ping(q){let $={action:C.HEARTBEAT};if(q)$.id=q;this.send(L0($))}dispose(){Q.logAction(this.logger,Q.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()}onActivity(){if(!this.maxIdleInterval)return;this.lastActivity=this.connectionManager.lastActivity=Date.now(),this.setIdleTimer(this.maxIdleInterval+100)}setIdleTimer(q){if(!this.idleTimer)this.idleTimer=setTimeout(()=>{this.onIdleTimerExpire()},q)}onIdleTimerExpire(){if(!this.lastActivity||!this.maxIdleInterval)throw Error("Transport.onIdleTimerExpire(): lastActivity/maxIdleInterval not set");this.idleTimer=null;let q=Date.now()-this.lastActivity,$=this.maxIdleInterval-q;if($<=0){let w="No activity seen from realtime in "+q+"ms; assuming connection has dropped";Q.logAction(this.logger,Q.LOG_ERROR,"Transport.onIdleTimerExpire()",w),this.disconnect(new D(w,80003,408))}else this.setIdleTimer($+100)}static tryConnect(q,$,w,Z,G){let X=new q($,w,Z),U,O=function(z){clearTimeout(U),G({event:this.event,error:z})},F=$.options.timeouts.realtimeRequestTimeout;return U=setTimeout(()=>{X.off(["preconnect","disconnected","failed"]),X.dispose(),O.call({event:"disconnected"},new D("Timeout waiting for transport to indicate itself viable",50000,500))},F),X.on(["failed","disconnected"],O),X.on("preconnect",function(){Q.logAction($.logger,Q.LOG_MINOR,"Transport.tryConnect()","viable transport "+X),clearTimeout(U),X.off(["failed","disconnected"],O),G(null,X)}),X.connect(),X}static isAvailable(){throw new D("isAvailable not implemented for transport",50000,500)}},_1=r4,M0;((q)=>{q.WebSocket="web_socket",q.Comet="comet",q.XhrPolling="xhr_polling"})(M0||(M0={}));var a4=typeof global<"u"?global:typeof window<"u"?window:self,l8=()=>{var q;return typeof B.WebStorage<"u"&&((q=B.WebStorage)==null?void 0:q.localSupported)},qq=()=>{var q;return typeof B.WebStorage<"u"&&((q=B.WebStorage)==null?void 0:q.sessionSupported)},c7=function(){},r8="ably-transport-preference";function s4(q,$,w){let Z;if(q.channel!==$.channel)return!1;if((Z=q.action)!==C.PRESENCE&&Z!==C.MESSAGE)return!1;if(Z!==$.action)return!1;let G=Z===C.PRESENCE?"presence":"messages",X=q[G].concat($[G]);if(v8(X)>w)return!1;if(!D$(X,"clientId"))return!1;if(!X.every(function(O){return!O.id}))return!1;return q[G]=X,!0}function a8(q){try{return JSON.parse(q)}catch($){return null}}var e4=class{constructor(q,$,w,Z){this.options=q,this.host=$,this.mode=w,this.connectionKey=Z,this.format=q.useBinaryProtocol?"msgpack":"json"}getConnectParams(q){let $=q?B1(q):{},w=this.options;switch(this.mode){case"resume":$.resume=this.connectionKey;break;case"recover":{let Z=a8(w.recover);if(Z)$.recover=Z.connectionKey;break}default:}if(w.clientId!==void 0)$.clientId=w.clientId;if(w.echoMessages===!1)$.echo="false";if(this.format!==void 0)$.format=this.format;if(this.stream!==void 0)$.stream=this.stream;if(this.heartbeats!==void 0)$.heartbeats=this.heartbeats;if($.v=k.protocolVersion,$.agent=c8(this.options),w.transportParams!==void 0)n($,w.transportParams);return $}toString(){let q="[mode="+this.mode;if(this.host)q+=",host="+this.host;if(this.connectionKey)q+=",connectionKey="+this.connectionKey;if(this.format)q+=",format="+this.format;return q+="]",q}},q2=class q extends V0{constructor($,w){super($.logger);this.supportedTransports={},this.disconnectedRetryCount=0,this.pendingChannelMessagesState={isProcessing:!1,queue:[]},this.realtime=$,this.initTransports(),this.options=w;let Z=w.timeouts,G=Z.webSocketConnectTimeout+Z.realtimeRequestTimeout;if(this.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:G,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:Z.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:Z.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:Z.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},this.state=this.states.initialized,this.errorReason=null,this.queuedMessages=new T7(this.logger),this.msgSerial=0,this.connectionDetails=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.connectionStateTtl=Z.connectionStateTtl,this.maxIdleInterval=null,this.transports=K$(w.transports||k.defaultTransports,this.supportedTransports),this.transportPreference=null,this.transports.includes(M0.WebSocket))this.webSocketTransportAvailable=!0;if(this.transports.includes(M0.XhrPolling))this.baseTransport=M0.XhrPolling;else if(this.transports.includes(M0.Comet))this.baseTransport=M0.Comet;if(this.domains=k.getHosts(w),this.activeProtocol=null,this.host=null,this.lastAutoReconnectAttempt=null,this.lastActivity=null,this.forceFallbackHost=!1,this.connectCounter=0,this.wsCheckResult=null,this.webSocketSlowTimer=null,this.webSocketGiveUpTimer=null,this.abandonedWebSocket=!1,Q.logAction(this.logger,Q.LOG_MINOR,"Realtime.ConnectionManager()","started"),Q.logAction(this.logger,Q.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(w.transports||k.defaultTransports)+"]"),Q.logAction(this.logger,Q.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]"),Q.logAction(this.logger,Q.LOG_MICRO,"Realtime.ConnectionManager()","http domains = ["+this.domains+"]"),!this.transports.length)throw Q.logAction(this.logger,Q.LOG_ERROR,"realtime.ConnectionManager()","no requested transports available"),Error("no requested transports available");let X=B.Config.addEventListener;if(X){if(qq()&&typeof w.recover==="function")X("beforeunload",this.persistConnection.bind(this));if(w.closeOnUnload===!0)X("beforeunload",()=>{Q.logAction(this.logger,Q.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),this.requestState({state:"closing"})});X("online",()=>{var U;if(this.state==this.states.disconnected||this.state==this.states.suspended)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager caught browser ‘online’ event","reattempting connection"),this.requestState({state:"connecting"});else if(this.state==this.states.connecting)(U=this.pendingTransport)==null||U.off(),this.disconnectAllTransports(),this.startConnect()}),X("offline",()=>{if(this.state==this.states.connected)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager caught browser ‘offline’ event","disconnecting active transport"),this.disconnectAllTransports()})}}static supportedTransports($){let w={supportedTransports:{}};return this.initTransports($,w),w.supportedTransports}static initTransports($,w){let Z=_(_({},B.Transports.bundledImplementations),$);[M0.WebSocket,...B.Transports.order].forEach((G)=>{let X=Z[G];if(X&&X.isAvailable())w.supportedTransports[G]=X})}initTransports(){q.initTransports(this.realtime._additionalTransportImplementations,this)}createTransportParams($,w){return new e4(this.options,$,w,this.connectionKey)}getTransportParams($){((Z)=>{if(this.connectionKey){Z("resume");return}if(typeof this.options.recover==="string"){Z("recover");return}let G=this.options.recover,X=this.getSessionRecoverData(),U=this.sessionRecoveryName();if(X&&typeof G==="function"){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data (recovery scope: "+U+")"),G(X,(O)=>{if(O)this.options.recover=X.recoveryKey,Z("recover");else Z("clean")});return}Z("clean")})((Z)=>{let G=this.createTransportParams(null,Z);if(Z==="recover"){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+this.options.recover);let X=a8(this.options.recover);if(X)this.msgSerial=X.msgSerial}else Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+G.toString());$(G)})}tryATransport($,w,Z){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+w),this.proposedTransport=_1.tryConnect(this.supportedTransports[w],this,this.realtime.auth,$,(G,X)=>{let U=this.state;if(U==this.states.closing||U==this.states.closed||U==this.states.failed){if(X)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+U.state+" while we were attempting the transport; closing "+X),X.close();Z(!0);return}if(G){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+w+" "+G.event+", err: "+G.error.toString()),d0.isTokenErr(G.error)&&!(this.errorReason&&d0.isTokenErr(this.errorReason)))this.errorReason=G.error,j0(this.realtime.auth._forceNewToken(null,null),(O)=>{if(O){this.actOnErrorFromAuthorize(O);return}this.tryATransport($,w,Z)});else if(G.event==="failed")this.notifyState({state:"failed",error:G.error}),Z(!0);else if(G.event==="disconnected")if(!m4(G.error))this.notifyState({state:this.states.connecting.failState,error:G.error}),Z(!0);else Z(!1);return}Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+w+"; setting pending"),this.setTransportPending(X,$),Z(null,X)})}setTransportPending($,w){let Z=w.mode;Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+$+"; mode = "+Z),this.pendingTransport=$,this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),$.once("connected",(X,U,O)=>{if(this.activateTransport(X,$,U,O),Z==="recover"&&this.options.recover)delete this.options.recover,this.unpersistConnection()});let G=this;$.on(["disconnected","closed","failed"],function(X){G.deactivateTransport($,this.event,X)}),this.emit("transport.pending",$)}activateTransport($,w,Z,G){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+w),$)Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+$);if(Z)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+Z);if(G)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(G));this.persistTransportPreference(w);let X=this.state,U=this.states.connected.state;if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+X.state),X.state==this.states.closing.state||X.state==this.states.closed.state||X.state==this.states.failed.state)return Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),w.disconnect(),!1;if(delete this.pendingTransport,!w.isConnected)return Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+w+" since it appears to no longer be connected"),!1;let O=this.activeProtocol;this.activeProtocol=new d4(w),this.host=w.params.host;let F=G.connectionKey;if(F&&this.connectionKey!=F)this.setConnection(Z,G,!!$);if(this.onConnectionDetailsUpdate(G,w),B.Config.nextTick(()=>{w.on("connected",(z,I,j)=>{this.onConnectionDetailsUpdate(j,w),this.emit("update",new lq(U,U,null,z))})}),X.state===this.states.connected.state){if($)this.errorReason=this.realtime.connection.errorReason=$,this.emit("update",new lq(U,U,null,$))}else this.notifyState({state:"connected",error:$}),this.errorReason=this.realtime.connection.errorReason=$||null;if(this.emit("transport.active",w),O){if(O.messageQueue.count()>0)Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+O.transport.shortName+", new one is "+w.shortName+") finishing with "+O.messageQueue.count()+" messages still pending");if(O.transport===w){let z="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+w.shortName+"; stack = "+Error().stack;Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.activateTransport()",z)}else O.finish()}return!0}deactivateTransport($,w,Z){let G=this.activeProtocol,X=G&&G.getTransport()===$,U=$===this.pendingTransport,O=this.noTransportsScheduledForActivation();if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+$),Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+w+(X?"; was active":U?"; was pending":"")+(O?"":"; another transport is scheduled for activation")),Z&&Z.message)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+Z.message);if(X)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(G.getPendingMessages()),G.clearPendingMessages(),this.activeProtocol=this.host=null;if(this.emit("transport.inactive",$),X&&O||X&&w==="failed"||w==="closed"||G===null&&U){if(w==="disconnected"&&Z&&Z.statusCode>500&&this.domains.length>1){this.unpersistTransportPreference(),this.forceFallbackHost=!0,this.notifyState({state:w,error:Z,retryImmediately:!0});return}let F=w==="failed"&&d0.isTokenErr(Z)?"disconnected":w;this.notifyState({state:F,error:Z});return}}noTransportsScheduledForActivation(){return!this.pendingTransport||!this.pendingTransport.isConnected}setConnection($,w,Z){let G=this.connectionId;if(G&&G!==$||!G&&Z)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0,this.queuedMessages.resetSendAttempted();if(this.connectionId!==$)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels");this.realtime.connection.id=this.connectionId=$,this.realtime.connection.key=this.connectionKey=w.connectionKey}clearConnection(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.msgSerial=0,this.unpersistConnection()}createRecoveryKey(){if(!this.connectionKey)return null;return JSON.stringify({connectionKey:this.connectionKey,msgSerial:this.msgSerial,channelSerials:this.realtime.channels.channelSerials()})}checkConnectionStateFreshness(){if(!this.lastActivity||!this.connectionId)return;let $=Date.now()-this.lastActivity;if($>this.connectionStateTtl+this.maxIdleInterval)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+$+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended"}persistConnection(){if(qq()){let $=this.createRecoveryKey();if($)this.setSessionRecoverData({recoveryKey:$,disconnectedAt:Date.now(),location:a4.location,clientId:this.realtime.auth.clientId})}}unpersistConnection(){this.clearSessionRecoverData()}getActiveTransportFormat(){var $;return($=this.activeProtocol)==null?void 0:$.getTransport().format}getError(){if(this.errorReason){let $=o.fromValues(this.errorReason);return $.cause=this.errorReason,$}return this.getStateError()}getStateError(){var $,w;return(w=($=O1)[this.state.state])==null?void 0:w.call($)}activeState(){return this.state.queueEvents||this.state.sendEvents}enactStateChange($){let Z=$.current+($.reason?"; reason: "+$.reason:"");if($.current==="failed")Q.logAction(this.logger,Q.LOG_ERROR,"Connection state",Z);else Q.logAction(this.logger,Q.LOG_MAJOR,"Connection state",Z);Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+$.current+"; reason = "+($.reason&&$.reason.message));let G=this.state=this.states[$.current];if($.reason)this.errorReason=$.reason,this.realtime.connection.errorReason=$.reason;if(G.terminal||G.state==="suspended")this.clearConnection();this.emit("connectionstate",$)}startTransitionTimer($){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+$.state),this.transitionTimer)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer);this.transitionTimer=setTimeout(()=>{if(this.transitionTimer)this.transitionTimer=null,Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager "+$.state+" timer expired","requesting new state: "+$.failState),this.notifyState({state:$.failState})},$.retryDelay)}cancelTransitionTimer(){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer)clearTimeout(this.transitionTimer),this.transitionTimer=null}startSuspendTimer(){if(this.suspendTimer)return;this.suspendTimer=setTimeout(()=>{if(this.suspendTimer)this.suspendTimer=null,Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),this.states.connecting.failState="suspended",this.notifyState({state:"suspended"})},this.connectionStateTtl)}checkSuspendTimer($){if($!=="disconnected"&&$!=="suspended"&&$!=="connecting")this.cancelSuspendTimer()}cancelSuspendTimer(){if(this.states.connecting.failState="disconnected",this.suspendTimer)clearTimeout(this.suspendTimer),this.suspendTimer=null}startRetryTimer($){this.retryTimer=setTimeout(()=>{Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),this.retryTimer=null,this.requestState({state:"connecting"})},$)}cancelRetryTimer(){if(this.retryTimer)clearTimeout(this.retryTimer),this.retryTimer=null}startWebSocketSlowTimer(){this.webSocketSlowTimer=setTimeout(()=>{if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket slow timer","checking connectivity"),this.checkWsConnectivity().then(()=>{Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket slow timer","ws connectivity check succeeded"),this.wsCheckResult=!0}).catch(()=>{Q.logAction(this.logger,Q.LOG_MAJOR,"ConnectionManager WebSocket slow timer","ws connectivity check failed"),this.wsCheckResult=!1}),this.realtime.http.checkConnectivity)j0(this.realtime.http.checkConnectivity(),($,w)=>{if($||!w)Q.logAction(this.logger,Q.LOG_MAJOR,"ConnectionManager WebSocket slow timer","http connectivity check failed"),this.cancelWebSocketGiveUpTimer(),this.notifyState({state:"disconnected",error:new D("Unable to connect (network unreachable)",80003,404)});else Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket slow timer","http connectivity check succeeded")})},this.options.timeouts.webSocketSlowTimeout)}cancelWebSocketSlowTimer(){if(this.webSocketSlowTimer)clearTimeout(this.webSocketSlowTimer),this.webSocketSlowTimer=null}startWebSocketGiveUpTimer($){this.webSocketGiveUpTimer=setTimeout(()=>{var w,Z;if(!this.wsCheckResult)if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket give up timer","websocket connection took more than 10s; "+(this.baseTransport?"trying base transport":"")),this.baseTransport)this.abandonedWebSocket=!0,(w=this.proposedTransport)==null||w.dispose(),(Z=this.pendingTransport)==null||Z.dispose(),this.connectBase($,++this.connectCounter);else Q.logAction(this.logger,Q.LOG_MAJOR,"ConnectionManager WebSocket give up timer","websocket connectivity appears to be unavailable but no other transports to try")},this.options.timeouts.webSocketConnectTimeout)}cancelWebSocketGiveUpTimer(){if(this.webSocketGiveUpTimer)clearTimeout(this.webSocketGiveUpTimer),this.webSocketGiveUpTimer=null}notifyState($){var w,Z;let G=$.state,X=G==="disconnected"&&(this.state===this.states.connected||$.retryImmediately||this.state===this.states.connecting&&$.error&&d0.isTokenErr($.error)&&!(this.errorReason&&d0.isTokenErr(this.errorReason)));if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+G+(X?"; will retry connection immediately":"")),G==this.state.state)return;if(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.checkSuspendTimer($.state),G==="suspended"||G==="connected")this.disconnectedRetryCount=0;if(this.state.terminal)return;let U=this.states[$.state],O=U.retryDelay;if(U.state==="disconnected")this.disconnectedRetryCount++,O=T8(U.retryDelay,this.disconnectedRetryCount);let F=new lq(this.state.state,U.state,O,$.error||((Z=(w=O1)[U.state])==null?void 0:Z.call(w)));if(X){let z=()=>{if(this.state===this.states.disconnected)this.lastAutoReconnectAttempt=Date.now(),this.requestState({state:"connecting"})},I=this.lastAutoReconnectAttempt&&Date.now()-this.lastAutoReconnectAttempt+1;if(I&&I<1000)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+I+"ms ago, waiting another "+(1000-I)+"ms before trying again"),setTimeout(z,1000-I);else B.Config.nextTick(z)}else if(G==="disconnected"||G==="suspended")this.startRetryTimer(O);if(G==="disconnected"&&!X||G==="suspended"||U.terminal)B.Config.nextTick(()=>{this.disconnectAllTransports()});if(G=="connected"&&!this.activeProtocol)Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol");if(this.enactStateChange(F),this.state.sendEvents)this.sendQueuedMessages();else if(!this.state.queueEvents)this.realtime.channels.propogateConnectionInterruption(G,F.reason),this.failQueuedMessages(F.reason)}requestState($){var w,Z;let G=$.state;if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+G+"; current state: "+this.state.state),G==this.state.state)return;if(this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(G),G=="connecting"&&this.state.state=="connected")return;if(G=="closing"&&this.state.state=="closed")return;let X=this.states[G],U=new lq(this.state.state,X.state,null,$.error||((Z=(w=O1)[X.state])==null?void 0:Z.call(w)));if(this.enactStateChange(U),G=="connecting")B.Config.nextTick(()=>{this.startConnect()});if(G=="closing")this.closeImpl()}startConnect(){if(this.state!==this.states.connecting){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state);return}let $=this.realtime.auth,w=++this.connectCounter,Z=()=>{this.checkConnectionStateFreshness(),this.getTransportParams((G)=>{if(G.mode==="recover"&&G.options.recover){let X=a8(G.options.recover);if(X)this.realtime.channels.recoverChannels(X.channelSerials)}if(w!==this.connectCounter)return;this.connectImpl(G,w)})};if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),$.method==="basic")Z();else{let G=(X)=>{if(w!==this.connectCounter)return;if(X)this.actOnErrorFromAuthorize(X);else Z()};if(this.errorReason&&d0.isTokenErr(this.errorReason))j0($._forceNewToken(null,null),G);else j0($._ensureValidAuthCredentials(!1),G)}}connectImpl($,w){let Z=this.state.state;if(Z!==this.states.connecting.state){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect, but was "+Z);return}let G=this.getTransportPreference();if(G&&G===this.baseTransport&&this.webSocketTransportAvailable)this.checkWsConnectivity().then(()=>{if(this.unpersistTransportPreference(),this.state===this.states.connecting)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.connectImpl():","web socket connectivity available, cancelling connection attempt with "+this.baseTransport),this.disconnectAllTransports(),this.connectWs($,++this.connectCounter)}).catch(c7);if(G&&G===this.baseTransport||this.baseTransport&&!this.webSocketTransportAvailable)this.connectBase($,w);else this.connectWs($,w)}connectWs($,w){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.connectWs()"),this.wsCheckResult=null,this.abandonedWebSocket=!1,this.startWebSocketSlowTimer(),this.startWebSocketGiveUpTimer($),this.tryTransportWithFallbacks("web_socket",$,!0,w,()=>{return this.wsCheckResult!==!1&&!this.abandonedWebSocket})}connectBase($,w){if(Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.connectBase()"),this.baseTransport)this.tryTransportWithFallbacks(this.baseTransport,$,!1,w,()=>!0);else this.notifyState({state:"disconnected",error:new D("No transports left to try",80000,404)})}tryTransportWithFallbacks($,w,Z,G,X){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.tryTransportWithFallbacks()",$);let U=(j)=>{this.notifyState({state:this.states.connecting.failState,error:j})},O=this.domains.slice(),F=(j,A)=>{if(G!==this.connectCounter)return;if(!X()){if(A)A.dispose();return}if(!A&&!j)I()},z=O.shift();if(!z){U(new D("Unable to connect (no available host)",80003,404));return}w.host=z;let I=()=>{if(!O.length){U(new D("Unable to connect (and no more fallback hosts to try)",80003,404));return}if(!this.realtime.http.checkConnectivity){U(new o("Internal error: Http.checkConnectivity not set",null,500));return}j0(this.realtime.http.checkConnectivity(),(j,A)=>{if(G!==this.connectCounter)return;if(!X())return;if(j){U(j);return}if(!A){U(new D("Unable to connect (network unreachable)",80003,404));return}w.host=_8(O),this.tryATransport(w,$,F)})};if(this.forceFallbackHost&&O.length){this.forceFallbackHost=!1,I();return}this.tryATransport(w,$,F)}closeImpl(){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),this.pendingTransport)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+this.pendingTransport),this.pendingTransport.close();if(this.activeProtocol)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close();this.notifyState({state:"closed"})}onAuthUpdated($,w){var Z;switch(this.state.state){case"connected":{Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport");let G=(Z=this.activeProtocol)==null?void 0:Z.getTransport();if(G&&G.onAuthUpdated)G.onAuthUpdated($);let X=L0({action:C.AUTH,auth:{accessToken:$.token}});this.send(X);let U=()=>{this.off(O),w(null,$)},O=(F)=>{if(F.current==="failed")this.off(U),this.off(O),w(F.reason||this.getStateError())};this.once("connectiondetails",U),this.on("connectionstate",O);break}case"connecting":Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:{Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");let G=(X)=>{switch(X.current){case"connected":this.off(G),w(null,$);break;case"failed":case"closed":case"suspended":this.off(G),w(X.reason||this.getStateError());break;default:break}};if(this.on("connectionstate",G),this.state.state==="connecting")this.startConnect();else this.requestState({state:"connecting"})}}}disconnectAllTransports(){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"),this.connectCounter++,this.pendingTransport)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+this.pendingTransport),this.pendingTransport.disconnect();if(delete this.pendingTransport,this.proposedTransport)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting proposed transport: "+this.pendingTransport),this.proposedTransport.disconnect();if(delete this.pendingTransport,this.activeProtocol)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect()}send($,w,Z){Z=Z||c7;let G=this.state;if(G.sendEvents){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new E7($,Z));return}if(!(w&&G.queueEvents)){let U="rejecting event, queueEvent was "+w+", state was "+G.state;Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.send()",U),Z(this.errorReason||new D(U,90000,400));return}if(this.logger.shouldLog(Q.LOG_MICRO))Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+d8($,this.realtime._RealtimePresence,this.realtime._Annotations,this.realtime._objectsPlugin));this.queue($,Z)}sendImpl($){let w=$.message;if($.ackRequired&&!$.sendAttempted)w.msgSerial=this.msgSerial++;try{this.activeProtocol.send($)}catch(Z){Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+Z.stack)}}queue($,w){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.queue()","queueing event");let Z=this.queuedMessages.last(),G=this.options.maxMessageSize;if(Z&&!Z.sendAttempted&&s4(Z.message,$,G)){if(!Z.merged)Z.callback=P8.create(this.logger,[Z.callback]),Z.merged=!0;Z.callback.push(w)}else this.queuedMessages.push(new E7($,w))}sendQueuedMessages(){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");let $;while($=this.queuedMessages.shift())this.sendImpl($)}queuePendingMessages($){if($&&$.length)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+$.length+" pending messages"),this.queuedMessages.prepend($)}failQueuedMessages($){let w=this.queuedMessages.count();if(w>0)Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+w+" queued messages, err = "+w0($)),this.queuedMessages.completeAllMessages($)}onChannelMessage($,w){if(this.pendingChannelMessagesState.queue.push({message:$,transport:w}),!this.pendingChannelMessagesState.isProcessing)this.processNextPendingChannelMessage()}processNextPendingChannelMessage(){if(this.pendingChannelMessagesState.queue.length>0){this.pendingChannelMessagesState.isProcessing=!0;let $=this.pendingChannelMessagesState.queue.shift();this.processChannelMessage($.message).catch((w)=>{Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.processNextPendingChannelMessage() received error ",w)}).finally(()=>{this.pendingChannelMessagesState.isProcessing=!1,this.processNextPendingChannelMessage()})}}async processChannelMessage($){await this.realtime.channels.processChannelMessage($)}async ping(){var $;if(this.state.state!=="connected")throw new D("Unable to ping service; not connected",40000,400);let w=($=this.activeProtocol)==null?void 0:$.getTransport();if(!w)throw this.getStateError();Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.ping()","transport = "+w);let Z=Date.now(),G=iq();return T$(new Promise((X)=>{let U=(O)=>{if(O===G)w.off("heartbeat",U),X(Date.now()-Z)};w.on("heartbeat",U),w.ping(G)}),this.options.timeouts.realtimeRequestTimeout,"Timeout waiting for heartbeat response")}abort($){this.activeProtocol.getTransport().fail($)}getTransportPreference(){var $,w;return this.transportPreference||l8()&&((w=($=B.WebStorage)==null?void 0:$.get)==null?void 0:w.call($,r8))}persistTransportPreference($){var w,Z;if(this.transportPreference=$.shortName,l8())(Z=(w=B.WebStorage)==null?void 0:w.set)==null||Z.call(w,r8,$.shortName)}unpersistTransportPreference(){var $,w;if(this.transportPreference=null,l8())(w=($=B.WebStorage)==null?void 0:$.remove)==null||w.call($,r8)}actOnErrorFromAuthorize($){if($.code===40171)this.notifyState({state:"failed",error:$});else if($.code===40102)this.notifyState({state:"failed",error:$});else if($.statusCode===xq.Forbidden)Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()","Client configured authentication provider returned 403; failing the connection"),this.notifyState({state:"failed",error:new D("Client configured authentication provider returned 403; failing the connection",80019,403,$)});else Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize","Client configured authentication provider request failed"),this.notifyState({state:this.state.failState,error:new D("Client configured authentication provider request failed",80019,401,$)})}onConnectionDetailsUpdate($,w){if(!$)return;if(this.connectionDetails=$,$.maxMessageSize)this.options.maxMessageSize=$.maxMessageSize;let Z=$.clientId;if(Z){let X=this.realtime.auth._uncheckedSetClientId(Z);if(X){Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",X.message),w.fail(X);return}}let G=$.connectionStateTtl;if(G)this.connectionStateTtl=G;this.maxIdleInterval=$.maxIdleInterval,this.emit("connectiondetails",$)}checkWsConnectivity(){let $=this.options.wsConnectivityCheckUrl||k.wsConnectivityCheckUrl,w=new B.Config.WebSocket($);return new Promise((Z,G)=>{let X=!1;w.onopen=()=>{if(!X)X=!0,Z(),w.close()},w.onclose=w.onerror=()=>{if(!X)X=!0,G()}})}sessionRecoveryName(){return this.options.recoveryKeyStorageName||"ably-connection-recovery"}getSessionRecoverData(){var $,w;return qq()&&((w=($=B.WebStorage)==null?void 0:$.getSession)==null?void 0:w.call($,this.sessionRecoveryName()))}setSessionRecoverData($){var w,Z;return qq()&&((Z=(w=B.WebStorage)==null?void 0:w.setSession)==null?void 0:Z.call(w,this.sessionRecoveryName(),$))}clearSessionRecoverData(){var $,w;return qq()&&((w=($=B.WebStorage)==null?void 0:$.removeSession)==null?void 0:w.call($,this.sessionRecoveryName()))}},P7=q2,$2=class extends V0{constructor(q,$){super(q.logger);this.whenState=(w)=>{return V0.prototype.whenState.call(this,w,this.state)},this.ably=q,this.connectionManager=new P7(q,$),this.state=this.connectionManager.state.state,this.key=void 0,this.id=void 0,this.errorReason=null,this.connectionManager.on("connectionstate",(w)=>{let Z=this.state=w.current;B.Config.nextTick(()=>{this.emit(Z,w)})}),this.connectionManager.on("update",(w)=>{B.Config.nextTick(()=>{this.emit("update",w)})})}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})}async ping(){return Q.logAction(this.logger,Q.LOG_MINOR,"Connection.ping()",""),this.connectionManager.ping()}close(){Q.logAction(this.logger,Q.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})}get recoveryKey(){return this.logger.deprecationWarning("The `Connection.recoveryKey` attribute has been replaced by the `Connection.createRecoveryKey()` method. Replace your usage of `recoveryKey` with the return value of `createRecoveryKey()`. `recoveryKey` will be removed in a future version."),this.createRecoveryKey()}createRecoveryKey(){return this.connectionManager.createRecoveryKey()}},w2=$2,C7=class q extends $7{constructor($){var w,Z,G,X;super(k.objectifyOptions($,!1,"BaseRealtime",Q.defaultLogger));if(Q.logAction(this.logger,Q.LOG_MINOR,"Realtime()",""),typeof EdgeRuntime==="string")throw new D(`Ably.Realtime instance cannot be used in Vercel Edge runtime. If you are running Vercel Edge functions, please replace your "new Ably.Realtime()" with "new Ably.Rest()" and use Ably Rest API instead of the Realtime API. If you are server-rendering your application in the Vercel Edge runtime, please use the condition "if (typeof EdgeRuntime === 'string')" to prevent instantiating Ably.Realtime instance during SSR in the Vercel Edge runtime.`,40000,400);if(this._additionalTransportImplementations=q.transportImplementationsFromPlugins(this.options.plugins),this._RealtimePresence=(Z=(w=this.options.plugins)==null?void 0:w.RealtimePresence)!=null?Z:null,this._objectsPlugin=(X=(G=this.options.plugins)==null?void 0:G.Objects)!=null?X:null,this.connection=new w2(this,this.options),this._channels=new W2(this),this.options.autoConnect!==!1)this.connect()}static transportImplementationsFromPlugins($){let w={};if($==null?void 0:$.WebSocketTransport)w[M0.WebSocket]=$.WebSocketTransport;if($==null?void 0:$.XHRPolling)w[M0.XhrPolling]=$.XHRPolling;return w}get channels(){return this._channels}get clientId(){return this.auth.clientId}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()}close(){Q.logAction(this.logger,Q.LOG_MINOR,"Realtime.close()",""),this.connection.close()}};C7.EventEmitter=V0;var u2=C7,W2=class extends V0{constructor(q){super(q.logger);this.realtime=q,this.all=Object.create(null),q.connection.connectionManager.on("transport.active",()=>{this.onTransportActive()})}channelSerials(){let q={};for(let $ of l1(this.all,!0)){let w=this.all[$];if(w.properties.channelSerial)q[$]=w.properties.channelSerial}return q}recoverChannels(q){for(let $ of l1(q,!0)){let w=this.get($);w.properties.channelSerial=q[$]}}async processChannelMessage(q){let $=q.channel;if($===void 0){Q.logAction(this.logger,Q.LOG_ERROR,"Channels.processChannelMessage()","received event unspecified channel, action = "+q.action);return}let w=this.all[$];if(!w){Q.logAction(this.logger,Q.LOG_ERROR,"Channels.processChannelMessage()","received event for non-existent channel: "+$);return}await w.processMessage(q)}onTransportActive(){for(let q in this.all){let $=this.all[q];if($.state==="attaching"||$.state==="detaching")$.checkPendingState();else if($.state==="suspended")$._attach(!1,null);else if($.state==="attached")$.requestState("attaching")}}propogateConnectionInterruption(q,$){let w={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"},Z=["attaching","attached","detaching","suspended"],G=w[q];for(let X in this.all){let U=this.all[X];if(Z.includes(U.state))U.notifyState(G,$)}}get(q,$){q=String(q);let w=this.all[q];if(!w)w=this.all[q]=new e1(this.realtime,q,$);else if($){if(w._shouldReattachToSetOptions($,w.channelOptions))throw new D("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",40000,400);w.setOptions($)}return w}getDerived(q,$,w){if($.filter){let Z=gq($.filter),G=b$(q);q=`[filter=${Z}${G.qualifierParam}]${G.channelName}`}return this.get(q,w)}release(q){q=String(q);let $=this.all[q];if(!$)return;let w=$.getReleaseErr();if(w)throw w;delete this.all[q]}},Z2=u2;function G2(q,$){if(q.isSynthesized()||$.isSynthesized())return q.timestamp>=$.timestamp;let w=q.parseId(),Z=$.parseId();if(w.msgSerial===Z.msgSerial)return w.index>Z.index;else return w.msgSerial>Z.msgSerial}var s8=class extends V0{constructor(q,$,w=G2){super(q.logger);this.presence=q,this.map=Object.create(null),this.syncInProgress=!1,this.residualMembers=null,this.memberKey=$,this.newerThan=w}get(q){return this.map[q]}getClient(q){let $=this.map,w=[];for(let Z in $){let G=$[Z];if(G.clientId==q&&G.action!="absent")w.push(G)}return w}list(q){let $=this.map,w=q&&q.clientId,Z=q&&q.connectionId,G=[];for(let X in $){let U=$[X];if(U.action==="absent")continue;if(w&&w!=U.clientId)continue;if(Z&&Z!=U.connectionId)continue;G.push(U)}return G}put(q){if(q.action==="enter"||q.action==="update")q=t0.fromValues(q),q.action="present";let $=this.map,w=this.memberKey(q);if(this.residualMembers)delete this.residualMembers[w];let Z=$[w];if(Z&&!this.newerThan(q,Z))return!1;return $[w]=q,!0}values(){let q=this.map,$=[];for(let w in q){let Z=q[w];if(Z.action!="absent")$.push(Z)}return $}remove(q){let $=this.map,w=this.memberKey(q),Z=$[w];if(Z&&!this.newerThan(q,Z))return!1;if(this.syncInProgress)q=t0.fromValues(q),q.action="absent",$[w]=q;else delete $[w];return!!Z}startSync(){let q=this.map,$=this.syncInProgress;if(Q.logAction(this.logger,Q.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+$),!this.syncInProgress)this.residualMembers=B1(q),this.setInProgress(!0)}endSync(){let q=this.map,$=this.syncInProgress;if(Q.logAction(this.logger,Q.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+$),$){for(let w in q)if(q[w].action==="absent")delete q[w];this.presence._synthesizeLeaves(F$(this.residualMembers));for(let w in this.residualMembers)delete q[w];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")}waitSync(q){let $=this.syncInProgress;if(Q.logAction(this.logger,Q.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+$),!$){q();return}this.once("sync",q)}clear(){this.map={},this.setInProgress(!1),this.residualMembers=null}setInProgress(q){Q.logAction(this.logger,Q.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+q),this.syncInProgress=q,this.presence.syncComplete=!q}};function N2(q){return q.channel.client.auth.clientId}function e8(q){let $=q.channel.client,w=$.auth.clientId;return(!w||w==="*")&&$.connection.state==="connected"}function J2(q,$,w){switch(q.state){case"attached":case"suspended":w();break;case"initialized":case"detached":case"detaching":case"attaching":j0(q.attach(),function(Z){if(Z)$(Z);else w()});break;default:$(D.fromValues(q.invalidStateError()))}}var X2=class extends V0{constructor(q){super(q.logger);this.channel=q,this.syncComplete=!1,this.members=new s8(this,($)=>$.clientId+":"+$.connectionId),this._myMembers=new s8(this,($)=>$.clientId),this.subscriptions=new V0(this.logger),this.pendingPresence=[]}async enter(q){if(e8(this))throw new D("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,void 0,q,"enter")}async update(q){if(e8(this))throw new D("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,void 0,q,"update")}async enterClient(q,$){return this._enterOrUpdateClient(void 0,q,$,"enter")}async updateClient(q,$){return this._enterOrUpdateClient(void 0,q,$,"update")}async _enterOrUpdateClient(q,$,w,Z){let G=this.channel;if(!G.connectionManager.activeState())throw G.connectionManager.getError();Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence."+Z+"Client()","channel = "+G.name+", id = "+q+", client = "+($||"(implicit) "+N2(this)));let X=t0.fromData(w);if(X.action=Z,q)X.id=q;if($)X.clientId=$;let U=await X.encode(G.channelOptions);switch(G.state){case"attached":return G.sendPresence([U]);case"initialized":case"detached":G.attach();case"attaching":return new Promise((O,F)=>{this.pendingPresence.push({presence:U,callback:(z)=>z?F(z):O()})});default:{let O=new o("Unable to "+Z+" presence channel while in "+G.state+" state",90001);throw O.code=90001,O}}}async leave(q){if(e8(this))throw new D("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,q)}async leaveClient(q,$){let w=this.channel;if(!w.connectionManager.activeState())throw w.connectionManager.getError();Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+q);let Z=t0.fromData($);if(Z.action="leave",q)Z.clientId=q;let G=await Z.encode(w.channelOptions);switch(w.state){case"attached":return w.sendPresence([G]);case"attaching":return new Promise((X,U)=>{this.pendingPresence.push({presence:G,callback:(O)=>O?U(O):X()})});case"initialized":case"failed":throw new o("Unable to leave presence channel (incompatible state)",90001);default:throw w.invalidStateError()}}async get(q){let $=!q||("waitForSync"in q?q.waitForSync:!0);return new Promise((w,Z)=>{function G(X){w(q?X.list(q):X.values())}if(this.channel.state==="suspended"){if($)Z(D.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"}));else G(this.members);return}J2(this.channel,(X)=>Z(X),()=>{let X=this.members;if($)X.waitSync(function(){G(X)});else G(X)})})}async history(q){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name);let $=this.channel.client.rest.presenceMixin;if(q&&q.untilAttach)if(this.channel.state==="attached")delete q.untilAttach,q.from_serial=this.channel.properties.attachSerial;else throw new D("option untilAttach requires the channel to be attached, was: "+this.channel.state,40000,400);return $.history(this,q)}setPresence(q,$,w){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+q.length+" participants; syncChannelSerial = "+w);let Z,G,X=this.members,U=this._myMembers,O=[],F=this.channel.connectionManager.connectionId;if($){if(this.members.startSync(),w&&(G=w.match(/^[\w-]+:(.*)$/)))Z=G[1]}for(let z of q)switch(z.action){case"leave":if(X.remove(z))O.push(z);if(z.connectionId===F&&!z.isSynthesized())U.remove(z);break;case"enter":case"present":case"update":if(X.put(z))O.push(z);if(z.connectionId===F)U.put(z);break}if($&&!Z)X.endSync(),this.channel.syncChannelSerial=null;for(let z=0;z<O.length;z++){let I=O[z];this.subscriptions.emit(I.action,I)}}onAttached(q){if(Q.logAction(this.logger,Q.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+q),q)this.members.startSync();else this._synthesizeLeaves(this.members.values()),this.members.clear();this._ensureMyMembersPresent();let $=this.pendingPresence,w=$.length;if(w){this.pendingPresence=[];let Z=[],G=P8.create(this.logger);Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.onAttached","sending "+w+" queued presence messages");for(let X=0;X<w;X++){let U=$[X];Z.push(U.presence),G.push(U.callback)}this.channel.sendPresence(Z).then(()=>G()).catch((X)=>G(X))}}actOnChannelState(q,$,w){switch(q){case"attached":this.onAttached($);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(w);break}}failPendingPresence(q){if(this.pendingPresence.length){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+w0(q));for(let $=0;$<this.pendingPresence.length;$++)try{this.pendingPresence[$].callback(q)}catch(w){}this.pendingPresence=[]}}_clearMyMembers(){this._myMembers.clear()}_ensureMyMembersPresent(){let q=this._myMembers,$=this.channel.connectionManager.connectionId;for(let w in q.map){let Z=q.map[w];Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+Z.clientId+'" into the presence set');let G=Z.connectionId===$?Z.id:void 0;this._enterOrUpdateClient(G,Z.clientId,Z.data,"enter").catch((X)=>{let U=new D("Presence auto re-enter failed",91004,400,X);Q.logAction(this.logger,Q.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()","Presence auto re-enter failed; reason = "+w0(X));let O=new f8(this.channel.state,this.channel.state,!0,!1,U);this.channel.emit("update",O)})}}_synthesizeLeaves(q){let $=this.subscriptions;q.forEach(function(w){let Z=t0.fromValues({action:"leave",connectionId:w.connectionId,clientId:w.clientId,data:w.data,encoding:w.encoding,timestamp:Date.now()});$.emit("leave",Z)})}async subscribe(...q){let $=e1.processListenerArgs(q),w=$[0],Z=$[1],G=this.channel;if(G.state==="failed")throw D.fromValues(G.invalidStateError());if(this.subscriptions.on(w,Z),G.channelOptions.attachOnSubscribe!==!1)await G.attach()}unsubscribe(...q){let $=e1.processListenerArgs(q),w=$[0],Z=$[1];this.subscriptions.off(w,Z)}},Q2=X2,H2=M0.WebSocket;function U2(q){return!!q.on}var K2=class extends _1{constructor(q,$,w){super(q,$,w);this.shortName=H2,w.heartbeats=B.Config.useProtocolHeartbeats,this.wsHost=w.host}static isAvailable(){return!!B.Config.WebSocket}createWebSocket(q,$){return this.uri=q+r1($),new B.Config.WebSocket(this.uri)}toString(){return"WebSocketTransport; uri="+this.uri}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.connect()","starting"),_1.prototype.connect.call(this);let q=this,$=this.params,w=$.options,G=(w.tls?"wss://":"ws://")+this.wsHost+":"+k.getPort(w)+"/";Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.connect()","uri: "+G),j0(this.auth.getAuthParams(),function(X,U){if(q.isDisposed)return;let O="";for(let z in U)O+=" "+z+": "+U[z]+";";if(Q.logAction(q.logger,Q.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+O+" err: "+X),X){q.disconnect(X);return}let F=$.getConnectParams(U);try{let z=q.wsConnection=q.createWebSocket(G,F);if(z.binaryType=B.Config.binaryType,z.onopen=function(){q.onWsOpen()},z.onclose=function(I){q.onWsClose(I)},z.onmessage=function(I){q.onWsData(I.data)},z.onerror=function(I){q.onWsError(I)},U2(z))z.on("ping",function(){q.onActivity()})}catch(z){Q.logAction(q.logger,Q.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(z.stack||z.message)),q.disconnect(z)}})}send(q){let $=this.wsConnection;if(!$){Q.logAction(this.logger,Q.LOG_ERROR,"WebSocketTransport.send()","No socket connection");return}try{$.send(C4(q,this.connectionManager.realtime._MsgPack,this.params.format))}catch(w){let Z="Exception from ws connection when trying to send: "+w0(w);Q.logAction(this.logger,Q.LOG_ERROR,"WebSocketTransport.send()",Z),this.finish("disconnected",new D(Z,50000,500))}}onWsData(q){Q.logAction(this.logger,Q.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+q.length+"; type = "+typeof q);try{this.onProtocolMessage(k4(q,this.connectionManager.realtime._MsgPack,this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin,this.format))}catch($){Q.logAction(this.logger,Q.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+$.stack)}}onWsOpen(){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("preconnect")}onWsClose(q){let $,w;if(typeof q=="object")w=q.code,$=q.wasClean||w===1000;else w=q,$=w==1000;if(delete this.wsConnection,$){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket");let Z=new D("Websocket closed",80003,400);this.finish("disconnected",Z)}else{let Z="Unclean disconnection of WebSocket ; code = "+w,G=new D(Z,80003,400);Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onWsClose()",Z),this.finish("disconnected",G)}this.emit("disposed")}onWsError(q){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+q.message),B.Config.nextTick(()=>{this.disconnect(Error(q.message))})}dispose(){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;let q=this.wsConnection;if(q)q.onmessage=function(){},delete this.wsConnection,B.Config.nextTick(()=>{if(Q.logAction(this.logger,Q.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),!q)throw Error("WebSocketTransport.dispose(): wsConnection is not defined");q.close()})}},k7=K2,O2=class{static subscribeFilter(q,$,w){let Z=(G)=>{var X,U,O,F,z,I;let j={name:G.name,refTimeserial:(U=(X=G.extras)==null?void 0:X.ref)==null?void 0:U.timeserial,refType:(F=(O=G.extras)==null?void 0:O.ref)==null?void 0:F.type,isRef:!!((I=(z=G.extras)==null?void 0:z.ref)==null?void 0:I.timeserial),clientId:G.clientId};if(Object.entries($).find(([A,M])=>M!==void 0?j[A]!==M:!1))return;w(G)};this.addFilteredSubscription(q,$,w,Z),q.subscriptions.on(Z)}static addFilteredSubscription(q,$,w,Z){var G;if(!q.filteredSubscriptions)q.filteredSubscriptions=new Map;if(q.filteredSubscriptions.has(w)){let X=q.filteredSubscriptions.get(w);X.set($,((G=X==null?void 0:X.get($))==null?void 0:G.concat(Z))||[Z])}else q.filteredSubscriptions.set(w,new Map([[$,[Z]]]))}static getAndDeleteFilteredSubscriptions(q,$,w){if(!q.filteredSubscriptions)return[];if(!w&&$)return Array.from(q.filteredSubscriptions.entries()).map(([X,U])=>{var O;let F=U.get($);if(U.delete($),U.size===0)(O=q.filteredSubscriptions)==null||O.delete(X);return F}).reduce((X,U)=>U?X.concat(...U):X,[]);if(!w||!q.filteredSubscriptions.has(w))return[];let Z=q.filteredSubscriptions.get(w);if(!$){let X=Array.from(Z.values()).reduce((U,O)=>U.concat(...O),[]);return q.filteredSubscriptions.delete(w),X}let G=Z.get($);return Z.delete($),G||[]}},E0=class q extends Z2{constructor($){var w;let Z=q._MsgPack;if(!Z)throw Error("Expected DefaultRealtime._MsgPack to have been set");super(k.objectifyOptions($,!0,"Realtime",Q.defaultLogger,E(_({},h7),{Crypto:(w=q.Crypto)!=null?w:void 0,MsgPack:Z,RealtimePresence:{RealtimePresence:Q2,PresenceMessage:t0,WirePresenceMessage:a1},Annotations:{Annotation:R1,WireAnnotation:L1,RealtimeAnnotations:m8,RestAnnotations:mq},WebSocketTransport:k7,MessageInteractions:O2})))}static get Crypto(){if(this._Crypto===null)throw Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto($){this._Crypto=$}};E0.Utils=z0,E0.ConnectionManager=P7,E0.ProtocolMessage=n4,E0._Crypto=null,E0.Message=D7,E0.PresenceMessage=B7,E0.Annotation=A7,E0._MsgPack=null,E0._Http=n8,E0._PresenceMap=s8,E0._MessageEncoding=dq;var q5=E0,$5=Uint8Array,$q=Uint32Array,w5=Math.pow,n7=new $q(8),y7=[],wq=new $q(64);function i7(q){return(q-(q|0))*w5(2,32)|0}var uq=2,Wq=0;while(Wq<64){u5=!0;for(rq=2;rq<=uq/2;rq++)if(uq%rq===0)u5=!1;if(u5){if(Wq<8)n7[Wq]=i7(w5(uq,0.5));y7[Wq]=i7(w5(uq,0.3333333333333333)),Wq++}uq++}var u5,rq,V2=!!new $5(new $q([1]).buffer)[0];function W5(q){if(V2)return q>>>24|(q>>>16&255)<<8|(q&65280)<<8|q<<24;else return q}function g0(q,$){return q>>>$|q<<32-$}function aq(q){var $=n7.slice(),w=q.length,Z=w*8,G=512-(Z+64)%512-1+Z+65,X=new $5(G/8),U=new $q(X.buffer);X.set(q,0),X[w]=128,U[U.length-1]=W5(Z);var O;for(var F=0;F<G/32;F+=16){var z=$.slice();for(O=0;O<64;O++){var I;if(O<16)I=W5(U[F+O]);else{var j=wq[O-15],A=wq[O-2];I=wq[O-7]+wq[O-16]+(g0(j,7)^g0(j,18)^j>>>3)+(g0(A,17)^g0(A,19)^A>>>10)}wq[O]=I|=0;var M=(g0(z[4],6)^g0(z[4],11)^g0(z[4],25))+(z[4]&z[5]^~z[4]&z[6])+z[7]+I+y7[O],c=(g0(z[0],2)^g0(z[0],13)^g0(z[0],22))+(z[0]&z[1]^z[2]&(z[0]^z[1]));for(var T=7;T>0;T--)z[T]=z[T-1];z[0]=M+c|0,z[4]=z[4]+M|0}for(O=0;O<8;O++)$[O]=$[O]+z[O]|0}return new $5(new $q($.map(function(x){return W5(x)})).buffer)}function z2(q,$){if(q.length>64)q=aq(q);if(q.length<64){let O=new Uint8Array(64);O.set(q,0),q=O}var w=new Uint8Array(64),Z=new Uint8Array(64);for(var G=0;G<64;G++)w[G]=54^q[G],Z[G]=92^q[G];var X=new Uint8Array($.length+64);X.set(w,0),X.set($,64);var U=new Uint8Array(96);return U.set(Z,0),U.set(aq(X),64),aq(U)}var F2=class{constructor(){this.base64CharSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this.hexCharSet="0123456789abcdef"}uint8ViewToBase64(q){let $="",w=this.base64CharSet,Z=q.byteLength,G=Z%3,X=Z-G,U,O,F,z,I;for(let j=0;j<X;j=j+3)I=q[j]<<16|q[j+1]<<8|q[j+2],U=(I&16515072)>>18,O=(I&258048)>>12,F=(I&4032)>>6,z=I&63,$+=w[U]+w[O]+w[F]+w[z];if(G==1)I=q[X],U=(I&252)>>2,O=(I&3)<<4,$+=w[U]+w[O]+"==";else if(G==2)I=q[X]<<8|q[X+1],U=(I&64512)>>10,O=(I&1008)>>4,F=(I&15)<<2,$+=w[U]+w[O]+w[F]+"=";return $}base64ToArrayBuffer(q){let $=atob==null?void 0:atob(q),w=$.length,Z=new Uint8Array(w);for(let G=0;G<w;G++){let X=$.charCodeAt(G);Z[G]=X}return this.toArrayBuffer(Z)}isBuffer(q){return q instanceof ArrayBuffer||ArrayBuffer.isView(q)}toBuffer(q){if(!ArrayBuffer)throw Error("Can't convert to Buffer: browser does not support the necessary types");if(q instanceof ArrayBuffer)return new Uint8Array(q);if(ArrayBuffer.isView(q))return new Uint8Array(this.toArrayBuffer(q));throw Error("BufferUtils.toBuffer expected an ArrayBuffer or a view onto one")}toArrayBuffer(q){if(!ArrayBuffer)throw Error("Can't convert to ArrayBuffer: browser does not support the necessary types");if(q instanceof ArrayBuffer)return q;if(ArrayBuffer.isView(q))return q.buffer.slice(q.byteOffset,q.byteOffset+q.byteLength);throw Error("BufferUtils.toArrayBuffer expected an ArrayBuffer or a view onto one")}base64Encode(q){return this.uint8ViewToBase64(this.toBuffer(q))}base64UrlEncode(q){return this.base64Encode(q).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}base64Decode(q){if(ArrayBuffer&&B.Config.atob)return this.base64ToArrayBuffer(q);else throw Error("Expected ArrayBuffer to exist and Platform.Config.atob to be configured")}hexEncode(q){return this.toBuffer(q).reduce((w,Z)=>w+Z.toString(16).padStart(2,"0"),"")}hexDecode(q){if(q.length%2!==0)throw Error("Can't create a byte array from a hex string of odd length");let $=new Uint8Array(q.length/2);for(let w=0;w<$.length;w++)$[w]=parseInt(q.slice(2*w,2*(w+1)),16);return this.toArrayBuffer($)}utf8Encode(q){if(B.Config.TextEncoder){let $=new B.Config.TextEncoder().encode(q);return this.toArrayBuffer($)}else throw Error("Expected TextEncoder to be configured")}utf8Decode(q){if(!this.isBuffer(q))throw Error("Expected input of utf8decode to be an arraybuffer or typed array");if(TextDecoder)return new TextDecoder().decode(q);else throw Error("Expected TextDecoder to be configured")}areBuffersEqual(q,$){if(!q||!$)return!1;let w=this.toArrayBuffer(q),Z=this.toArrayBuffer($);if(w.byteLength!=Z.byteLength)return!1;let G=new Uint8Array(w),X=new Uint8Array(Z);for(var U=0;U<G.length;U++)if(G[U]!=X[U])return!1;return!0}byteLength(q){if(q instanceof ArrayBuffer||ArrayBuffer.isView(q))return q.byteLength;return-1}arrayBufferViewToBuffer(q){return this.toArrayBuffer(q)}concat(q){let $=q.reduce((G,X)=>G+X.byteLength,0),w=new Uint8Array($),Z=0;for(let G of q){let X=this.toBuffer(G);w.set(X,Z),Z+=X.byteLength}return w.buffer}sha256(q){let $=aq(this.toBuffer(q));return this.toArrayBuffer($)}hmacSha256(q,$){let w=z2(this.toBuffer($),this.toBuffer(q));return this.toArrayBuffer(w)}},g7=new F2,h2=function(q,$){var w="aes",Z=256,G="cbc",X=16;function U(A){if(A.algorithm==="aes"&&A.mode==="cbc"){if(A.keyLength===128||A.keyLength===256)return;throw Error("Unsupported key length "+A.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)")}}function O(A){return A.replace("_","/").replace("-","+")}function F(A){return A instanceof z}class z{constructor(A,M,c,T){this.algorithm=A,this.keyLength=M,this.mode=c,this.key=T}}class I{static getDefaultParams(A){var M;if(!A.key)throw Error("Crypto.getDefaultParams: a key is required");if(typeof A.key==="string")M=$.toArrayBuffer($.base64Decode(O(A.key)));else if(A.key instanceof ArrayBuffer)M=A.key;else M=$.toArrayBuffer(A.key);var c=A.algorithm||w,T=M.byteLength*8,x=A.mode||G,t=new z(c,T,x,M);if(A.keyLength&&A.keyLength!==t.keyLength)throw Error("Crypto.getDefaultParams: a keyLength of "+A.keyLength+" was specified, but the key actually has length "+t.keyLength);return U(t),t}static async generateRandomKey(A){try{return q.getRandomArrayBuffer((A||Z)/8)}catch(M){throw new D("Failed to generate random key: "+M.message,400,50000,M)}}static getCipher(A,M){var c,T=F(A)?A:this.getDefaultParams(A);return{cipherParams:T,cipher:new j(T,(c=A.iv)!=null?c:null,M)}}}I.CipherParams=z;class j{constructor(A,M,c){if(this.logger=c,!crypto.subtle)if(isSecureContext)throw Error("Crypto operations are not possible since the browser’s SubtleCrypto class is unavailable (reason unknown).");else throw Error("Crypto operations are is not possible since the current environment is a non-secure context and hence the browser’s SubtleCrypto class is not available.");this.algorithm=A.algorithm+"-"+String(A.keyLength)+"-"+A.mode,this.webCryptoAlgorithm=A.algorithm+"-"+A.mode,this.key=$.toArrayBuffer(A.key),this.iv=M?$.toArrayBuffer(M):null}concat(A,M){let c=new ArrayBuffer(A.byteLength+M.byteLength),T=new DataView(c),x=new DataView($.toArrayBuffer(A));for(let l=0;l<x.byteLength;l++)T.setInt8(l,x.getInt8(l));let t=new DataView($.toArrayBuffer(M));for(let l=0;l<t.byteLength;l++)T.setInt8(x.byteLength+l,t.getInt8(l));return c}async encrypt(A){Q.logAction(this.logger,Q.LOG_MICRO,"CBCCipher.encrypt()","");let M=await this.getIv(),c=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["encrypt"]),T=await crypto.subtle.encrypt({name:this.webCryptoAlgorithm,iv:M},c,A);return this.concat(M,T)}async decrypt(A){Q.logAction(this.logger,Q.LOG_MICRO,"CBCCipher.decrypt()","");let M=$.toArrayBuffer(A),c=M.slice(0,X),T=M.slice(X),x=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["decrypt"]);return crypto.subtle.decrypt({name:this.webCryptoAlgorithm,iv:c},x,T)}async getIv(){if(this.iv){var A=this.iv;return this.iv=null,A}let M=await q.getRandomArrayBuffer(X);return $.toArrayBuffer(M)}}return I},p7=((q)=>{return q[q.REQ_SEND=0]="REQ_SEND",q[q.REQ_RECV=1]="REQ_RECV",q[q.REQ_RECV_POLL=2]="REQ_RECV_POLL",q[q.REQ_RECV_STREAM=3]="REQ_RECV_STREAM",q})(p7||{}),m0=p7;function v7(){return new D("No HTTP request plugin provided. Provide at least one of the FetchRequest or XHRRequest plugins.",400,40000)}var Zq,x7=(Zq=class{constructor(q){this.checksInProgress=null,this.checkConnectivity=void 0,this.supportsAuthHeaders=!1,this.supportsLinkHeaders=!1;var $;this.client=q!=null?q:null;let w=(q==null?void 0:q.options.connectivityCheckUrl)||k.connectivityCheckUrl,Z=($=q==null?void 0:q.options.connectivityCheckParams)!=null?$:null,G=!(q==null?void 0:q.options.connectivityCheckUrl),X=_(_({},x7.bundledRequestImplementations),q==null?void 0:q._additionalHTTPRequestImplementations),U=X.XHRRequest,O=X.FetchRequest,F=!!(U||O);if(!F)throw v7();if(B.Config.xhrSupported&&U)if(this.supportsAuthHeaders=!0,this.Request=async function(z,I,j,A,M){return new Promise((c)=>{var T;let x=U.createRequest(I,j,A,M,m0.REQ_SEND,(T=q&&q.options.timeouts)!=null?T:null,this.logger,z);x.once("complete",(t,l,D0,y,R0)=>c({error:t,body:l,headers:D0,unpacked:y,statusCode:R0})),x.exec()})},q==null?void 0:q.options.disableConnectivityCheck)this.checkConnectivity=async function(){return!0};else this.checkConnectivity=async function(){var z;Q.logAction(this.logger,Q.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Sending; "+w);let I=await this.doUri(U0.Get,w,null,null,Z),j=!1;if(!G)j=!I.error&&yu(I.statusCode);else j=!I.error&&((z=I.body)==null?void 0:z.replace(/\n/,""))=="yes";return Q.logAction(this.logger,Q.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Result: "+j),j};else if(B.Config.fetchSupported&&O)if(this.supportsAuthHeaders=!0,this.Request=async(z,I,j,A,M)=>{return O(z,q!=null?q:null,I,j,A,M)},q==null?void 0:q.options.disableConnectivityCheck)this.checkConnectivity=async function(){return!0};else this.checkConnectivity=async function(){var z;Q.logAction(this.logger,Q.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Sending; "+w);let I=await this.doUri(U0.Get,w,null,null,null),j=!I.error&&((z=I.body)==null?void 0:z.replace(/\n/,""))=="yes";return Q.logAction(this.logger,Q.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Result: "+j),j};else this.Request=async()=>{return{error:F?new o("no supported HTTP transports available",null,400):v7()}}}get logger(){var q,$;return($=(q=this.client)==null?void 0:q.logger)!=null?$:Q.defaultLogger}async doUri(q,$,w,Z,G){if(!this.Request)return{error:new o("Request invoked before assigned to",null,500)};return this.Request(q,$,w,G,Z)}shouldFallback(q){let $=q.statusCode;return $===408&&!q.code||$===400&&!q.code||$>=500&&$<=504}},Zq.methods=[U0.Get,U0.Delete,U0.Post,U0.Put,U0.Patch],Zq.methodsWithoutBody=[U0.Get,U0.Delete],Zq.methodsWithBody=[U0.Post,U0.Put,U0.Patch],Zq),d7=x7,b1="ablyjs-storage-test",S1=typeof global<"u"?global:typeof window<"u"?window:self,D2=class{constructor(){try{S1.sessionStorage.setItem(b1,b1),S1.sessionStorage.removeItem(b1),this.sessionSupported=!0}catch(q){this.sessionSupported=!1}try{S1.localStorage.setItem(b1,b1),S1.localStorage.removeItem(b1),this.localSupported=!0}catch(q){this.localSupported=!1}}get(q){return this._get(q,!1)}getSession(q){return this._get(q,!0)}remove(q){return this._remove(q,!1)}removeSession(q){return this._remove(q,!0)}set(q,$,w){return this._set(q,$,w,!1)}setSession(q,$,w){return this._set(q,$,w,!0)}_set(q,$,w,Z){let G={value:$};if(w)G.expires=Date.now()+w;return this.storageInterface(Z).setItem(q,JSON.stringify(G))}_get(q,$){if($&&!this.sessionSupported)throw Error("Session Storage not supported");if(!$&&!this.localSupported)throw Error("Local Storage not supported");let w=this.storageInterface($).getItem(q);if(!w)return null;let Z=JSON.parse(w);if(Z.expires&&Z.expires<Date.now())return this.storageInterface($).removeItem(q),null;return Z.value}_remove(q,$){return this.storageInterface($).removeItem(q)}storageInterface(q){return q?S1.sessionStorage:S1.localStorage}},t7=new D2,K0=E8(),B2=typeof EdgeRuntime==="string";if(typeof Window>"u"&&typeof WorkerGlobalScope>"u"&&!B2)console.log("Warning: this distribution of Ably is intended for browsers. On nodejs, please use the 'ably' package on npm");function Y2(){let q=K0.location;return!K0.WebSocket||!q||!q.origin||q.origin.indexOf("http")>-1}function I2(){if(typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope)return!0;else return!1}var j2=K0.navigator&&K0.navigator.userAgent.toString(),A2=K0.location&&K0.location.href,M2={agent:"browser",logTimestamps:!0,userAgent:j2,currentUrl:A2,binaryType:"arraybuffer",WebSocket:K0.WebSocket,fetchSupported:!!K0.fetch,xhrSupported:K0.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,allowComet:Y2(),useProtocolHeartbeats:!0,supportsBinary:!!K0.TextDecoder,preferBinary:!1,ArrayBuffer:K0.ArrayBuffer,atob:K0.atob,nextTick:typeof K0.queueMicrotask==="function"?(q)=>K0.queueMicrotask(q):(q)=>Promise.resolve().then(q),addEventListener:K0.addEventListener,inspect:JSON.stringify,stringByteSize:function(q){return K0.TextDecoder&&new K0.TextEncoder().encode(q).length||q.length},TextEncoder:K0.TextEncoder,TextDecoder:K0.TextDecoder,getRandomArrayBuffer:async function(q){let $=new Uint8Array(q);return K0.crypto.getRandomValues($),$.buffer},isWebworker:I2(),push:{platform:"browser",formFactor:"desktop",storage:t7}},f7=M2;function L2(q){let $=[80015,80017,80030];if(q.code){if(d0.isTokenErr(q))return!1;if($.includes(q.code))return!0;return q.code>=40000&&q.code<50000}else return!1}function Z5(q){if(L2(q))return[L0({action:C.ERROR,error:q})];else return[L0({action:C.DISCONNECTED,error:q})]}var R2=class extends _1{constructor(q,$,w){super(q,$,w,!0);this.onAuthUpdated=(Z)=>{this.authParams={access_token:Z.token}},this.stream="stream"in w?w.stream:!0,this.sendRequest=null,this.recvRequest=null,this.pendingCallback=null,this.pendingItems=null}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.connect()","starting"),_1.prototype.connect.call(this);let q=this.params,$=q.options,w=q.host||$.primaryDomain,Z=k.getPort($),G=$.tls?"https://":"http://";this.baseUri=G+w+":"+Z+"/comet/";let X=this.baseUri+"connect";Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.connect()","uri: "+X),j0(this.auth.getAuthParams(),(U,O)=>{if(U){this.disconnect(U);return}if(this.isDisposed)return;this.authParams=O;let F=this.params.getConnectParams(O);if("stream"in F)this.stream=F.stream;Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.connect()","connectParams:"+r1(F));let z=!1,I=this.recvRequest=this.createRequest(X,null,F,null,this.stream?m0.REQ_RECV_STREAM:m0.REQ_RECV);I.on("data",(j)=>{if(!this.recvRequest)return;if(!z)z=!0,this.emit("preconnect");this.onData(j)}),I.on("complete",(j)=>{if(!this.recvRequest)j=j||new D("Request cancelled",80003,400);if(this.recvRequest=null,!z&&!j)z=!0,this.emit("preconnect");if(this.onActivity(),j){if(j.code)this.onData(Z5(j));else this.disconnect(j);return}B.Config.nextTick(()=>{this.recv()})}),I.exec()})}requestClose(){Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)}requestDisconnect(){Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)}_requestCloseOrDisconnect(q){let $=q?this.closeUri:this.disconnectUri;if($){let w=this.createRequest($,null,this.authParams,null,m0.REQ_SEND);w.on("complete",(Z)=>{if(Z)Q.logAction(this.logger,Q.LOG_ERROR,"CometTransport.request"+(q?"Close()":"Disconnect()"),"request returned err = "+w0(Z)),this.finish("disconnected",Z)}),w.exec()}}dispose(){if(Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.dispose()",""),!this.isDisposed){if(this.isDisposed=!0,this.recvRequest)Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null;this.finish("disconnected",O1.disconnected()),B.Config.nextTick(()=>{this.emit("disposed")})}}onConnect(q){var $;if(this.isDisposed)return;let w=($=q.connectionDetails)==null?void 0:$.connectionKey;_1.prototype.onConnect.call(this,q);let Z=this.baseUri+w;Q.logAction(this.logger,Q.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+Z),this.sendUri=Z+"/send",this.recvUri=Z+"/recv",this.closeUri=Z+"/close",this.disconnectUri=Z+"/disconnect"}send(q){if(this.sendRequest){this.pendingItems=this.pendingItems||[],this.pendingItems.push(q);return}let $=this.pendingItems||[];$.push(q),this.pendingItems=null,this.sendItems($)}sendAnyPending(){let q=this.pendingItems;if(!q)return;this.pendingItems=null,this.sendItems(q)}sendItems(q){let $=this.sendRequest=this.createRequest(this.sendUri,null,this.authParams,this.encodeRequest(q),m0.REQ_SEND);$.on("complete",(w,Z)=>{if(w)Q.logAction(this.logger,Q.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+w0(w));if(this.sendRequest=null,w){if(w.code)this.onData(Z5(w));else this.disconnect(w);return}if(Z)this.onData(Z);if(this.pendingItems)B.Config.nextTick(()=>{if(!this.sendRequest)this.sendAnyPending()})}),$.exec()}recv(){if(this.recvRequest)return;if(!this.isConnected)return;let q=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,this.stream?m0.REQ_RECV_STREAM:m0.REQ_RECV_POLL);q.on("data",($)=>{this.onData($)}),q.on("complete",($)=>{if(this.recvRequest=null,this.onActivity(),$){if($.code)this.onData(Z5($));else this.disconnect($);return}B.Config.nextTick(()=>{this.recv()})}),q.exec()}onData(q){try{let $=this.decodeResponse(q);if($&&$.length)for(let w=0;w<$.length;w++)this.onProtocolMessage(x8($[w],this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin))}catch($){Q.logAction(this.logger,Q.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+$.stack)}}encodeRequest(q){return JSON.stringify(q)}decodeResponse(q){if(typeof q=="string")return JSON.parse(q);return q}},_2=R2;function b2(q,$){return S8(l1($)).includes("x-ably-errorcode")}function S2(q,$){if(b2(q,$))return q.error&&D.fromValues(q.error)}var T2=function(){},E2=0,m7={};function c2(q,$){return q.getResponseHeader&&q.getResponseHeader($)}function P2(q){return q.getResponseHeader&&(q.getResponseHeader("transfer-encoding")||!q.getResponseHeader("content-length"))}function C2(q){let $=q.getAllResponseHeaders().trim().split(`\r
`),w={};for(let Z=0;Z<$.length;Z++){let G=$[Z].split(":").map((X)=>X.trim());w[G[0].toLowerCase()]=G[1]}return w}var k2=class q extends V0{constructor($,w,Z,G,X,U,O,F){super(O);Z=Z||{},Z.rnd=iq(),this.uri=$+r1(Z),this.headers=w||{},this.body=G,this.method=F?F.toUpperCase():c0(G)?"GET":"POST",this.requestMode=X,this.timeouts=U,this.timedOut=!1,this.requestComplete=!1,this.id=String(++E2),m7[this.id]=this}static createRequest($,w,Z,G,X,U,O,F){let z=U||k.TIMEOUTS;return new q($,w,B1(Z),G,X,z,O,F)}complete($,w,Z,G,X){if(!this.requestComplete){if(this.requestComplete=!0,!$&&w)this.emit("data",w);this.emit("complete",$,w,Z,G,X),this.dispose()}}abort(){this.dispose()}exec(){let $=this.headers,w=this.requestMode==m0.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,Z=this.timer=setTimeout(()=>{this.timedOut=!0,X.abort()},w),G=this.method,X=this.xhr=new XMLHttpRequest,U=$.accept,O=this.body,F="text";if(!U)$.accept="application/json";else if(U.indexOf("application/x-msgpack")===0)F="arraybuffer";if(O){if(($["content-type"]||($["content-type"]="application/json")).indexOf("application/json")>-1&&typeof O!="string")O=JSON.stringify(O)}if(X.open(G,this.uri,!0),X.responseType=F,"authorization"in $)X.withCredentials=!0;for(let y in $)X.setRequestHeader(y,$[y]);let z=(y,R0,B0,Xq)=>{var T1;let X5=R0+" (event type: "+y.type+")";if((T1=this==null?void 0:this.xhr)==null?void 0:T1.statusText)X5+=", current statusText is "+this.xhr.statusText;Q.logAction(this.logger,Q.LOG_ERROR,"Request.on"+y.type+"()",X5),this.complete(new o(X5,B0,Xq))};X.onerror=(y)=>{z(y,"XHR error occurred",null,400)},X.onabort=(y)=>{if(this.timedOut)z(y,"Request aborted due to request timeout expiring",null,408);else z(y,"Request cancelled",null,400)},X.ontimeout=(y)=>{z(y,"Request timed out",null,408)};let I,j,A,M=0,c=!1,T=()=>{if(clearTimeout(Z),A=j<400,j==204){this.complete(null,null,null,null,j);return}I=this.requestMode==m0.REQ_RECV_STREAM&&A&&P2(X)},x=()=>{let y;try{let B0=c2(X,"content-type");if(B0?B0.indexOf("application/json")>=0:X.responseType=="text"){let T1=X.responseType==="arraybuffer"?B.BufferUtils.utf8Decode(X.response):String(X.responseText);if(T1.length)y=JSON.parse(T1);else y=T1;c=!0}else y=X.response;if(y.response!==void 0)j=y.statusCode,A=j<400,$=y.headers,y=y.response;else $=C2(X)}catch(B0){this.complete(new o("Malformed response body from server: "+B0.message,null,400));return}if(A||Array.isArray(y)){this.complete(null,y,$,c,j);return}let R0=S2(y,$);if(!R0)R0=new o("Error response received from server: "+j+" body was: "+B.Config.inspect(y),null,j);this.complete(R0,y,$,c,j)};function t(){let y=X.responseText,R0=y.length-1,B0,Xq;while(M<R0&&(B0=y.indexOf(`
`,M))>-1)Xq=y.slice(M,B0),M=B0+1,l(Xq)}let l=(y)=>{try{y=JSON.parse(y)}catch(R0){this.complete(new o("Malformed response body from server: "+R0.message,null,400));return}this.emit("data",y)},D0=()=>{t(),this.streamComplete=!0,B.Config.nextTick(()=>{this.complete()})};X.onreadystatechange=()=>{let y=X.readyState;if(y<3)return;if(X.status!==0){if(j===void 0)j=X.status,T();if(y==3&&I)t();else if(y==4)if(I)D0();else x()}},X.send(O)}dispose(){let $=this.xhr;if($){$.onreadystatechange=$.onerror=$.onabort=$.ontimeout=T2,this.xhr=null;let w=this.timer;if(w)clearTimeout(w),this.timer=null;if(!this.requestComplete)$.abort()}delete m7[this.id]}},o7=k2,l7=M0.XhrPolling,n2=class extends _2{constructor(q,$,w){super(q,$,w);this.shortName=l7,w.stream=!1,this.shortName=l7}static isAvailable(){return!!(B.Config.xhrSupported&&B.Config.allowComet)}toString(){return"XHRPollingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected}createRequest(q,$,w,Z,G){return o7.createRequest(q,$,w,Z,G,this.timeouts,this.logger)}},y2=n2,i2=["xhr_polling"],g2={order:i2,bundledImplementations:{web_socket:k7,xhr_polling:y2}},p2=g2,v2={connectivityCheckUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",wsConnectivityCheckUrl:"wss://ws-up.ably-realtime.com",defaultTransports:[M0.XhrPolling,M0.WebSocket]},x2=v2;function d2(q){if(q===void 0)return"undefined";let $,w;if(q instanceof ArrayBuffer)w="ArrayBuffer",$=new DataView(q);else if(q instanceof DataView)w="DataView",$=q;if(!$)return JSON.stringify(q);let Z=[];for(let G=0;G<q.byteLength;G++){if(G>20){Z.push("...");break}let X=$.getUint8(G).toString(16);if(X.length===1)X="0"+X;Z.push(X)}return"<"+w+" "+Z.join(" ")+">"}function Gq(q,$,w){for(let Z=0,G=w.length;Z<G;Z++){let X=w.charCodeAt(Z);if(X<128){q.setUint8($++,X>>>0&127|0);continue}if(X<2048){q.setUint8($++,X>>>6&31|192),q.setUint8($++,X>>>0&63|128);continue}if(X<65536){q.setUint8($++,X>>>12&15|224),q.setUint8($++,X>>>6&63|128),q.setUint8($++,X>>>0&63|128);continue}if(X<1114112){q.setUint8($++,X>>>18&7|240),q.setUint8($++,X>>>12&63|128),q.setUint8($++,X>>>6&63|128),q.setUint8($++,X>>>0&63|128);continue}throw Error("bad codepoint "+X)}}function r7(q,$,w){let Z="";for(let G=$,X=$+w;G<X;G++){let U=q.getUint8(G);if((U&128)===0){Z+=String.fromCharCode(U);continue}if((U&224)===192){Z+=String.fromCharCode((U&15)<<6|q.getUint8(++G)&63);continue}if((U&240)===224){Z+=String.fromCharCode((U&15)<<12|(q.getUint8(++G)&63)<<6|(q.getUint8(++G)&63)<<0);continue}if((U&248)===240){Z+=String.fromCharCode((U&7)<<18|(q.getUint8(++G)&63)<<12|(q.getUint8(++G)&63)<<6|(q.getUint8(++G)&63)<<0);continue}throw Error("Invalid byte "+U.toString(16))}return Z}function G5(q){let $=0;for(let w=0,Z=q.length;w<Z;w++){let G=q.charCodeAt(w);if(G<128){$+=1;continue}if(G<2048){$+=2;continue}if(G<65536){$+=3;continue}if(G<1114112){$+=4;continue}throw Error("bad codepoint "+G)}return $}function t2(q,$){let w=Jq(q,$);if(w===0)return;let Z=new ArrayBuffer(w),G=new DataView(Z);return Nq(q,G,0,$),Z}var N5=4294967296,a7=1/N5;function f2(q,$){return $=$||0,q.getInt32($)*N5+q.getUint32($+4)}function m2(q,$){return $=$||0,q.getUint32($)*N5+q.getUint32($+4)}function o2(q,$,w){if(w<9223372036854776000)q.setInt32($,Math.floor(w*a7)),q.setInt32($+4,w&-1);else q.setUint32($,2147483647),q.setUint32($+4,2147483647)}function l2(q,$,w){if(w<18446744073709552000)q.setUint32($,Math.floor(w*a7)),q.setInt32($+4,w&-1);else q.setUint32($,4294967295),q.setUint32($+4,4294967295)}var r2=class{constructor(q,$){this.map=(w)=>{let Z={};for(let G=0;G<w;G++){let X=this.parse();Z[X]=this.parse()}return Z},this.bin=(w)=>{let Z=new ArrayBuffer(w);return new Uint8Array(Z).set(new Uint8Array(this.view.buffer,this.offset,w),0),this.offset+=w,Z},this.buf=this.bin,this.str=(w)=>{let Z=r7(this.view,this.offset,w);return this.offset+=w,Z},this.array=(w)=>{let Z=Array(w);for(let G=0;G<w;G++)Z[G]=this.parse();return Z},this.ext=(w)=>{return this.offset+=w,{type:this.view.getInt8(this.offset),data:this.buf(w)}},this.parse=()=>{let w=this.view.getUint8(this.offset),Z,G;if((w&128)===0)return this.offset++,w;if((w&240)===128)return G=w&15,this.offset++,this.map(G);if((w&240)===144)return G=w&15,this.offset++,this.array(G);if((w&224)===160)return G=w&31,this.offset++,this.str(G);if((w&224)===224)return Z=this.view.getInt8(this.offset),this.offset++,Z;switch(w){case 192:return this.offset++,null;case 193:this.offset++;return;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return G=this.view.getUint8(this.offset+1),this.offset+=2,this.bin(G);case 197:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.bin(G);case 198:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.bin(G);case 199:return G=this.view.getUint8(this.offset+1),this.offset+=2,this.ext(G);case 200:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.ext(G);case 201:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.ext(G);case 202:return Z=this.view.getFloat32(this.offset+1),this.offset+=5,Z;case 203:return Z=this.view.getFloat64(this.offset+1),this.offset+=9,Z;case 204:return Z=this.view.getUint8(this.offset+1),this.offset+=2,Z;case 205:return Z=this.view.getUint16(this.offset+1),this.offset+=3,Z;case 206:return Z=this.view.getUint32(this.offset+1),this.offset+=5,Z;case 207:return Z=m2(this.view,this.offset+1),this.offset+=9,Z;case 208:return Z=this.view.getInt8(this.offset+1),this.offset+=2,Z;case 209:return Z=this.view.getInt16(this.offset+1),this.offset+=3,Z;case 210:return Z=this.view.getInt32(this.offset+1),this.offset+=5,Z;case 211:return Z=f2(this.view,this.offset+1),this.offset+=9,Z;case 212:return G=1,this.offset++,this.ext(G);case 213:return G=2,this.offset++,this.ext(G);case 214:return G=4,this.offset++,this.ext(G);case 215:return G=8,this.offset++,this.ext(G);case 216:return G=16,this.offset++,this.ext(G);case 217:return G=this.view.getUint8(this.offset+1),this.offset+=2,this.str(G);case 218:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.str(G);case 219:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.str(G);case 220:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.array(G);case 221:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.array(G);case 222:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.map(G);case 223:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.map(G)}throw Error("Unknown type 0x"+w.toString(16))},this.offset=$||0,this.view=q}};function a2(q){let $=new DataView(q),w=new r2($),Z=w.parse();if(w.offset!==q.byteLength)throw Error(q.byteLength-w.offset+" trailing bytes");return Z}function s7(q,$){return Object.keys(q).filter(function(w){let Z=q[w];return(!$||Z!==void 0&&Z!==null)&&(typeof Z!=="function"||!!Z.toJSON)})}function Nq(q,$,w,Z){let G=typeof q;if(typeof q==="string"){let X=G5(q);if(X<32)return $.setUint8(w,X|160),Gq($,w+1,q),1+X;if(X<256)return $.setUint8(w,217),$.setUint8(w+1,X),Gq($,w+2,q),2+X;if(X<65536)return $.setUint8(w,218),$.setUint16(w+1,X),Gq($,w+3,q),3+X;if(X<4294967296)return $.setUint8(w,219),$.setUint32(w+1,X),Gq($,w+5,q),5+X}if(ArrayBuffer.isView&&ArrayBuffer.isView(q))q=q.buffer;if(q instanceof ArrayBuffer){let X=q.byteLength;if(X<256)return $.setUint8(w,196),$.setUint8(w+1,X),new Uint8Array($.buffer).set(new Uint8Array(q),w+2),2+X;if(X<65536)return $.setUint8(w,197),$.setUint16(w+1,X),new Uint8Array($.buffer).set(new Uint8Array(q),w+3),3+X;if(X<4294967296)return $.setUint8(w,198),$.setUint32(w+1,X),new Uint8Array($.buffer).set(new Uint8Array(q),w+5),5+X}if(typeof q==="number"){if(Math.floor(q)!==q)return $.setUint8(w,203),$.setFloat64(w+1,q),9;if(q>=0){if(q<128)return $.setUint8(w,q),1;if(q<256)return $.setUint8(w,204),$.setUint8(w+1,q),2;if(q<65536)return $.setUint8(w,205),$.setUint16(w+1,q),3;if(q<4294967296)return $.setUint8(w,206),$.setUint32(w+1,q),5;if(q<18446744073709552000)return $.setUint8(w,207),l2($,w+1,q),9;throw Error("Number too big 0x"+q.toString(16))}if(q>=-32)return $.setInt8(w,q),1;if(q>=-128)return $.setUint8(w,208),$.setInt8(w+1,q),2;if(q>=-32768)return $.setUint8(w,209),$.setInt16(w+1,q),3;if(q>=-2147483648)return $.setUint8(w,210),$.setInt32(w+1,q),5;if(q>=-9223372036854776000)return $.setUint8(w,211),o2($,w+1,q),9;throw Error("Number too small -0x"+(-q).toString(16).substr(1))}if(G==="undefined"){if(Z)return 0;return $.setUint8(w,212),$.setUint8(w+1,0),$.setUint8(w+2,0),3}if(q===null){if(Z)return 0;return $.setUint8(w,192),1}if(G==="boolean")return $.setUint8(w,q?195:194),1;if(typeof q.toJSON==="function")return Nq(q.toJSON(),$,w,Z);if(G==="object"){let X,U=0,O,F=Array.isArray(q);if(F)X=q.length;else O=s7(q,Z),X=O.length;if(X<16)$.setUint8(w,X|(F?144:128)),U=1;else if(X<65536)$.setUint8(w,F?220:222),$.setUint16(w+1,X),U=3;else if(X<4294967296)$.setUint8(w,F?221:223),$.setUint32(w+1,X),U=5;if(F)for(let z=0;z<X;z++)U+=Nq(q[z],$,w+U,Z);else if(O)for(let z=0;z<X;z++){let I=O[z];U+=Nq(I,$,w+U),U+=Nq(q[I],$,w+U,Z)}return U}if(G==="function")return 0;throw Error("Unknown type "+G)}function Jq(q,$){let w=typeof q;if(w==="string"){let Z=G5(q);if(Z<32)return 1+Z;if(Z<256)return 2+Z;if(Z<65536)return 3+Z;if(Z<4294967296)return 5+Z}if(ArrayBuffer.isView&&ArrayBuffer.isView(q))q=q.buffer;if(q instanceof ArrayBuffer){let Z=q.byteLength;if(Z<256)return 2+Z;if(Z<65536)return 3+Z;if(Z<4294967296)return 5+Z}if(typeof q==="number"){if(Math.floor(q)!==q)return 9;if(q>=0){if(q<128)return 1;if(q<256)return 2;if(q<65536)return 3;if(q<4294967296)return 5;if(q<18446744073709552000)return 9;throw Error("Number too big 0x"+q.toString(16))}if(q>=-32)return 1;if(q>=-128)return 2;if(q>=-32768)return 3;if(q>=-2147483648)return 5;if(q>=-9223372036854776000)return 9;throw Error("Number too small -0x"+q.toString(16).substr(1))}if(w==="boolean")return 1;if(q===null)return $?0:1;if(q===void 0)return $?0:3;if(typeof q.toJSON==="function")return Jq(q.toJSON(),$);if(w==="object"){let Z,G=0;if(Array.isArray(q)){Z=q.length;for(let X=0;X<Z;X++)G+=Jq(q[X],$)}else{let X=s7(q,$);Z=X.length;for(let U=0;U<Z;U++){let O=X[U];G+=Jq(O)+Jq(q[O],$)}}if(Z<16)return 1+G;if(Z<65536)return 3+G;if(Z<4294967296)return 5+G;throw Error("Array or object too long 0x"+Z.toString(16))}if(w==="function")return 0;throw Error("Unknown type "+w)}var J5={encode:t2,decode:a2,inspect:d2,utf8Write:Gq,utf8Read:r7,utf8ByteCount:G5};function s2(q,$){return!!$.get("x-ably-errorcode")}function e2(q,$){if(s2(q,$))return q.error&&D.fromValues(q.error)}function q9(q){let $={};return q.forEach((w,Z)=>{$[Z]=w}),$}async function $9(q,$,w,Z,G,X){let U=new Headers(Z||{}),O=q?q.toUpperCase():c0(X)?"GET":"POST",F=new AbortController,z,I=new Promise((M)=>{z=setTimeout(()=>{F.abort(),M({error:new o("Request timed out",null,408)})},$?$.options.timeouts.httpRequestTimeout:k.TIMEOUTS.httpRequestTimeout)}),j={method:O,headers:U,body:X,signal:F.signal};if(!B.Config.isWebworker)j.credentials=U.has("authorization")?"include":"same-origin";let A=(async()=>{try{let M=new URLSearchParams(G||{});M.set("rnd",iq());let c=w+"?"+M,T=await E8().fetch(c,j);if(clearTimeout(z),T.status==204)return{error:null,statusCode:T.status};let x=T.headers.get("Content-Type"),t;if(x&&x.indexOf("application/x-msgpack")>-1)t=await T.arrayBuffer();else if(x&&x.indexOf("application/json")>-1)t=await T.json();else t=await T.text();let l=!!x&&x.indexOf("application/x-msgpack")===-1,D0=q9(T.headers);if(!T.ok)return{error:e2(t,T.headers)||new o("Error response received from server: "+T.status+" body was: "+B.Config.inspect(t),null,T.status),body:t,headers:D0,unpacked:l,statusCode:T.status};else return{error:null,body:t,headers:D0,unpacked:l,statusCode:T.status}}catch(M){return clearTimeout(z),{error:M}}})();return Promise.race([I,A])}var w9={XHRRequest:o7,FetchRequest:$9},e7=h2(f7,g7);B.Crypto=e7,B.BufferUtils=g7,B.Http=d7,B.Config=f7,B.Transports=p2,B.WebStorage=t7;for(let q of[o8,q5])q.Crypto=e7,q._MsgPack=J5;if(d7.bundledRequestImplementations=w9,Q.initLogHandlers(),B.Defaults=ku(x2),B.Config.agent)B.Defaults.agent+=" "+B.Config.agent;var u9={ErrorInfo:D,Rest:o8,Realtime:q5,msgpack:J5,makeProtocolMessageFromDeserialized:_7};if(typeof W.exports=="object"&&typeof u=="object"){var W9=(q,$,w,Z)=>{if($&&typeof $==="object"||typeof $==="function"){for(let G of Object.getOwnPropertyNames($))if(!Object.prototype.hasOwnProperty.call(q,G)&&G!==w)Object.defineProperty(q,G,{get:()=>$[G],enumerable:!(Z=Object.getOwnPropertyDescriptor($,G))||Z.enumerable})}return q};W.exports=W9(W.exports,u)}return W.exports})});var J6=e((DJ,N6)=>{N6.exports=function(){return typeof Promise==="function"&&Promise.prototype&&Promise.prototype.then}});var J1=e((RW)=>{var c5,LW=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];RW.getSymbolSize=function(W){if(!W)throw Error('"version" cannot be null or undefined');if(W<1||W>40)throw Error('"version" should be in range from 1 to 40');return W*4+17};RW.getSymbolTotalCodewords=function(W){return LW[W]};RW.getBCHDigit=function(u){let W=0;while(u!==0)W++,u>>>=1;return W};RW.setToSJISFunction=function(W){if(typeof W!=="function")throw Error('"toSJISFunc" is not a valid function.');c5=W};RW.isKanjiModeEnabled=function(){return typeof c5<"u"};RW.toSJIS=function(W){return c5(W)}});var D8=e((CW)=>{CW.L={bit:1};CW.M={bit:0};CW.Q={bit:3};CW.H={bit:2};function PW(u){if(typeof u!=="string")throw Error("Param is not a string");switch(u.toLowerCase()){case"l":case"low":return CW.L;case"m":case"medium":return CW.M;case"q":case"quartile":return CW.Q;case"h":case"high":return CW.H;default:throw Error("Unknown EC Level: "+u)}}CW.isValid=function(W){return W&&typeof W.bit<"u"&&W.bit>=0&&W.bit<4};CW.from=function(W,N){if(CW.isValid(W))return W;try{return PW(W)}catch(J){return N}}});var z6=e((IJ,V6)=>{function O6(){this.buffer=[],this.length=0}O6.prototype={get:function(u){let W=Math.floor(u/8);return(this.buffer[W]>>>7-u%8&1)===1},put:function(u,W){for(let N=0;N<W;N++)this.putBit((u>>>W-N-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(u){let W=Math.floor(this.length/8);if(this.buffer.length<=W)this.buffer.push(0);if(u)this.buffer[W]|=128>>>this.length%8;this.length++}};V6.exports=O6});var h6=e((jJ,F6)=>{function Eq(u){if(!u||u<1)throw Error("BitMatrix size must be defined and greater than 0");this.size=u,this.data=new Uint8Array(u*u),this.reservedBit=new Uint8Array(u*u)}Eq.prototype.set=function(u,W,N,J){let H=u*this.size+W;if(this.data[H]=N,J)this.reservedBit[H]=!0};Eq.prototype.get=function(u,W){return this.data[u*this.size+W]};Eq.prototype.xor=function(u,W,N){this.data[u*this.size+W]^=N};Eq.prototype.isReserved=function(u,W){return this.reservedBit[u*this.size+W]};F6.exports=Eq});var B6=e((yW)=>{var nW=J1().getSymbolSize;yW.getRowColCoords=function(W){if(W===1)return[];let N=Math.floor(W/7)+2,J=nW(W),H=J===145?26:Math.ceil((J-13)/(2*N-2))*2,K=[J-7];for(let V=1;V<N-1;V++)K[V]=K[V-1]-H;return K.push(6),K.reverse()};yW.getPositions=function(W){let N=[],J=yW.getRowColCoords(W),H=J.length;for(let K=0;K<H;K++)for(let V=0;V<H;V++){if(K===0&&V===0||K===0&&V===H-1||K===H-1&&V===0)continue;N.push([J[K],J[V]])}return N}});var Y6=e((pW)=>{var gW=J1().getSymbolSize;pW.getPositions=function(W){let N=gW(W);return[[0,0],[N-7,0],[0,N-7]]}});var R6=e((dW)=>{dW.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};var D1={N1:3,N2:3,N3:40,N4:10};dW.isValid=function(W){return W!=null&&W!==""&&!isNaN(W)&&W>=0&&W<=7};dW.from=function(W){return dW.isValid(W)?parseInt(W,10):void 0};dW.getPenaltyN1=function(W){let N=W.size,J=0,H=0,K=0,V=null,h=null;for(let Y=0;Y<N;Y++){H=K=0,V=h=null;for(let b=0;b<N;b++){let S=W.get(Y,b);if(S===V)H++;else{if(H>=5)J+=D1.N1+(H-5);V=S,H=1}if(S=W.get(b,Y),S===h)K++;else{if(K>=5)J+=D1.N1+(K-5);h=S,K=1}}if(H>=5)J+=D1.N1+(H-5);if(K>=5)J+=D1.N1+(K-5)}return J};dW.getPenaltyN2=function(W){let N=W.size,J=0;for(let H=0;H<N-1;H++)for(let K=0;K<N-1;K++){let V=W.get(H,K)+W.get(H,K+1)+W.get(H+1,K)+W.get(H+1,K+1);if(V===4||V===0)J++}return J*D1.N2};dW.getPenaltyN3=function(W){let N=W.size,J=0,H=0,K=0;for(let V=0;V<N;V++){H=K=0;for(let h=0;h<N;h++){if(H=H<<1&2047|W.get(V,h),h>=10&&(H===1488||H===93))J++;if(K=K<<1&2047|W.get(h,V),h>=10&&(K===1488||K===93))J++}}return J*D1.N3};dW.getPenaltyN4=function(W){let N=0,J=W.data.length;for(let K=0;K<J;K++)N+=W.data[K];return Math.abs(Math.ceil(N*100/J/5)-10)*D1.N4};function xW(u,W,N){switch(u){case dW.Patterns.PATTERN000:return(W+N)%2===0;case dW.Patterns.PATTERN001:return W%2===0;case dW.Patterns.PATTERN010:return N%3===0;case dW.Patterns.PATTERN011:return(W+N)%3===0;case dW.Patterns.PATTERN100:return(Math.floor(W/2)+Math.floor(N/3))%2===0;case dW.Patterns.PATTERN101:return W*N%2+W*N%3===0;case dW.Patterns.PATTERN110:return(W*N%2+W*N%3)%2===0;case dW.Patterns.PATTERN111:return(W*N%3+(W+N)%2)%2===0;default:throw Error("bad maskPattern:"+u)}}dW.applyMask=function(W,N){let J=N.size;for(let H=0;H<J;H++)for(let K=0;K<J;K++){if(N.isReserved(K,H))continue;N.xor(K,H,xW(W,K,H))}};dW.getBestMask=function(W,N){let J=Object.keys(dW.Patterns).length,H=0,K=1/0;for(let V=0;V<J;V++){N(V),dW.applyMask(V,W);let h=dW.getPenaltyN1(W)+dW.getPenaltyN2(W)+dW.getPenaltyN3(W)+dW.getPenaltyN4(W);if(dW.applyMask(V,W),h<K)K=h,H=V}return H}});var C5=e((mW)=>{var X1=D8(),B8=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],Y8=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];mW.getBlocksCount=function(W,N){switch(N){case X1.L:return B8[(W-1)*4+0];case X1.M:return B8[(W-1)*4+1];case X1.Q:return B8[(W-1)*4+2];case X1.H:return B8[(W-1)*4+3];default:return}};mW.getTotalCodewordsCount=function(W,N){switch(N){case X1.L:return Y8[(W-1)*4+0];case X1.M:return Y8[(W-1)*4+1];case X1.Q:return Y8[(W-1)*4+2];case X1.H:return Y8[(W-1)*4+3];default:return}}});var _6=e((rW)=>{var cq=new Uint8Array(512),I8=new Uint8Array(256);(function(){let W=1;for(let N=0;N<255;N++)if(cq[N]=W,I8[W]=N,W<<=1,W&256)W^=285;for(let N=255;N<512;N++)cq[N]=cq[N-255]})();rW.log=function(W){if(W<1)throw Error("log("+W+")");return I8[W]};rW.exp=function(W){return cq[W]};rW.mul=function(W,N){if(W===0||N===0)return 0;return cq[I8[W]+I8[N]]}});var S6=e((qZ)=>{var k5=_6();qZ.mul=function(W,N){let J=new Uint8Array(W.length+N.length-1);for(let H=0;H<W.length;H++)for(let K=0;K<N.length;K++)J[H+K]^=k5.mul(W[H],N[K]);return J};qZ.mod=function(W,N){let J=new Uint8Array(W);while(J.length-N.length>=0){let H=J[0];for(let V=0;V<N.length;V++)J[V]^=k5.mul(N[V],H);let K=0;while(K<J.length&&J[K]===0)K++;J=J.slice(K)}return J};qZ.generateECPolynomial=function(W){let N=new Uint8Array([1]);for(let J=0;J<W;J++)N=qZ.mul(N,new Uint8Array([1,k5.exp(J)]));return N}});var c6=e((SJ,E6)=>{var T6=S6();function n5(u){if(this.genPoly=void 0,this.degree=u,this.degree)this.initialize(this.degree)}n5.prototype.initialize=function(W){this.degree=W,this.genPoly=T6.generateECPolynomial(this.degree)};n5.prototype.encode=function(W){if(!this.genPoly)throw Error("Encoder not initialized");let N=new Uint8Array(W.length+this.degree);N.set(W);let J=T6.mod(N,this.genPoly),H=this.degree-J.length;if(H>0){let K=new Uint8Array(this.degree);return K.set(J,H),K}return J};E6.exports=n5});var y5=e((uZ)=>{uZ.isValid=function(W){return!isNaN(W)&&W>=1&&W<=40}});var i5=e((XZ)=>{var Pq="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";Pq=Pq.replace(/u/g,"\\u");var ZZ="(?:(?![A-Z0-9 $%*+\\-./:]|"+Pq+`)(?:.|[\r
]))+`;XZ.KANJI=new RegExp(Pq,"g");XZ.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g");XZ.BYTE=new RegExp(ZZ,"g");XZ.NUMERIC=new RegExp("[0-9]+","g");XZ.ALPHANUMERIC=new RegExp("[A-Z $%*+\\-./:]+","g");var GZ=new RegExp("^"+Pq+"$"),NZ=new RegExp("^[0-9]+$"),JZ=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");XZ.testKanji=function(W){return GZ.test(W)};XZ.testNumeric=function(W){return NZ.test(W)};XZ.testAlphanumeric=function(W){return JZ.test(W)}});var Q1=e((BZ)=>{var hZ=y5(),g5=i5();BZ.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]};BZ.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]};BZ.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]};BZ.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]};BZ.MIXED={bit:-1};BZ.getCharCountIndicator=function(W,N){if(!W.ccBits)throw Error("Invalid mode: "+W);if(!hZ.isValid(N))throw Error("Invalid version: "+N);if(N>=1&&N<10)return W.ccBits[0];else if(N<27)return W.ccBits[1];return W.ccBits[2]};BZ.getBestModeForData=function(W){if(g5.testNumeric(W))return BZ.NUMERIC;else if(g5.testAlphanumeric(W))return BZ.ALPHANUMERIC;else if(g5.testKanji(W))return BZ.KANJI;else return BZ.BYTE};BZ.toString=function(W){if(W&&W.id)return W.id;throw Error("Invalid mode")};BZ.isValid=function(W){return W&&W.bit&&W.ccBits};function DZ(u){if(typeof u!=="string")throw Error("Param is not a string");switch(u.toLowerCase()){case"numeric":return BZ.NUMERIC;case"alphanumeric":return BZ.ALPHANUMERIC;case"kanji":return BZ.KANJI;case"byte":return BZ.BYTE;default:throw Error("Unknown mode: "+u)}}BZ.from=function(W,N){if(BZ.isValid(W))return W;try{return DZ(W)}catch(J){return N}}});var i6=e((SZ)=>{var j8=J1(),LZ=C5(),C6=D8(),H1=Q1(),t5=y5(),k6=j8.getBCHDigit(7973);function RZ(u,W,N){for(let J=1;J<=40;J++)if(W<=SZ.getCapacity(J,N,u))return J;return}function n6(u,W){return H1.getCharCountIndicator(u,W)+4}function _Z(u,W){let N=0;return u.forEach(function(J){let H=n6(J.mode,W);N+=H+J.getBitsLength()}),N}function bZ(u,W){for(let N=1;N<=40;N++)if(_Z(u,N)<=SZ.getCapacity(N,W,H1.MIXED))return N;return}SZ.from=function(W,N){if(t5.isValid(W))return parseInt(W,10);return N};SZ.getCapacity=function(W,N,J){if(!t5.isValid(W))throw Error("Invalid QR Code version");if(typeof J>"u")J=H1.BYTE;let H=j8.getSymbolTotalCodewords(W),K=LZ.getTotalCodewordsCount(W,N),V=(H-K)*8;if(J===H1.MIXED)return V;let h=V-n6(J,W);switch(J){case H1.NUMERIC:return Math.floor(h/10*3);case H1.ALPHANUMERIC:return Math.floor(h/11*2);case H1.KANJI:return Math.floor(h/13);case H1.BYTE:default:return Math.floor(h/8)}};SZ.getBestVersionForData=function(W,N){let J,H=C6.from(N,C6.M);if(Array.isArray(W)){if(W.length>1)return bZ(W,H);if(W.length===0)return 1;J=W[0]}else J=W;return RZ(J.mode,J.getLength(),H)};SZ.getEncodedBits=function(W){if(!t5.isValid(W)||W<7)throw Error("Invalid QR Code version");let N=W<<12;while(j8.getBCHDigit(N)-k6>=0)N^=7973<<j8.getBCHDigit(N)-k6;return W<<12|N}});var p6=e((PZ)=>{var f5=J1(),g6=f5.getBCHDigit(1335);PZ.getEncodedBits=function(W,N){let J=W.bit<<3|N,H=J<<10;while(f5.getBCHDigit(H)-g6>=0)H^=1335<<f5.getBCHDigit(H)-g6;return(J<<10|H)^21522}});var x6=e((kJ,v6)=>{var kZ=Q1();function x1(u){this.mode=kZ.NUMERIC,this.data=u.toString()}x1.getBitsLength=function(W){return 10*Math.floor(W/3)+(W%3?W%3*3+1:0)};x1.prototype.getLength=function(){return this.data.length};x1.prototype.getBitsLength=function(){return x1.getBitsLength(this.data.length)};x1.prototype.write=function(W){let N,J,H;for(N=0;N+3<=this.data.length;N+=3)J=this.data.substr(N,3),H=parseInt(J,10),W.put(H,10);let K=this.data.length-N;if(K>0)J=this.data.substr(N),H=parseInt(J,10),W.put(H,K*3+1)};v6.exports=x1});var t6=e((nJ,d6)=>{var nZ=Q1(),m5=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function d1(u){this.mode=nZ.ALPHANUMERIC,this.data=u}d1.getBitsLength=function(W){return 11*Math.floor(W/2)+6*(W%2)};d1.prototype.getLength=function(){return this.data.length};d1.prototype.getBitsLength=function(){return d1.getBitsLength(this.data.length)};d1.prototype.write=function(W){let N;for(N=0;N+2<=this.data.length;N+=2){let J=m5.indexOf(this.data[N])*45;J+=m5.indexOf(this.data[N+1]),W.put(J,11)}if(this.data.length%2)W.put(m5.indexOf(this.data[N]),6)};d6.exports=d1});var m6=e((yJ,f6)=>{var yZ=Q1();function t1(u){if(this.mode=yZ.BYTE,typeof u==="string")this.data=new TextEncoder().encode(u);else this.data=new Uint8Array(u)}t1.getBitsLength=function(W){return W*8};t1.prototype.getLength=function(){return this.data.length};t1.prototype.getBitsLength=function(){return t1.getBitsLength(this.data.length)};t1.prototype.write=function(u){for(let W=0,N=this.data.length;W<N;W++)u.put(this.data[W],8)};f6.exports=t1});var l6=e((iJ,o6)=>{var iZ=Q1(),gZ=J1();function f1(u){this.mode=iZ.KANJI,this.data=u}f1.getBitsLength=function(W){return W*13};f1.prototype.getLength=function(){return this.data.length};f1.prototype.getBitsLength=function(){return f1.getBitsLength(this.data.length)};f1.prototype.write=function(u){let W;for(W=0;W<this.data.length;W++){let N=gZ.toSJIS(this.data[W]);if(N>=33088&&N<=40956)N-=33088;else if(N>=57408&&N<=60351)N-=49472;else throw Error("Invalid SJIS character: "+this.data[W]+`
Make sure your charset is UTF-8`);N=(N>>>8&255)*192+(N&255),u.put(N,13)}};o6.exports=f1});var r6=e((gJ,o5)=>{var Cq={single_source_shortest_paths:function(u,W,N){var J={},H={};H[W]=0;var K=Cq.PriorityQueue.make();K.push(W,0);var V,h,Y,b,S,_,E,$0,v;while(!K.empty()){V=K.pop(),h=V.value,b=V.cost,S=u[h]||{};for(Y in S)if(S.hasOwnProperty(Y)){if(_=S[Y],E=b+_,$0=H[Y],v=typeof H[Y]>"u",v||$0>E)H[Y]=E,K.push(Y,E),J[Y]=h}}if(typeof N<"u"&&typeof H[N]>"u"){var P=["Could not find a path from ",W," to ",N,"."].join("");throw Error(P)}return J},extract_shortest_path_from_predecessor_list:function(u,W){var N=[],J=W,H;while(J)N.push(J),H=u[J],J=u[J];return N.reverse(),N},find_path:function(u,W,N){var J=Cq.single_source_shortest_paths(u,W,N);return Cq.extract_shortest_path_from_predecessor_list(J,N)},PriorityQueue:{make:function(u){var W=Cq.PriorityQueue,N={},J;u=u||{};for(J in W)if(W.hasOwnProperty(J))N[J]=W[J];return N.queue=[],N.sorter=u.sorter||W.default_sorter,N},default_sorter:function(u,W){return u.cost-W.cost},push:function(u,W){var N={value:u,cost:W};this.queue.push(N),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};if(typeof o5<"u")o5.exports=Cq});var Wu=e((tZ)=>{var r=Q1(),e6=x6(),qu=t6(),$u=m6(),wu=l6(),kq=i5(),A8=J1(),pZ=r6();function a6(u){return unescape(encodeURIComponent(u)).length}function nq(u,W,N){let J=[],H;while((H=u.exec(N))!==null)J.push({data:H[0],index:H.index,mode:W,length:H[0].length});return J}function uu(u){let W=nq(kq.NUMERIC,r.NUMERIC,u),N=nq(kq.ALPHANUMERIC,r.ALPHANUMERIC,u),J,H;if(A8.isKanjiModeEnabled())J=nq(kq.BYTE,r.BYTE,u),H=nq(kq.KANJI,r.KANJI,u);else J=nq(kq.BYTE_KANJI,r.BYTE,u),H=[];return W.concat(N,J,H).sort(function(V,h){return V.index-h.index}).map(function(V){return{data:V.data,mode:V.mode,length:V.length}})}function l5(u,W){switch(W){case r.NUMERIC:return e6.getBitsLength(u);case r.ALPHANUMERIC:return qu.getBitsLength(u);case r.KANJI:return wu.getBitsLength(u);case r.BYTE:return $u.getBitsLength(u)}}function vZ(u){return u.reduce(function(W,N){let J=W.length-1>=0?W[W.length-1]:null;if(J&&J.mode===N.mode)return W[W.length-1].data+=N.data,W;return W.push(N),W},[])}function xZ(u){let W=[];for(let N=0;N<u.length;N++){let J=u[N];switch(J.mode){case r.NUMERIC:W.push([J,{data:J.data,mode:r.ALPHANUMERIC,length:J.length},{data:J.data,mode:r.BYTE,length:J.length}]);break;case r.ALPHANUMERIC:W.push([J,{data:J.data,mode:r.BYTE,length:J.length}]);break;case r.KANJI:W.push([J,{data:J.data,mode:r.BYTE,length:a6(J.data)}]);break;case r.BYTE:W.push([{data:J.data,mode:r.BYTE,length:a6(J.data)}])}}return W}function dZ(u,W){let N={},J={start:{}},H=["start"];for(let K=0;K<u.length;K++){let V=u[K],h=[];for(let Y=0;Y<V.length;Y++){let b=V[Y],S=""+K+Y;h.push(S),N[S]={node:b,lastCount:0},J[S]={};for(let _=0;_<H.length;_++){let E=H[_];if(N[E]&&N[E].node.mode===b.mode)J[E][S]=l5(N[E].lastCount+b.length,b.mode)-l5(N[E].lastCount,b.mode),N[E].lastCount+=b.length;else{if(N[E])N[E].lastCount=b.length;J[E][S]=l5(b.length,b.mode)+4+r.getCharCountIndicator(b.mode,W)}}}H=h}for(let K=0;K<H.length;K++)J[H[K]].end=0;return{map:J,table:N}}function s6(u,W){let N,J=r.getBestModeForData(u);if(N=r.from(W,J),N!==r.BYTE&&N.bit<J.bit)throw Error('"'+u+'" cannot be encoded with mode '+r.toString(N)+`.
 Suggested mode is: `+r.toString(J));if(N===r.KANJI&&!A8.isKanjiModeEnabled())N=r.BYTE;switch(N){case r.NUMERIC:return new e6(u);case r.ALPHANUMERIC:return new qu(u);case r.KANJI:return new wu(u);case r.BYTE:return new $u(u)}}tZ.fromArray=function(W){return W.reduce(function(N,J){if(typeof J==="string")N.push(s6(J,null));else if(J.data)N.push(s6(J.data,J.mode));return N},[])};tZ.fromString=function(W,N){let J=uu(W,A8.isKanjiModeEnabled()),H=xZ(J),K=dZ(H,N),V=pZ.find_path(K.map,"start","end"),h=[];for(let Y=1;Y<V.length-1;Y++)h.push(K.table[V[Y]].node);return tZ.fromArray(vZ(h))};tZ.rawSplit=function(W){return tZ.fromArray(uu(W,A8.isKanjiModeEnabled()))}});var Zu=e((XG)=>{var L8=J1(),a5=D8(),oZ=z6(),lZ=h6(),rZ=B6(),aZ=Y6(),q$=R6(),$$=C5(),sZ=c6(),M8=i6(),eZ=p6(),qG=Q1(),s5=Wu();function $G(u,W){let N=u.size,J=aZ.getPositions(W);for(let H=0;H<J.length;H++){let K=J[H][0],V=J[H][1];for(let h=-1;h<=7;h++){if(K+h<=-1||N<=K+h)continue;for(let Y=-1;Y<=7;Y++){if(V+Y<=-1||N<=V+Y)continue;if(h>=0&&h<=6&&(Y===0||Y===6)||Y>=0&&Y<=6&&(h===0||h===6)||h>=2&&h<=4&&Y>=2&&Y<=4)u.set(K+h,V+Y,!0,!0);else u.set(K+h,V+Y,!1,!0)}}}}function wG(u){let W=u.size;for(let N=8;N<W-8;N++){let J=N%2===0;u.set(N,6,J,!0),u.set(6,N,J,!0)}}function uG(u,W){let N=rZ.getPositions(W);for(let J=0;J<N.length;J++){let H=N[J][0],K=N[J][1];for(let V=-2;V<=2;V++)for(let h=-2;h<=2;h++)if(V===-2||V===2||h===-2||h===2||V===0&&h===0)u.set(H+V,K+h,!0,!0);else u.set(H+V,K+h,!1,!0)}}function WG(u,W){let N=u.size,J=M8.getEncodedBits(W),H,K,V;for(let h=0;h<18;h++)H=Math.floor(h/3),K=h%3+N-8-3,V=(J>>h&1)===1,u.set(H,K,V,!0),u.set(K,H,V,!0)}function e5(u,W,N){let J=u.size,H=eZ.getEncodedBits(W,N),K,V;for(K=0;K<15;K++){if(V=(H>>K&1)===1,K<6)u.set(K,8,V,!0);else if(K<8)u.set(K+1,8,V,!0);else u.set(J-15+K,8,V,!0);if(K<8)u.set(8,J-K-1,V,!0);else if(K<9)u.set(8,15-K-1+1,V,!0);else u.set(8,15-K-1,V,!0)}u.set(J-8,8,1,!0)}function ZG(u,W){let N=u.size,J=-1,H=N-1,K=7,V=0;for(let h=N-1;h>0;h-=2){if(h===6)h--;while(!0){for(let Y=0;Y<2;Y++)if(!u.isReserved(H,h-Y)){let b=!1;if(V<W.length)b=(W[V]>>>K&1)===1;if(u.set(H,h-Y,b),K--,K===-1)V++,K=7}if(H+=J,H<0||N<=H){H-=J,J=-J;break}}}}function GG(u,W,N){let J=new oZ;N.forEach(function(Y){J.put(Y.mode.bit,4),J.put(Y.getLength(),qG.getCharCountIndicator(Y.mode,u)),Y.write(J)});let H=L8.getSymbolTotalCodewords(u),K=$$.getTotalCodewordsCount(u,W),V=(H-K)*8;if(J.getLengthInBits()+4<=V)J.put(0,4);while(J.getLengthInBits()%8!==0)J.putBit(0);let h=(V-J.getLengthInBits())/8;for(let Y=0;Y<h;Y++)J.put(Y%2?17:236,8);return NG(J,u,W)}function NG(u,W,N){let J=L8.getSymbolTotalCodewords(W),H=$$.getTotalCodewordsCount(W,N),K=J-H,V=$$.getBlocksCount(W,N),h=J%V,Y=V-h,b=Math.floor(J/V),S=Math.floor(K/V),_=S+1,E=b-S,$0=new sZ(E),v=0,P=Array(V),f=Array(V),g=0,B=new Uint8Array(u.buffer);for(let m=0;m<V;m++){let H0=m<Y?S:_;P[m]=B.slice(v,v+H0),f[m]=$0.encode(P[m]),v+=H0,g=Math.max(g,H0)}let a=new Uint8Array(J),G0=0,s,W0;for(s=0;s<g;s++)for(W0=0;W0<V;W0++)if(s<P[W0].length)a[G0++]=P[W0][s];for(s=0;s<E;s++)for(W0=0;W0<V;W0++)a[G0++]=f[W0][s];return a}function JG(u,W,N,J){let H;if(Array.isArray(u))H=s5.fromArray(u);else if(typeof u==="string"){let b=W;if(!b){let S=s5.rawSplit(u);b=M8.getBestVersionForData(S,N)}H=s5.fromString(u,b||40)}else throw Error("Invalid data");let K=M8.getBestVersionForData(H,N);if(!K)throw Error("The amount of data is too big to be stored in a QR Code");if(!W)W=K;else if(W<K)throw Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+K+`.
`);let V=GG(W,N,H),h=L8.getSymbolSize(W),Y=new lZ(h);if($G(Y,W),wG(Y),uG(Y,W),e5(Y,N,0),W>=7)WG(Y,W);if(ZG(Y,V),isNaN(J))J=q$.getBestMask(Y,e5.bind(null,Y,N));return q$.applyMask(J,Y),e5(Y,N,J),{modules:Y,version:W,errorCorrectionLevel:N,maskPattern:J,segments:H}}XG.create=function(W,N){if(typeof W>"u"||W==="")throw Error("No input text");let J=a5.M,H,K;if(typeof N<"u"){if(J=a5.from(N.errorCorrectionLevel,a5.M),H=M8.from(N.version),K=q$.from(N.maskPattern),N.toSJISFunc)L8.setToSJISFunction(N.toSJISFunc)}return JG(W,H,J,K)}});var u$=e((HG)=>{function Gu(u){if(typeof u==="number")u=u.toString();if(typeof u!=="string")throw Error("Color should be defined as hex string");let W=u.slice().replace("#","").split("");if(W.length<3||W.length===5||W.length>8)throw Error("Invalid hex color: "+u);if(W.length===3||W.length===4)W=Array.prototype.concat.apply([],W.map(function(J){return[J,J]}));if(W.length===6)W.push("F","F");let N=parseInt(W.join(""),16);return{r:N>>24&255,g:N>>16&255,b:N>>8&255,a:N&255,hex:"#"+W.slice(0,6).join("")}}HG.getOptions=function(W){if(!W)W={};if(!W.color)W.color={};let N=typeof W.margin>"u"||W.margin===null||W.margin<0?4:W.margin,J=W.width&&W.width>=21?W.width:void 0,H=W.scale||4;return{width:J,scale:J?4:H,margin:N,color:{dark:Gu(W.color.dark||"#000000ff"),light:Gu(W.color.light||"#ffffffff")},type:W.type,rendererOpts:W.rendererOpts||{}}};HG.getScale=function(W,N){return N.width&&N.width>=W+N.margin*2?N.width/(W+N.margin*2):N.scale};HG.getImageWidth=function(W,N){let J=HG.getScale(W,N);return Math.floor((W+N.margin*2)*J)};HG.qrToImageData=function(W,N,J){let H=N.modules.size,K=N.modules.data,V=HG.getScale(H,J),h=Math.floor((H+J.margin*2)*V),Y=J.margin*V,b=[J.color.light,J.color.dark];for(let S=0;S<h;S++)for(let _=0;_<h;_++){let E=(S*h+_)*4,$0=J.color.light;if(S>=Y&&_>=Y&&S<h-Y&&_<h-Y){let v=Math.floor((S-Y)/V),P=Math.floor((_-Y)/V);$0=b[K[v*H+P]?1:0]}W[E++]=$0.r,W[E++]=$0.g,W[E++]=$0.b,W[E]=$0.a}}});var Ju=e((FG)=>{var W$=u$();function VG(u,W,N){if(u.clearRect(0,0,W.width,W.height),!W.style)W.style={};W.height=N,W.width=N,W.style.height=N+"px",W.style.width=N+"px"}function zG(){try{return document.createElement("canvas")}catch(u){throw Error("You need to specify a canvas element")}}FG.render=function(W,N,J){let H=J,K=N;if(typeof H>"u"&&(!N||!N.getContext))H=N,N=void 0;if(!N)K=zG();H=W$.getOptions(H);let V=W$.getImageWidth(W.modules.size,H),h=K.getContext("2d"),Y=h.createImageData(V,V);return W$.qrToImageData(Y.data,W,H),VG(h,K,V),h.putImageData(Y,0,0),K};FG.renderToDataURL=function(W,N,J){let H=J;if(typeof H>"u"&&(!N||!N.getContext))H=N,N=void 0;if(!H)H={};let K=FG.render(W,N,H),V=H.type||"image/png",h=H.rendererOpts||{};return K.toDataURL(V,h.quality)}});var Qu=e((YG)=>{var DG=u$();function Xu(u,W){let N=u.a/255,J=W+'="'+u.hex+'"';return N<1?J+" "+W+'-opacity="'+N.toFixed(2).slice(1)+'"':J}function Z$(u,W,N){let J=u+W;if(typeof N<"u")J+=" "+N;return J}function BG(u,W,N){let J="",H=0,K=!1,V=0;for(let h=0;h<u.length;h++){let Y=Math.floor(h%W),b=Math.floor(h/W);if(!Y&&!K)K=!0;if(u[h]){if(V++,!(h>0&&Y>0&&u[h-1]))J+=K?Z$("M",Y+N,0.5+b+N):Z$("m",H,0),H=0,K=!1;if(!(Y+1<W&&u[h+1]))J+=Z$("h",V),V=0}else H++}return J}YG.render=function(W,N,J){let H=DG.getOptions(N),K=W.modules.size,V=W.modules.data,h=K+H.margin*2,Y=!H.color.light.a?"":"<path "+Xu(H.color.light,"fill")+' d="M0 0h'+h+"v"+h+'H0z"/>',b="<path "+Xu(H.color.dark,"stroke")+' d="'+BG(V,K,H.margin)+'"/>',S='viewBox="0 0 '+h+" "+h+'"',E='<svg xmlns="http://www.w3.org/2000/svg" '+(!H.width?"":'width="'+H.width+'" height="'+H.width+'" ')+S+' shape-rendering="crispEdges">'+Y+b+`</svg>
`;if(typeof J==="function")J(null,E);return E}});function _0(u){if(u==null)return u;if(u instanceof Function)return u;let W=typeof u;if(W==="string")return(N,J)=>{return L(N,u,J)};if(W==="object")return(N,J)=>{return L(u,N,J)};return u}var $w=Object.prototype.hasOwnProperty;function ww(u,W,N){for(N of u.keys())if(Qq(N,W))return N}function Qq(u,W){if(u===W)return!0;var N,J,H;if(u&&W&&(N=u.constructor)===W.constructor){if(N===Array){if((J=u.length)===W.length)while(J--&&Qq(u[J],W[J]));return J===-1}if(N===Set){if(u.size!==W.size)return!1;for(let K of u){if(H=K,H&&typeof H==="object"){if(H=ww(W,H),!H)return!1}if(!W.has(H))return!1}return!0}if(N===Map){if(u.size!==W.size)return!1;for(let K of u){if(H=K[0],H&&typeof H==="object"){if(H=ww(W,H),!H)return!1}if(!Qq(J[1],W.get(H)))return!1}return!0}if(!N||typeof u==="object"){J=0;for(let K in u){if($w.call(u,K)&&++J&&!$w.call(W,K))return!1;if(!(K in W)||!Qq(u[K],W[K]))return!1}return Object.keys(W).length===J}}return!1}function Q9(u,W){return u.every(function(N,J){return J===0||W(u[J-1],N)})}function $1(...u){return Q9(u,(W,N)=>Qq(W,N))}function Uq(...u){return u.reduce((W,N)=>W+N,0)}function Q5(u,W,N,...J){if(J.length%2!==0)throw Error("Illegal argument: assoc expects an odd number of arguments.");switch(p0(u)){case l0:u.set(W,N);for(let H=0;H<J.length;H+=2)u.set(J[H],J[H+1]);break;case r0:case o0:u[W]=N;for(let H=0;H<J.length;H+=2)u[J[H]]=J[H+1];break;default:throw Error(`Illegal argument: assoc! expects a Map, Array, or Object as the first argument, but got ${typeof u}.`)}return u}function uw(u){switch(p0(u)){case l0:return new Map(u);case V1:return new u.constructor(u);case r0:return[...u];case o0:return{...u};default:throw Error(`Don't know how to copy object of type ${typeof u}.`)}}function N0(u,W,N,...J){if(!u)u={};let H=uw(u);return Q5(H,W,N,...J),H}var l0=1,r0=2,o0=3,sq=4,V1=5,H5=6;function U5(u){switch(u){case l0:return new Map;case r0:return[];case o0:return{};case sq:return new zq;case V1:return new Set;case H5:return u0(function*(){return})}return}function Ww(u){return u.constructor===Object}function p0(u){if(u==null)return;if(Ww(u))return o0;if(u instanceof Map)return l0;if(u instanceof Set)return V1;if(u instanceof zq)return sq;if(Array.isArray(u))return r0;if(u instanceof q8)return H5;if(u instanceof W8)return V1;if(u instanceof Object)return o0;return}function H9(u,W,N,J,H){J=e0(J),N=N||{};let K=p0(N);if(K!==l0&&K!==r0&&K!==o0)throw Error(`Illegal argument: ${W} expects the first argument to be a Map, Array, or Object.`);let V=[N],h=N;for(let Y=0;Y<J.length-1;Y+=1){let b=J[Y],S;if(h instanceof Map)S=h.get(b);else S=h[b];if(!S)S=U5(K);V.push(S),h=S}V.push(H);for(let Y=V.length-2;Y>=0;Y-=1)V[Y]=u(V[Y],J[Y],V[Y+1]);return V[0]}function Kq(u,W,N){return H9(N0,"assoc-in",u,W,N)}function Zw(u,W){for(let N of W)u.add(N);return u}function Gw(...u){if(u.length===0)return W1();let[W,...N]=u,J=W;if(J===null||J===void 0)J=[];switch(p0(J)){case V1:Zw(J,N);break;case sq:J.unshift(...N.reverse());break;case r0:J.push(...N);break;case l0:for(let H of N)if(!Array.isArray(H))i(H).forEach((K)=>{J.set(K[0],K[1])});else J.set(H[0],H[1]);break;case o0:for(let H of N)if(!Array.isArray(H))Object.assign(J,H);else J[H[0]]=H[1];break;default:throw Error("Illegal argument: conj! expects a Set, Array, List, Map, or Object as the first argument.")}return J}function Oq(...u){if(u.length===0)return W1();let[W,...N]=u,J=W;if(J===null||J===void 0)J=I9();let H,K;switch(p0(J)){case V1:if(J instanceof W8)return Zw(new J.constructor(J),N);else return new J.constructor([...J,...N]);case sq:return new zq(...N.reverse(),...J);case r0:return[...J,...N];case l0:H=new Map(J);for(let V of N)if(!Array.isArray(V))i(V).forEach((h)=>{H.set(h[0],h[1])});else H.set(V[0],V[1]);return H;case H5:return u0(function*(){yield*N,yield*J});case o0:K={...J};for(let V of N)if(!Array.isArray(V))Object.assign(K,V);else K[V[0]]=V[1];return K;default:throw Error("Illegal argument: conj expects a Set, Array, List, Map, or Object as the first argument.")}}function U9(u){return u+1}function a0(...u){console.log(...u)}function b0(u,W,N){if(u){var J=void 0;if(Array.isArray(u))J=u[W];else{let H=i(u),K=0;for(let V of H)if(K++==W){J=V;break}}if(J!==void 0)return J}return N}function L(u,W,N=void 0){if(u==null)return N;let J;if(Ww(u))if(J=u[W],J===void 0)return N;else return J;let H;switch(p0(u)){case V1:if(u.has(W))J=W;break;case l0:J=u.get(W);break;case r0:J=u[W];break;default:if(H=u.get,H instanceof Function)try{J=u.get(W);break}catch(K){}J=u[W];break}return J!==void 0?J:N}function K9(u){return u===null||u===void 0||!!u[Symbol.iterator]}function i(u){if(u===null||u===void 0)return[];if(K9(u))return u;if(u instanceof Object)return Object.entries(u);throw TypeError(`${u} is not iterable`)}var O9=Symbol("Iterable");function V9(u){return u[Symbol.iterator]()}var z9=V9;function Y0(u){if(u==null)return u;let W=i(u);if(W.length===0||W.size===0)return null;if(W[Symbol.iterator]().next().done)return null;return W}function w1(u){let[W]=i(u);return W}function Nw(u){return u0(function*(){let W=!0;for(let N of i(u))if(W)W=!1;else yield N})}class Hq{value;constructor(u){this.value=u}_deref(){return this.value}}function eq(u){u=i(u);let W;switch(p0(u)){case r0:return u[u.length-1];default:for(let N of u)W=N;return W}}function F9(u){return new Hq(u)}function h9(u){return u instanceof Hq}function E1(u,W,N){u=_0(u);let J,H;if(arguments.length===2){let K=i(W)[Symbol.iterator](),V=K.next();if(V.done)H=u();else H=V.value;J=K}else H=W,J=i(N);if(H instanceof Hq)return H.value;for(let K of J)if(H=u(H,K),H instanceof Hq){H=H.value;break}return H}var D9=!1;class q8{constructor(u){this.gen=u,this.usages=0}[Symbol.iterator](){if(this.usages++,this.usages>=2&&D9)try{throw Error()}catch(u){console.warn("Re-use of lazy value",u.stack)}return this.gen()}}q8.prototype[O9]=!0;function u0(u){return new q8(u)}class Jw{constructor(u,W){this.x=u,this.coll=W}*[Symbol.iterator](){yield this.x,yield*i(this.coll)}}function Xw(u,W){return new Jw(u,W)}function u1(u,...W){switch(u=_0(u),W.length){case 0:return(N)=>{return(...J)=>{switch(J.length){case 0:return N();case 1:return N(J[0]);case 2:return N(J[0],u(J[1]));default:return N(J[0],u(...J.slice(1)))}}};case 1:return u0(function*(){for(let N of i(W[0]))yield u(N)});default:return u0(function*(){let N=W.map((J)=>z9(i(J)));while(!0){let J=[];for(let H of N){let K=H.next();if(K.done)return;J.push(K.value)}yield u(...J)}})}}function B9(u){return(W)=>{return(...N)=>{switch(N.length){case 0:return W();case 1:return W(N[0]);case 2:{let J=N[0],H=N[1];if(R(u(H)))return W(J,H);else return J}}}}}function K5(u,W){if(arguments.length===1)return B9(u);return u=_0(u),u0(function*(){for(let N of i(W))if(R(u(N)))yield N})}function Qw(u,W){return[...K5(u,W)]}function Y9(u){return(W)=>{let N=-1;return(...J)=>{switch(J.length){case 0:return W();case 1:return W(J[0]);case 2:return W(J[0],u((N=N+1,N),J[1]))}}}}function z1(u,W){if(u=_0(u),arguments.length===1)return Y9(u);return u0(function*(){let N=0;for(let J of i(W))yield u(N,J),N++})}function J0(...u){return u.join("")}function Vq(u){return!R(u)}class Hw{constructor(u){this.val=u,this._watches={},this._deref=()=>this.val,this._hasWatches=!1,this._reset_BANG_=(W)=>{let N=this.val;if(this.val=W,this._hasWatches)for(let J of Object.entries(this._watches)){let H=J[0],K=J[1];K(H,this,N,W)}return W},this._add_watch=(W,N)=>{this._watches[W]=N,this._hasWatches=!0},this._remove_watch=(W)=>{delete this._watches[W]}}}function s0(u){return new Hw(u)}function d(u){return u._deref()}function c1(u,W){u._reset_BANG_(W)}function q0(u,W,...N){W=_0(W);let J=W(d(u),...N);return c1(u,J),J}function O5(u,W,N){return u0(function*(){let J=u,H=W,K=N;if(W===void 0)J=0,H=u;let V=J||0;K=N??1;let h=K>=0;while(H===void 0||h&&V<H||!h&&H<V)yield V,V+=K})}function W1(...u){return u}function Uw(...u){if(u.length===2){let[J,H]=u,K=i(H);if(Array.isArray(K)){let V=Array(K.length);for(var W=0;W<K.length;W++)V[W]=J(K[W]);return V}else{var N=[];for(let V of K)N.push(J(V));return N}}return[...u1(...u)]}function e0(u){if(j9(u))return u;return[...i(u)]}var Kw=Symbol("IApply__apply");function P1(u,...W){u=_0(u);let N=W.slice(0,W.length-1),J=i(W[W.length-1]),H=u[Kw];if(H)return H(...N,J);return u(...N,...J)}class zq extends Array{constructor(...u){super();this.push(...u)}}function I9(...u){return new zq(...u)}function j9(u){return Array.isArray(u)}function Ow(u){return u0(function*(){for(let W of u)yield*i(W)})}function V5(...u){return Ow(u)}V5[Kw]=(u)=>{return Ow(u)};function C1(u){return u}function k1(u,W){let N=p0(u),J=U5(N)||{};for(let H of W){let K=L(u,H);if(K!=null)Q5(J,H,K)}return J}function A9(u){let W=p0(u);if(W!=null)return U5(W);else throw Error(`Can't create empty of ${typeof u}`)}function Z1(...u){let W=u[0],N;if(W===null||W===void 0)N={};else N=Fq(A9(W),W);return Gw(N,...u.slice(1))}function Fq(...u){let W,N,J,H,K;switch(u.length){case 0:return[];case 1:return u[0];case 2:return Oq(u[0]??[],...i(u[1]));case 3:return W=u[0],N=u[1],J=u[2],H=uw(W),K=(V,h)=>{if(h===void 0)return V;return Gw(V,h)},Mw(N,K,H,J);default:throw TypeError(`Invalid arity call of into: ${u.length}`)}}function M9(u){if(h9(u))return u;else return F9(u)}function L9(u){return(W)=>{let N=u;return(...J)=>{let H=J.length;if(H===0)return W();if(H===1){let K=J[0];return W(K)}if(H===2){let K=J[0],V=J[1],h=N,Y=(N=N-1,N);if(h>0)K=W(K,V);if(!(Y>0))return M9(K);else return K}}}}function Vw(u,W){if(arguments.length===1)return L9(u);return u0(function*(){let N=u-1;for(let J of i(W)){if(N-->=0)yield J;if(N<0)return}})}function zw(u,W){if(u==0)return null;if(Array.isArray(W))return Y0(W.slice(-Math.abs(u)));else{let N=Array(u),J=0;for(let H of i(W))N[J%u]=H,J++;if(J%u!==0&&J>=u)return N.slice(J%u).concat(N.slice(0,J%u));else return N.length=Math.min(J,u),N}}function $8(u,W,N,...J){return N=_0(N),N0(u,W,N(L(u,W),...J))}function S0(u,W,N){let J=u;for(let H of W)J=L(J,H);if(J===void 0)return N;return J}function Fw(u,W,N,...J){return N=_0(N),Kq(u,W,N(S0(u,W),...J))}function z5(u,W,...N){return u=_0(u),function(J,...H){if(!J)return u(W,...N,...H);else return u(J,...N,...H)}}function hw(u,W){if(arguments.length===1)W=u,u=void 0;return u=_0(u),W=i(W),[...W].sort(u||Dq)}function R9(u){if(u===Dq)return u;return(W,N)=>{let J=u(W,N);if(b9(J))return J;if(J)return-1;if(u(N,W))return 1;return 0}}function Dw(u,W,N){if(arguments.length===2)N=W,W=Dq;return u=_0(u),W=_0(W),hw((J,H)=>{let K=R9(W),V=u(J),h=u(H);return K(V,h)},N)}function Bw(u,W){u=_0(u);for(let N of i(W)){let J=u(N);if(R(J))return J}return}function Yw(u){return Y0(u)?!1:!0}function F5(u){return Math.floor(Math.random()*u)}function Iw(u){let W=F5(I0(u));return b0(u,W)}function _9(u,W,N,...J){let H=L(u,W);return Q5(u,W,N(H,...J))}function h5(u){let W={},N=z5(U9,0);for(let J of i(u))_9(W,J,N);return W}function I0(u){if(!u)return 0;let W=u.length||u.size;if(typeof W==="number")return W;let N=0;for(let J of i(u))N++;return N}function G1(u,W,N){return u._add_watch(W,N)}function hq(u,W,...N){if(W==null)return u;return Math.max(u,W,...N)}function jw(u,W,...N){if(W==null)return u;return Math.min(u,W,...N)}function Dq(u,W){if(u===W)return 0;else{if(u==null)return-1;if(W==null)return 1;let N=typeof u,J=typeof W;if(N==="number"&&J==="number"||N==="string"&&J==="string"){if(u===W)return 0;if(u<W)return-1;return 1}else if(Array.isArray(u)&&Array.isArray(W))if(u.length<W.length)return-1;else if(u.length>W.length)return 1;else{for(let H=0;H<u.length;H++){let K=Dq(u[H],W[H]);if(K!=0)return K}return 0}else throw Error(`comparing ${N} to ${J}`)}}function R(u){return u!=null&&u!==!1}function Aw(u,W,N){return u.substring(W,N)}function b9(u){return typeof u=="number"}function w8(u){if(u==null)return;switch(p0(u)){case o0:return Object.values(u);case l0:return Array.from(u.values())}}function u8(u){return typeof u==="string"}var BN=Symbol("meta");function Mw(u,...W){switch(W.length){case 2:{let N=W[0],J=W[1];return Mw(u,N,N(),J)}default:{let N=W[0],J=W[1],H=W[2];N=u(N);let K=E1(N,J,H);return N(K)}}}class W8{constructor(u){if(!(u instanceof W8))u=hw(u);let N=new Set(u);this._elts=[...N],this._set=N}add(u){if(this._set.has(u))return this;let W=this._elts,N=!1;for(let J=0;J<W.length;J++)if(Dq(u,W[J])<=0){W.splice(J,0,u),N=!0;break}if(!N)W.push(u),this._set.add(u);else this._set=new Set(W);return this.size=W.length,this}delete(u){if(!this._set.has(u))return this;let W=this._elts,N=W.indexOf(u);return W.splice(N,1),this._set=new Set(W),this.size=W.length,this}has(u){return this._set.has(u)}keys(){return this.values()}values(){return this._elts[Symbol.iterator]()}entries(){return this._set.entries()}forEach(...u){return this.set.forEach(...u)}clear(){this._elts=[],this._set=new Set(this._elts)}[Symbol.iterator](){return this.keys()}}function Z8(){return crypto.randomUUID()}function Bq(u){if(u==null)return u;if(u instanceof Function)return u;let W=typeof u;if(W==="string")return(N,J)=>{return D5(N,u,J)};if(W==="object")return(N,J)=>{return D5(u,N,J)};return u}function S9(u,W,N,...J){if(J.length%2!==0)throw Error("Illegal argument: assoc expects an odd number of arguments.");switch(Q8(u)){case J8:u.set(W,N);for(let H=0;H<J.length;H+=2)u.set(J[H],J[H+1]);break;case Yq:case G8:u[W]=N;for(let H=0;H<J.length;H+=2)u[J[H]]=J[H+1];break;default:throw Error(`Illegal argument: assoc! expects a Map, Array, or Object as the first argument, but got ${typeof u}.`)}return u}var J8=1,Yq=2,G8=3,Lw=4,N8=5,Rw=6;function X8(u){return u.constructor===Object}function _w(u){return u!=null&&X8(u)}function Q8(u){if(u==null)return;if(X8(u))return G8;if(u instanceof Map)return J8;if(u instanceof Set)return N8;if(u instanceof K8)return Lw;if(Array.isArray(u))return Yq;if(u instanceof U8)return Rw;if(u instanceof V8)return N8;if(u instanceof Object)return G8;return}function T9(u,W){for(let N of W)u.add(N);return u}function bw(...u){if(u.length===0)return k9();let[W,...N]=u,J=W;if(J===null||J===void 0)J=n9();let H,K;switch(Q8(J)){case N8:if(J instanceof V8)return T9(new J.constructor(J),N);else return new J.constructor([...J,...N]);case Lw:return new K8(...N.reverse(),...J);case Yq:return[...J,...N];case J8:H=new Map(J);for(let V of N)if(!Array.isArray(V))n0(V).forEach((h)=>{H.set(h[0],h[1])});else H.set(V[0],V[1]);return H;case Rw:return cw(function*(){yield*N,yield*J});case G8:K={...J};for(let V of N)if(!Array.isArray(V))Object.assign(K,V);else K[V[0]]=V[1];return K;default:throw Error("Illegal argument: conj expects a Set, Array, List, Map, or Object as the first argument.")}}function E9(u,...W){for(let N of W)u.delete(N);return u}function Sw(u,...W){let N=new u.constructor([...u]);return E9(N,...W)}function H8(u,W,N){if(u){var J=void 0;if(Array.isArray(u))J=u[W];else{let H=n0(u),K=0;for(let V of H)if(K++==W){J=V;break}}if(J!==void 0)return J}return N}function D5(u,W,N=void 0){if(u==null)return N;let J;if(X8(u))if(J=u[W],J===void 0)return N;else return J;let H;switch(Q8(u)){case N8:if(u.has(W))J=W;break;case J8:J=u.get(W);break;case Yq:J=u[W];break;default:if(H=u.get,H instanceof Function)try{J=u.get(W);break}catch(K){}J=u[W];break}return J!==void 0?J:N}function Tw(u){return u!=null&&!!u[Symbol.iterator]}function c9(u){return u===null||u===void 0||!!u[Symbol.iterator]}function n0(u){if(u===null||u===void 0)return[];if(c9(u))return u;if(u instanceof Object)return Object.entries(u);throw TypeError(`${u} is not iterable`)}var P9=Symbol("Iterable");class B5{value;constructor(u){this.value=u}_deref(){return this.value}}function Ew(u,W,N){u=Bq(u);let J,H;if(arguments.length===2){let K=n0(W)[Symbol.iterator](),V=K.next();if(V.done)H=u();else H=V.value;J=K}else H=W,J=n0(N);if(H instanceof B5)return H.value;for(let K of J)if(H=u(H,K),H instanceof B5){H=H.value;break}return H}var C9=!1;class U8{constructor(u){this.gen=u,this.usages=0}[Symbol.iterator](){if(this.usages++,this.usages>=2&&C9)try{throw Error()}catch(u){console.warn("Re-use of lazy value",u.stack)}return this.gen()}}U8.prototype[P9]=!0;function cw(u){return new U8(u)}function Iq(u){return!p(u)}function k9(...u){return u}function Y5(u){return Q8(u)===Yq}var Pw=Symbol("IApply__apply");function Cw(u,...W){u=Bq(u);let N=W.slice(0,W.length-1),J=n0(W[W.length-1]),H=u[Pw];if(H)return H(...N,J);return u(...N,...J)}class K8 extends Array{constructor(...u){super();this.push(...u)}}function n9(...u){return new K8(...u)}function kw(u){return cw(function*(){for(let W of u)yield*n0(W)})}function y9(...u){return kw(u)}y9[Pw]=(u)=>{return kw(u)};function nw(u,W,...N){return u=Bq(u),function(J,...H){if(!J)return u(W,...N,...H);else return u(J,...N,...H)}}function i9(u,W){if(arguments.length===1)W=u,u=void 0;return u=Bq(u),W=n0(W),[...W].sort(u||j5)}function I5(u,W,N,...J){N=Bq(N);let H=D5(u,W);return S9(u,W,N(H,...J))}function n1(u){if(!u)return 0;let W=u.length||u.size;if(typeof W==="number")return W;let N=0;for(let J of n0(u))N++;return N}function yw(u){if(u==null)return!1;if(X8(u))return!0;if(u instanceof Map)return!0;return!1}function j5(u,W){if(u===W)return 0;else{if(u==null)return-1;if(W==null)return 1;let N=typeof u,J=typeof W;if(N==="number"&&J==="number"||N==="string"&&J==="string"){if(u===W)return 0;if(u<W)return-1;return 1}else if(Array.isArray(u)&&Array.isArray(W))if(u.length<W.length)return-1;else if(u.length>W.length)return 1;else{for(let H=0;H<u.length;H++){let K=j5(u[H],W[H]);if(K!=0)return K}return 0}else throw Error(`comparing ${N} to ${J}`)}}function p(u){return u!=null&&u!==!1}function iw(u,W,N){return u.substring(W,N)}function gw(u){return typeof u==="function"}function pw(u){return typeof u=="number"}function O8(u){return typeof u==="string"}var IN=Symbol("meta");function vw(u){return u===!0||u===!1}class V8{constructor(u){if(!(u instanceof V8))u=i9(u);let N=new Set(u);this._elts=[...N],this._set=N}add(u){if(this._set.has(u))return this;let W=this._elts,N=!1;for(let J=0;J<W.length;J++)if(j5(u,W[J])<=0){W.splice(J,0,u),N=!0;break}if(!N)W.push(u),this._set.add(u);else this._set=new Set(W);return this.size=W.length,this}delete(u){if(!this._set.has(u))return this;let W=this._elts,N=W.indexOf(u);return W.splice(N,1),this._set=new Set(W),this.size=W.length,this}has(u){return this._set.has(u)}keys(){return this.values()}values(){return this._elts[Symbol.iterator]()}entries(){return this._set.entries()}forEach(...u){return this.set.forEach(...u)}clear(){this._elts=[],this._set=new Set(this._elts)}[Symbol.iterator](){return this.keys()}}var g9="http://www.w3.org/2000/svg",p9=function(u){let W=(()=>{let J=u.indexOf("#");if(J>0)return J})(),N=(()=>{let J=u.indexOf(".");if(J>0)return J})();return[p(W)?u.substring(0,W):p(N)?u.substring(0,N):u,p(W)?p(N)?u.substring(W+1,N):u.substring(W+1):null,p(N)?u.substring(N+1):null]},v9=new Set(["checked","disabled","selected","value","innerHTML"]),x9=function(u){return v9.has(u)};var d9=function(u){return Iq(O8(u))&&(()=>{let W=Tw(u);if(p(W))return Iq(Y5(u));else return W})()},xw=function(u,W){if(W in u){let N=u[W];return delete u[W],u[W]=N}},z8=function(u,W){if(p((()=>{let N=u==null;if(N)return N;else{let J=O8(u);if(p(J))return J;else{let H=pw(u);if(p(H))return H;else return vw(u)}}})()))return{tag:"#text",text:`${u??""}`};else if(p(Y5(u))){let N=u[0],J=1,H=p(O8(N))?p9(N):[N],K=H8(H,0,null),V=H8(H,1,null),h=H8(H,2,null),Y=p(h)?h.split("."):null,b=u[1],S=p(yw(b))?1:-1,_=S===-1?1:2,E=(()=>{let v=W;if(p(v))return v;else return K==="svg"})();return p(gw(K))?(()=>{let v=Cw(K,u.slice(1));return z8(v,E)})():(()=>{let v=[],P={type:"element",svg:E,tag:p(E)?K:K.toUpperCase(),children:v},f={},g={};P["reagami.core/props"]=f,P["reagami.core/attrs"]=g;let B=u.length-_;for(let a=0;a<B;a++)(()=>{let G0=u[a+_];if(p(d9(G0))){for(let s of n0(G0)){let W0=s;v.push(z8(W0,E))}return null}else return v.push(z8(G0,E))})();if(S===-1);else{let a=u[1],G0=Object.getOwnPropertyNames(a),s=G0.length;if(p((()=>{let m="max"in a;if(m)return m;else return"min"in a})()))xw(a,"default-value"),xw(a,"value");let W0=s;for(let m=0;m<W0;m++)(()=>{let H0=G0[m],Q=a[H0];if(H0==="on-render")return P["reagami.core/on-render"]=Q;else if(p(H0.startsWith("on"))){let z0=H0.replaceAll("-","");return f[z0]=Q}else if(p(H0.startsWith("default"))){let z0=iw(H0,7).replaceAll("-","");return g[z0]=Q}else if(p(H0==="style"&&_w(Q))){let z0=Ew(function(i0,D){return`${i0??""}${D[0]??""}: ${D[1]??""};`},"",Object.entries(Q));return g.style=z0}else if(p(x9(H0)))return f[H0]=Q;else if(p(Q))return g[H0]=Q})()}if(p(Y!=null&&Y.length>0))g.class=`${(()=>{let a=g.class;if(p(a))return`${a??""} `})()??""}${Y.join(" ")??""}`;if(p(V))g.id=V;return P})()}else throw(()=>{return console.error("Invalid hiccup:",u),Error(`Invalid hiccup: ${u??""}`)})()},t9=function(u){return z8(u,!1)},A5=new Map,M5=function(u,W){let N=(()=>{let J=u.text;if(p(J)){let H=J;return document.createTextNode(H)}else{let H=u.tag,K=p(u.svg)?document.createElementNS(g9,H):document.createElement(H),V=u["reagami.core/props"],h=u["reagami.core/attrs"],Y=Object.getOwnPropertyNames(h),b=Object.getOwnPropertyNames(V),S=Y.length;for(let v=0;v<S;v++)(()=>{let P=Y[v],f=h[P];return K.setAttribute(P,f)})();let _=b.length;for(let v=0;v<_;v++)(()=>{let P=b[v],f=V[P],g=f===void 0?null:f;return K[P]=g})();let E=u.children;if(p(E)){let v=E,f=v.length;for(let g=0;g<f;g++)(()=>{let B=v[g];return K.appendChild(M5(B,W))})()}let $0=u["reagami.core/on-render"];if(p($0)){let v=$0;K["reagami.core/on-render"]=v,I5(A5,W,nw(bw,new Set([])),K)}return K}})();return N["reagami.core/vnode"]=u,N},dw=function(u,W,N){let J=u["reagami.core/vnode"],H=p((()=>{let K=J;if(p(K))return Iq(u["reagami.core/root"]);else return K})())?J.children.length:N===u?u.childNodes.length:-1;if(H===-1)return null;else{let K=u.childNodes,V=n1(W);if(H!==V)return u.replaceChildren.apply(u,W.map(function(h){return M5(h,N)}));else{let h=V;for(let Y=0;Y<h;Y++)(()=>{let b=K[Y],S=b["reagami.core/vnode"],_=W[Y],E=S.text,$0=_.text,v=_.tag;if(p((()=>{let P=E;if(p(P))return $0;else return P})()))if($0===E)return null;else return b.textContent=$0,b["reagami.core/vnode"]=_;else if(p((()=>{let P=b;if(p(P)){let f=S;if(p(f)){let g=_;if(p(g))return v===S.tag;else return g}else return f}else return P})())){let P=S["reagami.core/props"],f=S["reagami.core/attrs"],g=_["reagami.core/props"],B=_["reagami.core/attrs"],a=Object.getOwnPropertyNames(P),G0=Object.getOwnPropertyNames(f),s=Object.getOwnPropertyNames(B),W0=Object.getOwnPropertyNames(g),m=n1(a);for(let D=0;D<m;D++)(()=>{let o=a[D];if(o in g)return null;else return b[o]=null})();let H0=n1(G0);for(let D=0;D<H0;D++)(()=>{let o=G0[D];if(o in B)return null;else return b.removeAttribute(o)})();let Q=n1(s);for(let D=0;D<Q;D++)(()=>{let o=s[D],U1=B[o];if(U1===f[o])return null;else return b.setAttribute(o,U1)})();let z0=n1(W0);for(let D=0;D<z0;D++)(()=>{let o=W0[D],U1=(()=>{let n=g[o];if(n===void 0)return null;else return n})();if(P[o]===U1)return null;else return b[o]=U1})();let i0=_.children;if(p(i0))dw(b,i0,N);return b["reagami.core/vnode"]=_}else{let P=M5(_,N);return u.replaceChild(P,b)}})();return null}}},tw=function(u,W){if(p(u["reagami.core/root"]));else u.textContent="",u["reagami.core/root"]=!0;let N=t9(W);dw(u,[N],u);for(let J of n0(A5.get(u))){let H=J,K=H["reagami.core/on-render"];if(p(H.isConnected))if(Iq(K["reagami.core/is-run"])){let V=K(H,"mount",null);K["reagami.core/is-run"]=!0,K["reagami.core/data"]=V}else{let V=K(H,"update",K["reagami.core/data"]);K["reagami.core/data"]=V}else K(H,"unmount",K["reagami.core/data"]),delete K["reagami.core/data"],I5(A5,u,Sw,H)}return null};var mw=X9(fw(),1),m9=function(){let u=localStorage.getItem("client-id");if(R(u))return u;else{let W=J0(Z8());return localStorage.setItem("client-id",W),W}},Mq=m9(),y0=s0({ably:null,"connection-status":"initialized"}),ow=function(){return L(d(y0),"ably")},lw=function(){return L(d(y0),"connection-status")},y1=function(){return L(d(y0),"connection-status")==="connected"},o9=mw.default.Realtime,rw=function(u){a0("Ably init!");let W=new o9({key:u,clientId:Mq});return W.connection.on(function(N){let J=N.current;return a0("Ably connection:",J),q0(y0,N0,"connection-status",J)}),q0(y0,N0,"ably",W),W},i1=function(u){return ow().channels.get(u)},Lq=(()=>{let u=function(...W){switch(W.length){case 1:return u.cljs$core$IFn$_invoke$arity$1(W[0]);case 2:return u.cljs$core$IFn$_invoke$arity$2(W[0],W[1]);default:throw Error(J0("Invalid arity: ",W.length))}};return u.cljs$core$IFn$_invoke$arity$1=function(W){return Lq(W,null)},u.cljs$core$IFn$_invoke$arity$2=function(W,N){return i1(W).presence.enter(N).catch(function(J){return a0("Presence enter failed:",J)})},u.cljs$lang$maxFixedArity=2,u})(),aw=function(u,W){return i1(u).presence.update(W).catch(function(N){return a0("Presence update failed:",N)})},Rq=function(u,W){return i1(u).presence.subscribe(function(J){return W()}),ow().connection.once("connected",W)},_q=function(u,W){return i1(u).presence.get().then(function(N){return W(e0(N))}).catch(function(N){return a0("Get presence failed:",N)})},F1=function(u,W,N){return i1(u).publish(W,N).catch(function(J){return a0("Publish failed:",J)})},h1=function(u,W){return i1(u).subscribe(function(N){return W(N.data)})};var g1=function(){let u=lw();if(R(y1()))return null;else return["div",{class:"fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-yellow-500 text-white rounded-full text-sm font-medium shadow-lg"},"Connection status: ",u]};var ew=["title","about",["wotc","q1","q1-results","wotc-answer"],["rules","q2","q2-results"],["independence","q3","q3-results","q3-trend"],["diversity","q4","q4-results","q4-trend"],["ground-truth","q5","q5-results","q5-trend"],["point","search-engines","llms","but-not-really"],"the-end"],v0=e0(P1(V5,u1(function(u){if(R(u8(u)))return[u];else return u},ew))),l9={q1:{id:"q1",text:'Who has heard of "Wisdom of the Crowd" before?',kind:"choice",options:["Yes","No","Maybe"]},q2:{id:"q2",text:"How heavy is this Persimmon (in grams)?",kind:"scale",options:{min:1,max:500,unit:"g","bin-size":50}},q3:{id:"q3",text:"What year did the first person reach the peak of Mount Everest?",kind:"scale",options:{min:1800,max:2000,"bin-size":10}},q4:{id:"q4",text:"What percentage of the world population has internet access?",kind:"scale",options:{min:0,max:100,unit:"%","bin-size":10}},q5:{id:"q5",text:"How ethical is it to train LLMs on public code on GitHub?",kind:"scale",options:{min:0,max:10,"bin-size":1,"min-label":"Not ethical","max-label":"Very ethical"}}},r9={diversity:["Diversity in errors helps reduce overall error"],"ground-truth":["There needs to obviously be a precise answer to the question"],llms:["That's what I thought","But thinking further"],about:["This is my backup idea...","So let's just have fun"],rules:["1. No peeking!","2. Feel free to change your answers as much as you like","3. That's it"],"search-engines":["I mean..."],"but-not-really":["Not independent, even with temperature","They're fairly diverse","They seem to give reasonable answers without ground truth"],independence:["For errors to cancel out, the errors need to be unbiased"],point:["Originally I had a point to this talk","Because this sounds very similar to"]},N1=function(u){return L(l9,u)},a9={"slide-id":w1(v0),"audience-count":0,"selected-speaker":null,"audience-members":[]},s9=function(){return localStorage.setItem("presenter-state",JSON.stringify(k1(d(Q0),["slide-id","selected-speaker"])))},e9=function(){let u=localStorage.getItem("presenter-state");if(R(u)){let N=JSON.parse(u);return{"slide-id":(()=>{let J=L(N,"slide-id");if(R(J))return J;else return w1(v0)})(),"selected-speaker":L(N,"selected-speaker")}}},Q0=s0(Z1(a9,e9())),F8="presenter",v1=function(u){return _q(F8,function(W){return u(R(Y0(W))?w1(W).data:null)})},h8=function(u){return Rq(F8,u)},Sq=function(){return s9(),aw(F8,{"slide-id":L(d(Q0),"slide-id"),"selected-speaker":L(d(Q0),"selected-speaker")})},q6=function(){let u=L(d(Q0),"audience-members");if(R(Y0(u))){let W=Iw(u);return q0(Q0,N0,"selected-speaker",W),Sq()}},qW=function(){return F1("speaker","message",{command:"clear"})},$W=function(){let u=L(d(Q0),"selected-speaker"),W=L(d(Q0),"audience-members"),N=u;if(R(N))return Bw(function(J){return $1(J,u)},W);else return N},_5=function(){let u=L(d(Q0),"slide-id"),W=v0.indexOf(u);if(R(W))return W;else return 0},wW=function(){let u=_5(),W=jw(I0(v0)-1,u+1);return q0(Q0,N0,"slide-id",b0(v0,W)),Sq()},uW=function(){let u=_5(),W=hq(0,u-1);return q0(Q0,N0,"slide-id",b0(v0,W)),Sq()},WW=function(u){return q0(Q0,N0,"slide-id",u),Sq()},ZW=function(){return localStorage.removeItem("presenter-state"),q0(Q0,N0,"slide-id",w1(v0),"selected-speaker",null),Sq(),F1("control","reset",{timestamp:Date.now()})},p1=(()=>{let u=function(W){let N=[],J=arguments.length,H=0;while(!0){if(H<J){N.push(arguments[H]),H=H+1;continue}break}let K=1<N.length?N.slice(1):null;return u.cljs$core$IFn$_invoke$arity$variadic(arguments[0],K)};return u.cljs$core$IFn$_invoke$arity$variadic=function(W,N){return Fq(["button",Z1({class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 disabled:bg-gray-400"},W)],N)},u.cljs$lang$maxFixedArity=1,u})(),sw=function(u,W){let N=$1(u,L(d(Q0),"slide-id"));return[p1,{class:R(N)?"px-4 py-2 bg-green-600 text-white rounded-lg disabled:bg-gray-400":"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400","on-click":function(){return WW(u)},disabled:W},u]},GW=function(u){let W=L(d(Q0),"selected-speaker"),N=$W();return["div",{class:"p-3 bg-purple-900/50 border border-purple-700 rounded-lg space-y-2"},["h2",{class:"text-sm font-semibold text-purple-400"},"Selected Speaker"],R(W)?["div",{class:"flex items-center gap-2"},["span",{class:R(N)?"text-green-400":"text-red-400"},"●"],["span",{class:"font-mono text-sm truncate flex-1"},W],["span",{class:"text-xs text-gray-400"},R(N)?"online":"offline"]]:["div",{class:"text-gray-400 text-sm"},"No speaker selected"],["div",{class:"flex gap-2"},[p1,{"on-click":q6,disabled:u,class:"px-3 py-1 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 disabled:bg-gray-600"},R(W)?"Re-roll":"Select Random"],[p1,{"on-click":qW,disabled:u,class:"px-3 py-1 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-500 disabled:bg-gray-700"},"Clear Messages"]]]},$6=function(){let u=Vq(y1()),W=L(d(Q0),"slide-id"),N=_5(),J=W==="q3";if(R((()=>{let H=J;if(R(H)){let K=Vq(L(d(Q0),"selected-speaker"));if(K)return Y0(L(d(Q0),"audience-members"));else return K}else return H})()))q6();return["div",{class:"min-h-screen bg-gray-900 text-white"},["div",{class:"p-4 space-y-6 max-w-md mx-auto"},["h1",{class:"text-2xl font-bold"},"Presenter Controls"],["div",{class:"text-lg"},"Audience connected: ",L(d(Q0),"audience-count")],["div",{class:"space-y-2"},["h2",{class:"text-xl font-semibold"},"Current Slide"],["div",{class:"flex gap-2 items-center"},[p1,{"on-click":uW,disabled:u},"Prev"],[p1,{"on-click":wW,disabled:u},"Next"],["span",{class:"px-4 py-2 font-mono text-lg"},W],["span",{class:"text-gray-400"},"(",N+1,"/",I0(v0),")"]]],R(J)?[GW,u]:null,(()=>{let H=L(r9,W);if(R(H)){let K=H;return["div",{class:"p-3 bg-yellow-900/50 border border-yellow-700 rounded-lg"},["h2",{class:"text-sm font-semibold text-yellow-400 mb-2"},"Notes"],["div",{class:"space-y-1"},u0(function*(){for(let V of i(z1(W1,K))){let h=V,Y=b0(h,0,null),b=b0(h,1,null);yield["p",{class:"text-yellow-200"},b]}})]]}})(),["div",{class:"space-y-2"},["h2",{class:"text-xl font-semibold"},"All Slides"],["div",{class:"flex flex-col gap-2"},u0(function*(){for(let H of i(z1(W1,ew))){let K=H,V=b0(K,0,null),h=b0(K,1,null);yield R(u8(h))?[sw,h,u]:["div",{class:"flex gap-2"},u0(function*(){for(let Y of i(h))yield[sw,Y,u]})]}})]],["div",{class:"pt-4 border-t border-gray-700"},[p1,{class:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-600","on-click":function(){if(R(confirm("Reset all state for presenter, display, and audience?")))return ZW()},disabled:u},"Reset"]],[g1]]]},w6=function(){return G1(y0,"talk.presenter/connection",function(u,W,N,J){return q0(Q0,C1)}),Lq(F8,{"slide-id":L(d(Q0),"slide-id")}),Rq("audience",function(){return _q("audience",function(u){let W=Uw(function(N){return N.clientId},u);return q0(Q0,N0,"audience-count",I0(u),"audience-members",W)})})};var u6={"slide-id":null,"my-votes":{},"selected-speaker":null,"my-message":""},NW=function(){return localStorage.setItem("audience-state",JSON.stringify(k1(d(T0),["my-votes"])))},JW=function(){let u=localStorage.getItem("audience-state");if(R(u))return JSON.parse(u)},T0=s0(Z1(u6,JW())),XW=function(){return localStorage.removeItem("audience-state"),c1(T0,u6),v1(function(u){if(R(u))return q0(T0,N0,"slide-id",L(u,"slide-id"),"selected-speaker",L(u,"selected-speaker"))})},QW="audience",HW="speaker",UW="reactions",S5=function(u){return L(L(d(T0),"my-votes"),u)},KW=function(){return $1(Mq,L(d(T0),"selected-speaker"))},W6=function(u,W){let N=s0(null),J=function(H){let K=[],V=arguments.length,h=0;while(!0){if(h<V){K.push(arguments[h]),h=h+1;continue}break}let Y=0<K.length?K.slice(0):null;return J.cljs$core$IFn$_invoke$arity$variadic(Y)};return J.cljs$core$IFn$_invoke$arity$variadic=function(H){let K=d(N);if(R(K))clearTimeout(K);return c1(N,setTimeout(function(){return P1(u,H)},W))},J.cljs$lang$maxFixedArity=0,J},OW=function(u){return q0(T0,N0,"my-message",u),F1(HW,"message",{"client-id":Mq,message:u,timestamp:Date.now()})},VW=W6(function(u){return F1(UW,"reaction",{emoji:u,id:J0(Z8()),timestamp:Date.now()})},200),zW=W6(function(u,W){return F1("votes","vote",{"client-id":Mq,"question-id":u,value:W,timestamp:Date.now()})},100),T5=function(u,W){return q0(T0,Kq,["my-votes",u],W),NW(),zW(u,W)},E5=(()=>{let u=function(W){let N=[],J=arguments.length,H=0;while(!0){if(H<J){N.push(arguments[H]),H=H+1;continue}break}let K=1<N.length?N.slice(1):null;return u.cljs$core$IFn$_invoke$arity$variadic(arguments[0],K)};return u.cljs$core$IFn$_invoke$arity$variadic=function(W,N){return Fq(["button",Z1({class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 disabled:bg-gray-600",disabled:Vq(y1())},W)],N)},u.cljs$lang$maxFixedArity=1,u})(),FW=function(u,W){let N=S5(u),J=L(W,"options"),H=L(J,"min"),K=L(J,"max"),V=L(J,"unit"),h=L(J,"min-label"),Y=L(J,"max-label"),b=(()=>{let _=N;if(R(_))return _;else return H})(),S=function(_){let E=Math.min(K,Math.max(H,_));return T5(u,E)};return["div",{class:"space-y-4"},["h2",{class:"text-xl font-semibold text-center"},L(W,"text")],["div",{class:"flex items-center justify-center gap-2"},["input",{type:"number",min:H,max:K,value:b,class:"w-full text-4xl font-bold text-center border-b-2 border-gray-600 focus:border-blue-500 outline-none bg-transparent","on-change":function(_){let E=parseInt(_.target.value);if(R(isNaN(E)))return null;else return S(E)}}],R(V)?["span",{class:"text-xl text-gray-400"},V]:null],["div",{class:"space-y-1"},["input",{type:"range",min:H,max:K,value:b,class:"w-full h-3 bg-gray-700 rounded-lg appearance-none cursor-pointer","on-change":function(_){return S(parseInt(_.target.value))}}],["div",{class:"flex justify-between text-sm text-gray-400"},["span",(()=>{let _=h;if(R(_))return _;else return H})()],["span",(()=>{let _=Y;if(R(_))return _;else return K})()]]]]},hW=function(u,W){let N=S5(u);return["div",{class:"space-y-4"},["h2",{class:"text-xl font-semibold text-center"},L(W,"text")],["div",{class:"flex flex-col gap-2"},u0(function*(){for(let J of i(L(W,"options"))){let H=J;yield[E5,{class:R($1(H,N))?"px-4 py-2 bg-green-600 text-white rounded-lg":"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700","on-click":function(){return T5(u,H)}},H]}})]]},DW=function(u,W){let N=J0("text-input-",u),J=S5(u);return["div",{class:"space-y-4"},["h2",{class:"text-xl font-semibold text-center"},L(W,"text")],["div",{class:"flex flex-col gap-2"},["input",{id:N,type:"text",class:"px-4 py-2 border border-gray-600 rounded-lg bg-transparent",placeholder:"Type your answer..."}],[E5,{"on-click":function(){let H=document.getElementById(N),K=H.value;if(R(Y0(K)))return T5(u,K),H.value=""}},"Submit"],R(J)?["div",{class:"text-sm text-gray-400"},"Your answer: ",J]:null]]},Tq=function(u){let W=N1(u);switch(L(W,"kind")){case"scale":return[FW,u,W];case"choice":return[hW,u,W];case"text":return[DW,u,W];default:return["div","Unknown question type"]}},BW=function(){let W=L(d(T0),"my-message");return["div",{class:"p-4 bg-purple-900/50 border border-purple-500 rounded-lg space-y-3"},["div",{class:"flex items-center gap-2"},["span",{class:"text-purple-400 text-lg"},"✨"],["span",{class:"text-purple-300 font-semibold"},"You've been selected to share!"]],["textarea",{id:"speaker-message-input",class:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white resize-none focus:border-purple-500 focus:outline-none",rows:3,placeholder:"Share your thoughts...","default-value":W}],[E5,{class:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-600","on-click":function(){let N=document.getElementById("speaker-message-input"),J=N.value;if(R(Y0(J.trim())))return OW(J),N.value=""}},"Send Message"],R(Y0(W))?["div",{class:"text-xs text-gray-400"},"Your message is live on screen"]:null]},YW=["❤️","\uD83D\uDC4D","\uD83D\uDE2E","\uD83E\uDDE0"],IW=function(u){return["button",{class:"text-4xl p-3 hover:scale-125 transition-transform active:scale-90","on-click":function(){return VW(u)}},u]},jW=function(){return["div",{class:"text-center text-gray-400 space-y-8"},["div",["h2",{class:"text-xl"},"Waiting for next question..."],["p","The presenter will activate a question soon."]],["div",{class:"flex justify-center gap-4"},u0(function*(){for(let u of i(YW))yield[IW,u]})]]},AW=function(u){switch(u){case"q1":return[Tq,"q1"];case"q2":return[Tq,"q2"];case"q3":return["div",{class:"space-y-4"},[Tq,"q3"],R(KW())?[BW]:null];case"q4":return[Tq,"q4"];case"q5":return[Tq,"q5"];default:return[jW]}},Z6=function(){let u=L(d(T0),"slide-id");return["div",{class:"min-h-screen bg-gray-900 text-white"},["div",{class:"p-4 max-w-md mx-auto"},["h1",{class:"text-2xl font-bold mb-4 text-center"},"Vote"],[AW,u],[g1]]]},G6=function(){return G1(y0,"talk.audience/connection",function(u,W,N,J){return q0(T0,C1)}),Lq(QW),h8(function(){return v1(function(u){if(R(u))return q0(T0,N0,"slide-id",L(u,"slide-id"),"selected-speaker",L(u,"selected-speaker"))})}),h1("control",function(u){return XW()})};var jG=J6(),G$=Zu(),Hu=Ju(),AG=Qu();function N$(u,W,N,J,H){let K=[].slice.call(arguments,1),V=K.length,h=typeof K[V-1]==="function";if(!h&&!jG())throw Error("Callback required as last argument");if(h){if(V<2)throw Error("Too few arguments provided");if(V===2)H=N,N=W,W=J=void 0;else if(V===3)if(W.getContext&&typeof H>"u")H=J,J=void 0;else H=J,J=N,N=W,W=void 0}else{if(V<1)throw Error("Too few arguments provided");if(V===1)N=W,W=J=void 0;else if(V===2&&!W.getContext)J=N,N=W,W=void 0;return new Promise(function(Y,b){try{let S=G$.create(N,J);Y(u(S,W,J))}catch(S){b(S)}})}try{let Y=G$.create(N,J);H(null,u(Y,W,J))}catch(Y){H(Y)}}var LG=G$.create,RG=N$.bind(null,Hu.render),J$=N$.bind(null,Hu.renderToDataURL),_G=N$.bind(null,function(u,W,N){return AG.render(u,N)});function Uu(u,W){if(W===void 0)W=u,u="";if(W instanceof Array)return W.join(u);let N="",J=!1;for(let H of i(W)){if(J)N+=u;N+=H,J=!0}return N}function Ku(u,W){return u.endsWith(W)}var SG=(()=>{let u=location.pathname;if(R(Ku(u,"/")))return Aw(u,0,I0(u)-1);else return u})(),TG=J0(SG,"/persimmon.jpeg"),Ou="blog.bythe.rocks/talk/christmas",Vu={"slide-id":null,votes:{},"audience-count":0,"speaker-messages":[],reactions:[],"qr-code-data":null},EG=function(){return localStorage.setItem("display-state",JSON.stringify(k1(d(Z0),["votes"])))},cG=function(){let u=localStorage.getItem("display-state");if(R(u))return JSON.parse(u)},Z0=s0(Z1(Vu,cG())),PG=function(){let u=L(d(Z0),"audience-count");return localStorage.removeItem("display-state"),c1(Z0,N0(Vu,"audience-count",u)),v1(function(W){if(R(W))return q0(Z0,N0,"slide-id",L(W,"slide-id"))})},CG=function(u){let W=L(u,"client-id"),N=L(u,"question-id");return q0(Z0,function(J){return Fw(Kq(J,["votes",N,"latest-vote",W],u),["votes",N,"all-votes"],z5(Oq,[]),u)}),EG()},kG=function(u){if(R(L(u,"command")==="clear"))return q0(Z0,N0,"speaker-messages",[]);else return q0(Z0,$8,"speaker-messages",function(W){return e0(Vw(5,Xw(u,W)))})},nG=100,yG=4000,iG=function(u){let W=10+F5(80),N=N0(u,"x",W,"created-at",Date.now());return q0(Z0,$8,"reactions",function(J){return e0(zw(nG,Oq(J,N)))})},gG=function(){let W=Date.now()-yG;return q0(Z0,$8,"reactions",function(N){return Qw(function(J){return L(J,"created-at")>W},N)})},R8=function(u){return w8(S0(d(Z0),["votes",u,"latest-vote"]))},pG=function(u){let W=R8(u),N=u1("value",W);if(R(Y0(N)))return{count:I0(N),average:E1(Uq,N)/I0(N),distribution:h5(N)}},vG=function(u){return h5(u1("value",R8(u)))},xG=function(u){return u1("value",R8(u))},zu=function(u){return I0(R8(u))},dG=function(u){let W=S0(d(Z0),["votes",u,"all-votes"],[]),J=Dw("timestamp",W),H={},K=[];while(!0){if(R(Yw(J)))return K;else{let V=w1(J),h=L(V,"client-id"),Y=L(V,"value"),b=L(V,"timestamp"),S=N0(H,h,Y),_=w8(S),E=E1(Uq,_)/I0(_),$0=Nw(J),v=S,P=Oq(K,{timestamp:b,average:E,count:I0(S)});J=$0,H=v,K=P;continue}break}},tG=function(u){let W=u,N=L(W,"emoji"),J=L(W,"x"),H=L(W,"id"),K=L(W,"created-at"),h=-(Date.now()-K)/1000;return["div",{key:H,class:"absolute text-5xl pointer-events-none animate-float-up",style:{left:J0(J,"%"),bottom:"0%",transform:"translateX(-50%)","animation-delay":J0(h,"s")}},N]},fG=function(){let u=L(d(Z0),"reactions");return["div",{class:"fixed inset-0 overflow-hidden pointer-events-none z-50"},["style",`
       @keyframes float-up {
         0% { bottom: 0%; opacity: 1; }
         100% { bottom: 100%; opacity: 0; }
       }
       .animate-float-up {
         animation: float-up 4s linear forwards;
       }
     `],u0(function*(){for(let W of i(u))yield[tG,W]})]},O0=function(u){let W=L(d(Z0),"slide-id"),N=v0,J=N.indexOf(W),H=I0(N);return["div",{class:"w-screen h-screen bg-gray-900 text-white relative"},["div",{class:"w-full h-full flex items-center justify-center p-8"},u],["div",{class:"absolute bottom-4 left-4 text-gray-400 text-sm"},L(d(Z0),"audience-count")," \uD83D\uDC65"],["div",{class:"absolute bottom-4 right-4 text-gray-400 text-sm"},J+1," of ",H],[g1]]},mG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-7xl font-bold mb-8"},"Wisdom of the Crowd"],R(L(d(Z0),"qr-code-data"))?["img",{src:L(d(Z0),"qr-code-data"),class:"mx-auto mb-4 rounded-lg"}]:null,["p",{class:"text-2xl text-gray-400"},"Join at ",Ou]]]},oG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"What is this talk about?"]]]},lG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"What is Wisdom of the Crowd?"]]]},rG=function(){return[O0,["div",{class:"text-center space-y-8"},["p",{class:"text-4xl"},"Ask a crowd a question"],["p",{class:"text-4xl"},"get a surprisingly accurate answer back"]]]},aG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"First some ground rules"]]]},sG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"Independence"]]]},eG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"Diversity"]]]},qN=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"A ground truth exists"]]]},$N=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold mb-8"},"So what's the point?"],["p",{class:"text-3xl text-gray-400"},"Does this sound familiar to any widely used technology currently?"]]]},wN=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-6xl font-bold"},"Search Engines!"]]]},uN=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-6xl font-bold"},"LLMs"]]]},WN=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold mb-12"},"But not really"],["table",{class:"mx-auto text-2xl border-collapse"},["thead",["tr",{class:"border-b border-gray-600"},["th",{class:"px-8 py-4 text-left"}],["th",{class:"px-8 py-4"},"Wisdom of the Crowd"],["th",{class:"px-8 py-4"},"LLMs"]]],["tbody",["tr",{class:"border-b border-gray-700"},["td",{class:"px-8 py-4 text-left text-gray-400"},"Independence"],["td",{class:"px-8 py-4 text-green-400"},"✅"],["td",{class:"px-8 py-4 text-red-400"},"❌"]],["tr",{class:"border-b border-gray-700"},["td",{class:"px-8 py-4 text-left text-gray-400"},"Diversity"],["td",{class:"px-8 py-4 text-green-400"},"✅"],["td",{class:"px-8 py-4 text-green-400"},"✅"]],["tr",["td",{class:"px-8 py-4 text-left text-gray-400"},"Requires Ground Truth"],["td",{class:"px-8 py-4 text-green-400"},"✅"],["td",{class:"px-8 py-4 text-red-400"},"❌"]]]]]]},ZN=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-7xl font-bold"},"The end"]]]},GN=function(){let u=L(d(Z0),"speaker-messages"),W=K5(function(N){return Y0(L(N,"message"))},u);if(R(Y0(W)))return["div",{class:"absolute top-8 right-8 max-w-md space-y-3"},["div",{class:"bg-gray-800 rounded-2xl p-3 shadow-xl border border-gray-700"},["div",{class:"flex items-center gap-3"},["div",{class:"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-lg"},"\uD83C\uDF1F"],["div",["div",{class:"font-bold text-white"},"Cool influencer"],["div",{class:"text-gray-400 text-sm"},"Live from the audience"]]]],u0(function*(){for(let N of i(z1(W1,W))){let J=N,H=b0(J,0,null),K=b0(J,1,null);yield(()=>{return["div",{class:"bg-gray-800 rounded-xl p-3 shadow-lg border border-gray-700",style:{opacity:(100-H*20)/100}},["div",{class:"text-white text-lg leading-relaxed"},L(K,"message")]]})()}})]},NN=function(){let u=N1("q3"),W=zu("q3"),N=L(d(Z0),"audience-count");return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold mb-8"},L(u,"text")],["p",{class:"text-2xl text-gray-400"},W," / ",N," Responses Received"],[GN]]]},o1=(()=>{let u=function(...W){switch(W.length){case 1:return u.cljs$core$IFn$_invoke$arity$1(W[0]);case 2:return u.cljs$core$IFn$_invoke$arity$2(W[0],W[1]);case 3:return u.cljs$core$IFn$_invoke$arity$3(W[0],W[1],W[2]);default:throw Error(J0("Invalid arity: ",W.length))}};return u.cljs$core$IFn$_invoke$arity$1=function(W){return o1(W,null,null)},u.cljs$core$IFn$_invoke$arity$2=function(W,N){return o1(W,N,null)},u.cljs$core$IFn$_invoke$arity$3=function(W,N,J){let H=N1(W),K=zu(W),V=L(d(Z0),"audience-count");return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold mb-4"},L(H,"text")],R(J)?["p",{class:"text-2xl text-gray-400 italic mb-8"},J]:null,R(N)?["img",{src:N,class:"max-h-64 mx-auto mb-8 rounded-lg"}]:null,["p",{class:"text-2xl text-gray-400"},K," / ",V," Responses Received"]]]},u.cljs$lang$maxFixedArity=3,u})(),Fu=(()=>{let u=function(...W){switch(W.length){case 2:return u.cljs$core$IFn$_invoke$arity$2(W[0],W[1]);case 3:return u.cljs$core$IFn$_invoke$arity$3(W[0],W[1],W[2]);default:throw Error(J0("Invalid arity: ",W.length))}};return u.cljs$core$IFn$_invoke$arity$2=function(W,N){return Fu(W,N,null)},u.cljs$core$IFn$_invoke$arity$3=function(W,N,J){let H=pG(W),K=S0(N,["options","min"]),V=S0(N,["options","max"]),h=S0(N,["options","unit"]),Y=S0(N,["options","min-label"]),b=S0(N,["options","max-label"]),S=V-K,_=(()=>{let P=S0(N,["options","bin-size"]);if(R(P))return P;else return Math.ceil((S+1)/Math.min(10,S+1))})(),E=Math.ceil((S+1)/_),$0=e0(u0(function*(){for(let P of i(O5(E))){let f=P;yield(()=>{let g=K+f*_,B=Math.min(V,g+(_-1));return{start:g,end:B,count:R(H)?E1(Uq,u0(function*(){for(let a of i(O5(g,B+1))){let G0=a;yield L(L(H,"distribution"),G0,0)}})):0}})()}})),v=P1(hq,1,u1("count",$0));if(R(H))return["div",{class:"text-center space-y-4"},["div",{class:"flex items-baseline justify-center gap-6"},["div",{class:"text-8xl font-bold text-blue-400"},L(H,"average").toFixed(1),R(h)?["span",{class:"text-4xl ml-2"},h]:null],R(J)?["div",{class:"text-4xl text-green-400"},"(",J,R(h)?["span",{class:"text-2xl ml-1"},h]:null,")"]:null],["div",{class:"text-xl text-gray-400"},"Average from ",L(H,"count")," responses"],["div",{class:"flex justify-center items-end gap-1 mt-8 px-4"},u0(function*(){for(let P of i($0)){let f=P,g=L(f,"start"),B=L(f,"end"),a=L(f,"count");yield(()=>{let G0=v>0?150*(a/v):0;return["div",{class:"flex-1 text-center min-w-0"},["div",{class:"bg-blue-500 rounded-t mx-auto",style:{height:J0(G0,"px")}}],["div",{class:"text-xs text-gray-400 mt-1 truncate"},R($1(g,B))?g:J0(g,"-",B)]]})()}})],R((()=>{let P=Y;if(R(P))return P;else return b})())?["div",{class:"flex justify-between text-sm text-gray-400 mt-2 px-4"},["span",(()=>{let P=Y;if(R(P))return P;else return""})()],["span",(()=>{let P=b;if(R(P))return P;else return""})()]]:null];else return["div",{class:"text-2xl text-gray-500"},"No responses yet"]},u.cljs$lang$maxFixedArity=3,u})(),JN=function(u,W){let N=vG(u),J=E1(Uq,w8(N));if(J>0)return["div",{class:"w-full max-w-2xl space-y-4"},u0(function*(){for(let H of i(L(W,"options"))){let K=H;yield(()=>{let V=L(N,K,0),h=J>0?100*(V/J):0;return["div",{class:"flex items-center gap-4"},["div",{class:"w-40 text-right text-lg"},K],["div",{class:"flex-1 bg-gray-700 rounded h-10"},["div",{class:"bg-blue-500 h-10 rounded flex items-center justify-end pr-2",style:{width:J0(h,"%")}},V>0?["span",{class:"text-sm font-bold"},V]:null]],["div",{class:"w-16 text-gray-400"},h.toFixed(0),"%"]]})()}})];else return["div",{class:"text-2xl text-gray-500"},"No responses yet"]},XN=function(u){let W=xG(u);if(R(Y0(W)))return["div",{class:"w-full max-w-2xl max-h-96 overflow-y-auto space-y-2"},u0(function*(){for(let N of i(z1(W1,W))){let J=N,H=b0(J,0,null),K=b0(J,1,null);yield["div",{class:"p-3 bg-gray-700 rounded text-lg"},K]}})];else return["div",{class:"text-2xl text-gray-500"},"No responses yet"]},m1=(()=>{let u=function(...W){switch(W.length){case 1:return u.cljs$core$IFn$_invoke$arity$1(W[0]);case 2:return u.cljs$core$IFn$_invoke$arity$2(W[0],W[1]);default:throw Error(J0("Invalid arity: ",W.length))}};return u.cljs$core$IFn$_invoke$arity$1=function(W){return m1(W,null)},u.cljs$core$IFn$_invoke$arity$2=function(W,N){let J=N1(W);return[O0,["div",{class:"text-center w-full"},["h1",{class:"text-4xl font-bold mb-8"},L(J,"text")],(()=>{switch(L(J,"kind")){case"scale":return[Fu,W,J,N];case"choice":return[JN,W,J];case"text":return[XN,W];default:return["div","Unknown question type"]}})()]]},u.cljs$lang$maxFixedArity=2,u})(),QN=function(u,W){let N=dG(u),J=N1(u),H=S0(J,["options","min"]),K=S0(J,["options","max"]),V=S0(J,["options","unit"]),h=800,Y=400,b=60,S=680,_=280;if(R(Y0(N))){let E=L(w1(N),"timestamp"),$0=L(eq(N),"timestamp"),v=hq(1,$0-E),P=K-H,f=function(s){return 60+680*((s-E)/v)},g=function(s){return 340-280*((s-H)/P)},B=z1(function(s,W0){let m=W0,H0=L(m,"timestamp"),Q=L(m,"average"),z0=f(H0),i0=g(Q);if(s===0)return J0("M ",z0," ",i0);else return J0("L ",z0," ",i0)},N),a=Uu(" ",B),G0=L(eq(N),"average");return["div",{class:"w-full flex flex-col items-center"},["svg",{width:800,height:400,class:"bg-gray-800 rounded-lg"},["line",{x1:60,y1:60,x2:60,y2:340,stroke:"#4B5563","stroke-width":2}],["line",{x1:60,y1:340,x2:740,y2:340,stroke:"#4B5563","stroke-width":2}],u0(function*(){for(let s of i([H,(H+K)/2,K])){let W0=s;yield["text",{x:50,y:g(W0),fill:"#9CA3AF","text-anchor":"end","dominant-baseline":"middle","font-size":14},W0]}}),R(W)?["g",["line",{x1:60,y1:g(W),x2:740,y2:g(W),stroke:"#34D399","stroke-width":2,"stroke-dasharray":"8,4"}],["text",{x:750,y:g(W),fill:"#34D399","dominant-baseline":"middle","font-size":14},J0(W,R(V)?V:null)]]:null,["path",{d:a,fill:"none",stroke:"#60A5FA","stroke-width":3}],u0(function*(){for(let s of i(N)){let W0=s,m=L(W0,"timestamp"),H0=L(W0,"average");yield["circle",{cx:f(m),cy:g(H0),r:4,fill:"#60A5FA"}]}}),["text",{x:f(L(eq(N),"timestamp"))+10,y:g(G0),fill:"#60A5FA","dominant-baseline":"middle","font-size":16,"font-weight":"bold"},G0.toFixed(1)]],["div",{class:"mt-4 text-xl text-gray-400"},"Average over ",I0(N)," responses"]]}else return["div",{class:"text-2xl text-gray-500"},"No responses yet"]},X$=function(u,W){let N=N1(u);return[O0,["div",{class:"text-center w-full"},["h1",{class:"text-4xl font-bold mb-8"},"Convergence Over Time"],[QN,u,W]]]},HN=function(u){return[O0,["div",{class:"text-center"},["h1",{class:"text-6xl font-bold font-mono"},u]]]},UN=function(u){switch(u){case"title":return[mG];case"about":return[oG];case"wotc":return[lG];case"q1":return[o1,"q1"];case"q1-results":return[m1,"q1"];case"wotc-answer":return[rG];case"rules":return[aG];case"q2":return[o1,"q2",TG];case"q2-results":return[m1,"q2",221];case"independence":return[sG];case"q3":return[NN];case"q3-results":return[m1,"q3",1953];case"q3-trend":return[X$,"q3",1953];case"diversity":return[eG];case"q4":return[o1,"q4"];case"q4-results":return[m1,"q4",73];case"q4-trend":return[X$,"q4",73];case"ground-truth":return[qN];case"q5":return[o1,"q5"];case"q5-results":return[m1,"q5"];case"q5-trend":return[X$,"q5",null];case"point":return[$N];case"search-engines":return[wN];case"llms":return[uN];case"but-not-really":return[WN];case"the-end":return[ZN];default:return[HN,u]}},hu=function(){let u=L(d(Z0),"slide-id");return["div",{class:"relative"},R(u)?[UN,u]:[O0,["div",{class:"text-2xl text-gray-500"},"Waiting for presenter..."]],[fG]]},Du=function(){return J$(J0("https://",Ou),{width:200,margin:1}).then(function(u){return q0(Z0,N0,"qr-code-data",u)}).catch(function(u){return a0("QR code generation failed:",u)}),G1(y0,"talk.display/connection",function(u,W,N,J){return q0(Z0,C1)}),Rq("audience",function(){return _q("audience",function(u){return q0(Z0,N0,"audience-count",I0(u))})}),h8(function(){return v1(function(u){if(R(u))return q0(Z0,N0,"slide-id",L(u,"slide-id"))})}),h1("votes",CG),h1("speaker",kG),h1("reactions",iG),h1("control",function(u){return PG()}),setInterval(gG,5000)};var ON="1tATiA.Rlyw7w:ZAjKA1HQea3nu2jtBE0-u_WVMXWtF4ONodw_MZn4kc0",VN=function(){let u=new URLSearchParams(location.search);if(R(u.get("display")))return"display";else if(R(u.get("control")))return"presenter";else return"audience"},Q$=VN(),zN=function(){let u=Q$;switch(u){case"display":return[hu];case"presenter":return[$6];case"audience":return[Z6];default:throw Error(J0("No matching clause: ",u))}},Bu=function(){return tw(document.getElementById("app"),[zN])},FN=(()=>{let u=Q$;switch(u){case"display":return Z0;case"presenter":return Q0;case"audience":return T0;default:throw Error(J0("No matching clause: ",u))}})();G1(FN,"talk.app/render",function(u,W,N,J){return Bu()});var hN=function(){Bu(),rw(ON);let u=Q$;switch(u){case"display":return Du();case"presenter":return w6();case"audience":return G6();default:throw Error(J0("No matching clause: ",u))}};hN();export{Q$ as role,Bu as render,hN as init_BANG_,VN as get_role,FN as current_state,zN as app,ON as ABLY_API_KEY};

//# debugId=02796A2075D36B6F64756E2164756E21
