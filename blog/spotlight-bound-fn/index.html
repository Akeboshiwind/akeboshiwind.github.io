<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config content="/browserconfig.xml"><meta name=theme-color content="#ffffff"><title>Clojure Function Spotlight: bound-fn | Blog by the Rocks</title>
<meta name=title content="Clojure Function Spotlight: bound-fn"><meta name=description content="While reading some internal code at JUXT I came across a function I&rsquo;d not seen before: bound-fn
After researching a little it turns out to be quite interesting!
Starting with a definition

(bound-fn & fntail)
Returns a function defined by the given fntail, which will install the
same bindings in effect as in the thread at the time bound-fn was called.
This may be used to define a helper function which runs on a different
thread, but needs the same bindings in place."><meta name=keywords content><meta property="og:url" content="https://blog.bythe.rocks/blog/spotlight-bound-fn/"><meta property="og:site_name" content="Blog by the Rocks"><meta property="og:title" content="Clojure Function Spotlight: bound-fn"><meta property="og:description" content="While reading some internal code at JUXT I came across a function Iâ€™d not seen before: bound-fn
After researching a little it turns out to be quite interesting!
Starting with a definition (bound-fn & fntail)
Returns a function defined by the given fntail, which will install the same bindings in effect as in the thread at the time bound-fn was called. This may be used to define a helper function which runs on a different thread, but needs the same bindings in place."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-11-23T00:00:00+00:00"><meta property="article:modified_time" content="2023-11-23T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Clojure Function Spotlight: bound-fn"><meta name=twitter:description content="While reading some internal code at JUXT I came across a function Iâ€™d not seen before: bound-fn
After researching a little it turns out to be quite interesting!
Starting with a definition (bound-fn & fntail)
Returns a function defined by the given fntail, which will install the same bindings in effect as in the thread at the time bound-fn was called. This may be used to define a helper function which runs on a different thread, but needs the same bindings in place."><meta itemprop=name content="Clojure Function Spotlight: bound-fn"><meta itemprop=description content="While reading some internal code at JUXT I came across a function Iâ€™d not seen before: bound-fn
After researching a little it turns out to be quite interesting!
Starting with a definition (bound-fn & fntail)
Returns a function defined by the given fntail, which will install the same bindings in effect as in the thread at the time bound-fn was called. This may be used to define a helper function which runs on a different thread, but needs the same bindings in place."><meta itemprop=datePublished content="2023-11-23T00:00:00+00:00"><meta itemprop=dateModified content="2023-11-23T00:00:00+00:00"><meta itemprop=wordCount content="490"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#000;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style><link rel=alternate type=application/rss+xml href=https://blog.bythe.rocks/blog/index.xml title="Blog by the Rocks"><style>pre code{padding:0!important;margin:0!important}pre{padding:1em!important;background-color:transparent!important}.code-with-filename{position:relative}.codeblock-name{font-size:.8em;color:gray;position:absolute;top:.5em;left:1em;z-index:1}.code-with-filename pre{position:relative;padding-top:1em!important}.admonition{margin:1.5rem 0;padding:.8rem;border-left:.25rem solid;border-radius:.3rem;overflow:hidden}.admonition-title{font-weight:700;margin-bottom:.5rem}.admonition-content p:last-child{margin-bottom:0}.admonition-info{background-color:rgba(85,149,214,.1);border-left-color:#5595d6}.admonition-info .admonition-title{color:#5595d6}.admonition-warning{background-color:rgba(255,185,0,.1);border-left-color:#ffb900}.admonition-warning .admonition-title{color:#ffb900}.admonition-danger{background-color:rgba(231,76,60,.1);border-left-color:#e74c3c}.admonition-danger .admonition-title{color:#e74c3c}.admonition-success{background-color:rgba(46,204,113,.1);border-left-color:#2ecc71}.admonition-success .admonition-title{color:#2ecc71}.admonition-note{background-color:rgba(149,165,166,.1);border-left-color:#95a5a6}.admonition-note .admonition-title{color:#95a5a6}@media(prefers-color-scheme:dark){.admonition-info{background-color:rgba(85,149,214,.15);border-left-color:#5595d6}.admonition-info .admonition-title{color:#78aee2}.admonition-warning{background-color:rgba(255,185,0,.15);border-left-color:#ffb900}.admonition-warning .admonition-title{color:#ffc426}.admonition-danger{background-color:rgba(231,76,60,.15);border-left-color:#e74c3c}.admonition-danger .admonition-title{color:#e95e4f}.admonition-success{background-color:rgba(46,204,113,.15);border-left-color:#2ecc71}.admonition-success .admonition-title{color:#40d47e}.admonition-note{background-color:rgba(149,165,166,.15);border-left-color:#95a5a6}.admonition-note .admonition-title{color:#a4b2b3}}</style></head><body><header><a href=/ class=title><h2>Blog by the Rocks</h2></a><nav><a href=/>Home</a>
<a href=/blog/>Blog</a>
<a href=/tools/>Tools</a>
<a href=https://blog.bythe.rocks/blog/index.xml>Feed</a></nav></header><main><h1>Clojure Function Spotlight: bound-fn</h1><p><i><time datetime=2023-11-23>2023-11-23</time></i></p><content><p>While reading some internal code at <a href=https://juxt.pro>JUXT</a> I came across a function I&rsquo;d not seen before: <code>bound-fn</code></p><p>After researching a little it turns out to be quite interesting!</p><h2 id=starting-with-a-definition>Starting with a definition</h2><blockquote><p><code>(bound-fn & fntail)</code></p><p>Returns a function defined by the given fntail, which will install the
same bindings in effect as in the thread at the time bound-fn was called.
This may be used to define a helper function which runs on a different
thread, but needs the same bindings in place.</p><ul><li><a href=https://github.com/clojure/clojure/blob/ce55092f2b2f5481d25cff6205470c1335760ef6/src/clj/clojure/core.clj#L2023>Clojure Source</a></li></ul></blockquote><p>I don&rsquo;t know about you but mostly that goes in one ear and out the other.</p><p>My current understanding of <code>bound-fn</code> is like this: it&rsquo;s like a normal <a href=https://clojure.org/guides/learn/functions#_closures>closure</a>, but with more <em>reach</em>.</p><h2 id=examples>Examples</h2><p>An example is worth a thousand words of documentation:</p><p>(Thank you <a href=https://clojuredocs.org>ClojureDocs</a>, I don&rsquo;t know what I would do without you!).</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020;font-weight:700>def </span><span style=color:#666>^</span><span style=color:#517918>:dynamic</span> <span style=color:#bb60d5>*a*</span> <span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020>binding </span>[<span style=color:#bb60d5>*a*</span> <span style=color:#40a070>2</span>]
</span></span><span style=display:flex><span>  (<span style=color:#007020;font-weight:700>let </span>[<span style=color:#bb60d5>b</span> <span style=color:#40a070>3</span>]
</span></span><span style=display:flex><span>    (<span style=color:#007020;font-weight:700>def </span><span style=color:#bb60d5>f1</span> (<span style=color:#007020;font-weight:700>fn </span>[] {<span style=color:#517918>:a</span> <span style=color:#bb60d5>*a*</span> <span style=color:#517918>:b</span> <span style=color:#bb60d5>b</span>}))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#06287e>f1</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; =&gt; {:a 1, :b 3}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020>binding </span>[<span style=color:#bb60d5>*a*</span> <span style=color:#40a070>2</span>]
</span></span><span style=display:flex><span>  (<span style=color:#007020;font-weight:700>let </span>[<span style=color:#bb60d5>b</span> <span style=color:#40a070>3</span>]
</span></span><span style=display:flex><span>    (<span style=color:#007020;font-weight:700>def </span><span style=color:#bb60d5>f2</span> (<span style=color:#06287e>bound-fn</span> [] {<span style=color:#517918>:a</span> <span style=color:#bb60d5>*a*</span> <span style=color:#517918>:b</span> <span style=color:#bb60d5>b</span>}))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#06287e>f2</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; =&gt; {:a 2, :b 3}</span>
</span></span></code></pre></div><p>A little contrived, but we can see here that while <code>fn</code> didn&rsquo;t take the <code>*a*</code> binding with it, the <code>bound-fn</code> did.</p><p>One more example to show how this is used in a threading context:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020;font-weight:700>def </span><span style=color:#666>^</span><span style=color:#517918>:dynamic</span> <span style=color:#bb60d5>*a*</span> <span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>f</span> [] (<span style=color:#007020>println </span><span style=color:#bb60d5>*a*</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#06287e>f</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; =&gt; 1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020>binding </span>[<span style=color:#bb60d5>*a*</span> <span style=color:#40a070>2</span>]
</span></span><span style=display:flex><span>  (<span style=color:#06287e>f</span>))
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; =&gt; 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020>binding </span>[<span style=color:#bb60d5>*a*</span> <span style=color:#40a070>2</span>]
</span></span><span style=display:flex><span>  (<span style=color:#06287e>.start</span> (<span style=color:#06287e>Thread.</span> <span style=color:#bb60d5>f</span>)))
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; =&gt; 1</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; If you didn&#39;t see this in your repl, maybe try this: https://stackoverflow.com/a/26744120</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020>binding </span>[<span style=color:#bb60d5>*a*</span> <span style=color:#40a070>2</span>]
</span></span><span style=display:flex><span>  (<span style=color:#06287e>.start</span> (<span style=color:#06287e>Thread.</span> (<span style=color:#06287e>bound-fn*</span> <span style=color:#bb60d5>f</span>))))
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; =&gt; 2</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; As this has captured the parent bindings, *out* should also be captured so this should print in your repl even if the above did not.</span>
</span></span></code></pre></div><p>This seems kinda handy!</p><p>For example, say you&rsquo;ve got some dynamic variable and you&rsquo;re using some lazy functions.
If you realise the value in the incorrect scope:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020;font-weight:700>def </span><span style=color:#666>^</span><span style=color:#517918>:dynamic</span> <span style=color:#bb60d5>*a*</span> <span style=color:#bb60d5>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020>binding </span>[<span style=color:#bb60d5>*a*</span> <span style=color:#40a070>1</span>]
</span></span><span style=display:flex><span>  (<span style=color:#06287e>-&gt;&gt;</span> (<span style=color:#007020>range </span><span style=color:#40a070>10</span>)
</span></span><span style=display:flex><span>       (<span style=color:#007020>map </span><span style=color:#666>#</span>(<span style=color:#007020>+ </span><span style=color:#bb60d5>*a*</span> <span style=color:#bb60d5>%</span>))))
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; (err) Error printing return value (NullPointerException) at clojure.lang.Numbers/ops (Numbers.java:1095).</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; (err) Cannot invoke &#34;Object.getClass()&#34; because &#34;x&#34; is null</span>
</span></span></code></pre></div><p>(Side note, that error isn&rsquo;t very helpful ðŸ¤”)</p><p>Oh no!
But <code>bound-fn*</code> comes to the rescue:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020>binding </span>[<span style=color:#bb60d5>*a*</span> <span style=color:#40a070>1</span>]
</span></span><span style=display:flex><span>  (<span style=color:#06287e>-&gt;&gt;</span> (<span style=color:#007020>range </span><span style=color:#40a070>10</span>)
</span></span><span style=display:flex><span>       (<span style=color:#007020>map </span>(<span style=color:#06287e>bound-fn*</span> <span style=color:#666>#</span>(<span style=color:#007020>+ </span><span style=color:#bb60d5>*a*</span> <span style=color:#bb60d5>%</span>)))))
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; =&gt; (1 2 3 4 5 6 7 8 9 10)</span>
</span></span></code></pre></div><p>And now our (imaginary) problem is solved!</p><h2 id=conclusion>Conclusion</h2><p>Obviously this isn&rsquo;t a function you or I are going to use every day.
But when you need it, it&rsquo;s a handy tool to have in your belt!</p><p>I find that clojure core has lots of interesting treasures, many libraries do!
It&rsquo;s exciting when you find a new function, testing what it can do and thinking about how it could help you is fun.</p><p>Make sure to let me know if you find anything interesting, or find an interesting use for <code>bound-fn</code> in your code.</p></content><p></p></main><footer></footer></body></html>