<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config content="/browserconfig.xml"><meta name=theme-color content="#ffffff"><title>Solving Container Update Woes with Clojure and Babashka | Blog by the Rocks</title>
<meta name=title content="Solving Container Update Woes with Clojure and Babashka"><meta name=description content="At home I run a small server for running home assistant and other small projects, but I&rsquo;ve been running into a problem recently: updates.
All the containers I have running in my system run with specific version tags.
I do this because I prefer to manually update each container as a new version comes out.
That way I&rsquo;m up to date on new features (and can stay mostly on top of breaking changes üòÖ)."><meta name=keywords content><meta property="og:url" content="https://blog.bythe.rocks/blog/bb-docker-image-updates/"><meta property="og:site_name" content="Blog by the Rocks"><meta property="og:title" content="Solving Container Update Woes with Clojure and Babashka"><meta property="og:description" content="At home I run a small server for running home assistant and other small projects, but I‚Äôve been running into a problem recently: updates.
All the containers I have running in my system run with specific version tags. I do this because I prefer to manually update each container as a new version comes out. That way I‚Äôm up to date on new features (and can stay mostly on top of breaking changes üòÖ)."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-10-15T00:00:00+00:00"><meta property="article:modified_time" content="2023-10-15T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Solving Container Update Woes with Clojure and Babashka"><meta name=twitter:description content="At home I run a small server for running home assistant and other small projects, but I‚Äôve been running into a problem recently: updates.
All the containers I have running in my system run with specific version tags. I do this because I prefer to manually update each container as a new version comes out. That way I‚Äôm up to date on new features (and can stay mostly on top of breaking changes üòÖ)."><meta itemprop=name content="Solving Container Update Woes with Clojure and Babashka"><meta itemprop=description content="At home I run a small server for running home assistant and other small projects, but I‚Äôve been running into a problem recently: updates.
All the containers I have running in my system run with specific version tags. I do this because I prefer to manually update each container as a new version comes out. That way I‚Äôm up to date on new features (and can stay mostly on top of breaking changes üòÖ)."><meta itemprop=datePublished content="2023-10-15T00:00:00+00:00"><meta itemprop=dateModified content="2023-10-15T00:00:00+00:00"><meta itemprop=wordCount content="1110"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#000;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style><style>pre code{padding:0!important;margin:0!important}pre{padding:1em!important;background-color:transparent!important}.code-with-filename{position:relative}.codeblock-name{font-size:.8em;color:gray;position:absolute;top:.5em;left:1em;z-index:1}.code-with-filename pre{position:relative;padding-top:1em!important}.admonition{margin:1.5rem 0;padding:.8rem;border-left:.25rem solid;border-radius:.3rem;overflow:hidden}.admonition-title{font-weight:700;margin-bottom:.5rem}.admonition-content p:last-child{margin-bottom:0}.admonition-info{background-color:rgba(85,149,214,.1);border-left-color:#5595d6}.admonition-info .admonition-title{color:#5595d6}.admonition-warning{background-color:rgba(255,185,0,.1);border-left-color:#ffb900}.admonition-warning .admonition-title{color:#ffb900}.admonition-danger{background-color:rgba(231,76,60,.1);border-left-color:#e74c3c}.admonition-danger .admonition-title{color:#e74c3c}.admonition-success{background-color:rgba(46,204,113,.1);border-left-color:#2ecc71}.admonition-success .admonition-title{color:#2ecc71}.admonition-note{background-color:rgba(149,165,166,.1);border-left-color:#95a5a6}.admonition-note .admonition-title{color:#95a5a6}@media(prefers-color-scheme:dark){.admonition-info{background-color:rgba(85,149,214,.15);border-left-color:#5595d6}.admonition-info .admonition-title{color:#78aee2}.admonition-warning{background-color:rgba(255,185,0,.15);border-left-color:#ffb900}.admonition-warning .admonition-title{color:#ffc426}.admonition-danger{background-color:rgba(231,76,60,.15);border-left-color:#e74c3c}.admonition-danger .admonition-title{color:#e95e4f}.admonition-success{background-color:rgba(46,204,113,.15);border-left-color:#2ecc71}.admonition-success .admonition-title{color:#40d47e}.admonition-note{background-color:rgba(149,165,166,.15);border-left-color:#95a5a6}.admonition-note .admonition-title{color:#a4b2b3}}</style></head><body><header><a href=/ class=title><h2>Blog by the Rocks</h2></a><nav><a href=/>Home</a>
<a href=/blog/>Blog</a>
<a href=/tools/>Tools</a></nav></header><main><h1>Solving Container Update Woes with Clojure and Babashka</h1><p><i><time datetime=2023-10-15>2023-10-15</time></i></p><content><p>At home I run a small server for running home assistant and other small projects, but I&rsquo;ve been running into a problem recently: updates.</p><p>All the containers I have running in my system run with specific version tags.
I do this because I prefer to manually update each container as a new version comes out.
That way I&rsquo;m up to date on new features (and can stay mostly on top of breaking changes üòÖ).</p><p>The problem with this setup is that solutions like <a href=https://containrrr.dev/watchtower/>watchtower</a> & <a href=https://github.com/crazy-max/diun>duin</a> (which are otherwise excellent) will <strong>not</strong> check for new tags.
These solutions also seemed way more complicated than they needed to be for my purposes.</p><p>All I want to do is:</p><ul><li>Look for updates</li><li>Notify me via telegram (so easy to integrate)</li><li>And possibly have some way of ignoring containers.</li></ul><h1 id=the-solution>The solution</h1><p>Write my own of course, that never goes wrong üòÖ.</p><p>I started by looking for some tools to actually query the data that I wanted:</p><ul><li>The list of labels for upstream docker containers</li><li>The list of locally running containers & their tags</li></ul><p>For the later just using the <code>docker</code> cli seemed like the simplest choice.
The former took a bit more searching.
At first I tried to look for a REST API and found that both dockerhub and github had one, but as they&rsquo;re different so I&rsquo;d have to write (and maintain) two interfaces.
Instead I looked at other tools and came across <a href=https://github.com/regclient/regclient>regclient</a> which provides <code>regctl tags ls</code> which was <em>exactly</em> what I was looking for (as you&rsquo;ll soon see).</p><h1 id=regctl>Regctl</h1><p>Let&rsquo;s first look at the output:</p><p>I actually ran it via docker rather than install it: <code>docker container run -i --rm ghcr.io/regclient/regctl:latest tag ls ubuntu</code></p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ regctl tags ls ubuntu
</span></span><span style=display:flex><span>10.04
</span></span><span style=display:flex><span>12.04
</span></span><span style=display:flex><span>12.04.5
</span></span><span style=display:flex><span>12.10
</span></span><span style=display:flex><span>13.04
</span></span><span style=display:flex><span>13.10
</span></span><span style=display:flex><span>14.04
</span></span><span style=display:flex><span>14.04.1
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>A newline separated list, what could be easier?
Let&rsquo;s parse it:</p><div class=code-with-filename><code class=codeblock-name>src/regctl.clj</code><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020;font-weight:700>ns </span><span style=color:#bb60d5>regctl</span>
</span></span><span style=display:flex><span>  (<span style=color:#517918>:require</span>
</span></span><span style=display:flex><span>    [<span style=color:#bb60d5>babashka.process</span> <span style=color:#517918>:refer</span> [<span style=color:#bb60d5>sh</span>]]
</span></span><span style=display:flex><span>    [<span style=color:#bb60d5>clojure.string</span> <span style=color:#517918>:as</span> <span style=color:#bb60d5>str</span>]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>regctl</span> [<span style=color:#666>&amp;</span> <span style=color:#bb60d5>args</span>]
</span></span><span style=display:flex><span>  (<span style=color:#007020>-&gt; </span>(<span style=color:#007020>apply </span><span style=color:#bb60d5>sh</span> <span style=color:#4070a0>&#34;regctl&#34;</span> <span style=color:#bb60d5>args</span>)
</span></span><span style=display:flex><span>      <span style=color:#517918>:out</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>tags</span> [<span style=color:#bb60d5>repo</span>]
</span></span><span style=display:flex><span>  (<span style=color:#06287e>-&gt;&gt;</span> (<span style=color:#06287e>regctl</span> <span style=color:#4070a0>&#34;tag&#34;</span> <span style=color:#4070a0>&#34;ls&#34;</span> <span style=color:#bb60d5>repo</span>)
</span></span><span style=display:flex><span>       <span style=color:#bb60d5>str/split-lines</span>
</span></span><span style=display:flex><span>       (<span style=color:#007020>remove </span><span style=color:#bb60d5>empty?</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#06287e>comment</span>
</span></span><span style=display:flex><span>  (<span style=color:#007020>count </span>(<span style=color:#06287e>tags</span> <span style=color:#4070a0>&#34;debian&#34;</span>)) <span style=color:#60a0b0;font-style:italic>; =&gt; 1893</span>
</span></span><span style=display:flex><span>  (<span style=color:#007020>count </span>(<span style=color:#06287e>tags</span> <span style=color:#4070a0>&#34;ghcr.io/akeboshiwind/rss-filter&#34;</span>)) <span style=color:#60a0b0;font-style:italic>; =&gt; 6</span>
</span></span><span style=display:flex><span>  (<span style=color:#007020>count </span>(<span style=color:#06287e>tags</span> <span style=color:#4070a0>&#34;does-not-exist&#34;</span>)) <span style=color:#60a0b0;font-style:italic>; =&gt; 0</span>
</span></span><span style=display:flex><span>  ,)</span></span></code></pre></div></div><p>Of course there&rsquo;s no error handling here, but I said I wanted this to be simple right?</p><h1 id=parsing-versions>Parsing versions</h1><p>So, given that I want to check for updates I&rsquo;ll need to know which tag is the latest version.
But how do I tell which tag <strong>is</strong> the latest version? They&rsquo;re just strings after all.</p><p>Different docker repos use all sorts of different systems, but most of them provide a plain <a href=https://semver.org/>semver</a> version tag.
For those that don&rsquo;t I&rsquo;ll figure out something in the future I guess üòÖ.</p><p>Writing some code to parse versions wasn&rsquo;t too hard, but it was fiddly getting the comparison right:</p><div class=code-with-filename><code class=codeblock-name>src/semver.clj</code><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020;font-weight:700>ns </span><span style=color:#bb60d5>semver</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>semver?</span> [<span style=color:#bb60d5>tag</span>]
</span></span><span style=display:flex><span>  (<span style=color:#007020>boolean </span>(<span style=color:#007020>re-matches </span><span style=color:#666>#</span><span style=color:#4070a0>&#34;^v?\d+(\.\d+(\.\d+)?)?$&#34;</span> <span style=color:#bb60d5>tag</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>semver</span> [<span style=color:#bb60d5>tag</span>]
</span></span><span style=display:flex><span>  (<span style=color:#007020>when-let </span>[<span style=color:#bb60d5>match</span> (<span style=color:#007020>re-find </span><span style=color:#666>#</span><span style=color:#4070a0>&#34;^v?(\d+)(\.(\d+)(\.(\d+))?)?$&#34;</span>
</span></span><span style=display:flex><span>                             <span style=color:#bb60d5>tag</span>)]
</span></span><span style=display:flex><span>    (<span style=color:#007020;font-weight:700>let </span>[[<span style=color:#bb60d5>_</span> <span style=color:#bb60d5>major</span> <span style=color:#bb60d5>_</span> <span style=color:#bb60d5>minor</span> <span style=color:#bb60d5>_</span> <span style=color:#bb60d5>patch</span>] <span style=color:#bb60d5>match</span>]
</span></span><span style=display:flex><span>      {<span style=color:#517918>:major</span> (<span style=color:#06287e>Integer/parseInt</span> <span style=color:#bb60d5>major</span>)
</span></span><span style=display:flex><span>       <span style=color:#517918>:minor</span> (<span style=color:#007020;font-weight:700>if </span><span style=color:#bb60d5>minor</span> (<span style=color:#06287e>Integer/parseInt</span> <span style=color:#bb60d5>minor</span>) <span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>       <span style=color:#517918>:patch</span> (<span style=color:#007020;font-weight:700>if </span><span style=color:#bb60d5>patch</span> (<span style=color:#06287e>Integer/parseInt</span> <span style=color:#bb60d5>patch</span>) <span style=color:#40a070>0</span>)})))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>compare-semver</span> [<span style=color:#bb60d5>a</span> <span style=color:#bb60d5>b</span>]
</span></span><span style=display:flex><span>  (<span style=color:#007020;font-weight:700>let </span>[<span style=color:#bb60d5>major</span> (<span style=color:#06287e>compare</span> (<span style=color:#517918>:major</span> <span style=color:#bb60d5>a</span>) (<span style=color:#517918>:major</span> <span style=color:#bb60d5>b</span>))]
</span></span><span style=display:flex><span>    (<span style=color:#007020;font-weight:700>if </span>(<span style=color:#007020>not= </span><span style=color:#bb60d5>major</span> <span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>      <span style=color:#bb60d5>major</span>
</span></span><span style=display:flex><span>      (<span style=color:#007020;font-weight:700>let </span>[<span style=color:#bb60d5>minor</span> (<span style=color:#06287e>compare</span> (<span style=color:#517918>:minor</span> <span style=color:#bb60d5>a</span>) (<span style=color:#517918>:minor</span> <span style=color:#bb60d5>b</span>))]
</span></span><span style=display:flex><span>        (<span style=color:#007020;font-weight:700>if </span>(<span style=color:#007020>not= </span><span style=color:#bb60d5>minor</span> <span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>          <span style=color:#bb60d5>minor</span>
</span></span><span style=display:flex><span>          (<span style=color:#06287e>compare</span> (<span style=color:#517918>:patch</span> <span style=color:#bb60d5>a</span>) (<span style=color:#517918>:patch</span> <span style=color:#bb60d5>b</span>)))))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>&gt;semver</span> [<span style=color:#bb60d5>a</span> <span style=color:#bb60d5>b</span>]
</span></span><span style=display:flex><span>  (<span style=color:#007020>&gt; </span>(<span style=color:#06287e>compare-semver</span> <span style=color:#bb60d5>a</span> <span style=color:#bb60d5>b</span>) <span style=color:#40a070>0</span>))</span></span></code></pre></div></div><p>I&rsquo;m not happy with that regex, maybe using a parser (for this and for docker later) would have been clearer?
Or maybe just using a library someone else wrote?
But I really wanted to get away with not using any libraries so this is fine üòÅ.</p><p>Now I can filter, sort & so on to my hearts content:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020;font-weight:700>let </span>[<span style=color:#bb60d5>tags</span> [<span style=color:#4070a0>&#34;1&#34;</span> <span style=color:#4070a0>&#34;1.2&#34;</span> <span style=color:#4070a0>&#34;1.2.3&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#4070a0>&#34;v1&#34;</span> <span style=color:#4070a0>&#34;v1.2&#34;</span> <span style=color:#4070a0>&#34;v1.2.3&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#4070a0>&#34;12&#34;</span> <span style=color:#4070a0>&#34;12.23&#34;</span> <span style=color:#4070a0>&#34;12.23.34&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#4070a0>&#34;test&#34;</span> <span style=color:#4070a0>&#34;1.2.3-SNAPSHOT&#34;</span> <span style=color:#4070a0>&#34;1.2.3.4&#34;</span>]]
</span></span><span style=display:flex><span>  (<span style=color:#007020>println </span><span style=color:#4070a0>&#34;count:&#34;</span> (<span style=color:#007020>count </span><span style=color:#bb60d5>tags</span>))
</span></span><span style=display:flex><span>  (<span style=color:#007020>println </span><span style=color:#4070a0>&#34;filtered:&#34;</span> (<span style=color:#06287e>-&gt;&gt;</span> <span style=color:#bb60d5>tags</span> (<span style=color:#007020>filter </span><span style=color:#bb60d5>semver?</span>) <span style=color:#bb60d5>count</span>))
</span></span><span style=display:flex><span>  (<span style=color:#007020>println </span><span style=color:#4070a0>&#34;latest:&#34;</span> (<span style=color:#06287e>-&gt;&gt;</span> <span style=color:#bb60d5>tags</span>
</span></span><span style=display:flex><span>                          (<span style=color:#007020>filter </span><span style=color:#bb60d5>semver?</span>)
</span></span><span style=display:flex><span>                          (<span style=color:#007020>map </span><span style=color:#bb60d5>semver</span>)
</span></span><span style=display:flex><span>                          (<span style=color:#007020>sort </span><span style=color:#bb60d5>compare-semver</span>)
</span></span><span style=display:flex><span>                          <span style=color:#bb60d5>last</span>))
</span></span><span style=display:flex><span>  (<span style=color:#007020>println </span><span style=color:#4070a0>&#34;(&gt; \&#34;1.2.3\&#34; \&#34;1.0\&#34;):&#34;</span> (<span style=color:#06287e>&gt;semver</span> (<span style=color:#06287e>semver</span> <span style=color:#4070a0>&#34;1.2.3&#34;</span>)
</span></span><span style=display:flex><span>                                             (<span style=color:#06287e>semver</span> <span style=color:#4070a0>&#34;1.0&#34;</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; (out) count: 12</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; (out) filtered: 9</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; (out) latest: {:major 12, :minor 23, :patch 34}</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>; (out) (&gt; &#34;1.2.3&#34; &#34;1.0&#34;): true</span>
</span></span></code></pre></div><h1 id=docker>Docker</h1><p>Next we&rsquo;re on to docker itself.
It posed a bit of difficulty first because I didn&rsquo;t really want to parse this:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker ps
</span></span><span style=display:flex><span>CONTAINER ID   IMAGE                              COMMAND                  CREATED             STATUS             PORTS                    NAMES
</span></span><span style=display:flex><span>739ac2d78713   ubuntu:20.04                       <span style=color:#4070a0>&#34;/bin/bash&#34;</span>              About an hour ago   Up About an hour                            quirky_fermat
</span></span><span style=display:flex><span>80f067bc14e8   ghcr.io/esphome/esphome:2023.9.3   <span style=color:#4070a0>&#34;/entrypoint.sh dash‚Ä¶&#34;</span>   <span style=color:#40a070>3</span> hours ago         Up <span style=color:#40a070>3</span> hours         6052/tcp                 interesting_galileo
</span></span><span style=display:flex><span>8fef78050a03   postgres                           <span style=color:#4070a0>&#34;docker-entrypoint.s‚Ä¶&#34;</span>   <span style=color:#40a070>3</span> hours ago         Up <span style=color:#40a070>3</span> hours         0.0.0.0:5432-&gt;5432/tcp   silly_carson
</span></span></code></pre></div><p>It turns out there&rsquo;s a lovely <code>--format</code> option that let&rsquo;s to format the output exactly how you&rsquo;d want to:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker ps --format <span style=color:#4070a0>&#39;{{.Image}}&#39;</span>
</span></span><span style=display:flex><span>ubuntu:20.04
</span></span><span style=display:flex><span>ghcr.io/esphome/esphome:2023.9.3
</span></span><span style=display:flex><span>postgres
</span></span></code></pre></div><p>Time to parse that using clojure:</p><div class=code-with-filename><code class=codeblock-name>src/docker.clj</code><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020;font-weight:700>ns </span><span style=color:#bb60d5>docker</span>
</span></span><span style=display:flex><span>  (<span style=color:#517918>:require</span>
</span></span><span style=display:flex><span>    [<span style=color:#bb60d5>babashka.process</span> <span style=color:#517918>:refer</span> [<span style=color:#bb60d5>sh</span>]]
</span></span><span style=display:flex><span>    [<span style=color:#bb60d5>clojure.string</span> <span style=color:#517918>:as</span> <span style=color:#bb60d5>str</span>]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>docker</span> [<span style=color:#666>&amp;</span> <span style=color:#bb60d5>args</span>]
</span></span><span style=display:flex><span>  (<span style=color:#007020>-&gt; </span>(<span style=color:#007020>apply </span><span style=color:#bb60d5>sh</span> <span style=color:#4070a0>&#34;docker&#34;</span> <span style=color:#bb60d5>args</span>)
</span></span><span style=display:flex><span>      <span style=color:#517918>:out</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>parse-ps</span> [<span style=color:#bb60d5>line</span>]
</span></span><span style=display:flex><span>  (<span style=color:#007020;font-weight:700>let </span>[[<span style=color:#bb60d5>image</span> <span style=color:#bb60d5>labels</span>] (<span style=color:#06287e>str/split</span> <span style=color:#bb60d5>line</span> <span style=color:#666>#</span><span style=color:#4070a0>&#34;\s+&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#bb60d5>labels</span> (<span style=color:#007020>when-not </span>(<span style=color:#06287e>empty?</span> <span style=color:#bb60d5>labels</span>)
</span></span><span style=display:flex><span>                 (<span style=color:#06287e>-&gt;&gt;</span> (<span style=color:#06287e>str/split</span> <span style=color:#bb60d5>labels</span> <span style=color:#666>#</span><span style=color:#4070a0>&#34;,&#34;</span>)
</span></span><span style=display:flex><span>                      (<span style=color:#007020>map </span><span style=color:#666>#</span>(<span style=color:#06287e>str/split</span> <span style=color:#bb60d5>%</span> <span style=color:#666>#</span><span style=color:#4070a0>&#34;=&#34;</span>))
</span></span><span style=display:flex><span>                      <span style=color:#60a0b0;font-style:italic>;; Set a default value for labels without a value</span>
</span></span><span style=display:flex><span>                      (<span style=color:#007020>map </span>(<span style=color:#007020;font-weight:700>fn </span>[[<span style=color:#bb60d5>k</span> <span style=color:#bb60d5>v</span>]] [<span style=color:#bb60d5>k</span> (<span style=color:#007020>or </span><span style=color:#bb60d5>v</span> <span style=color:#4070a0>&#34;&#34;</span>)]))
</span></span><span style=display:flex><span>                      (<span style=color:#007020>into </span>{})))]
</span></span><span style=display:flex><span>    {<span style=color:#517918>:image</span> <span style=color:#bb60d5>image</span>
</span></span><span style=display:flex><span>     <span style=color:#517918>:labels</span> <span style=color:#bb60d5>labels</span>}))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>ps</span> []
</span></span><span style=display:flex><span>  (<span style=color:#06287e>-&gt;&gt;</span> (<span style=color:#06287e>docker</span> <span style=color:#4070a0>&#34;ps&#34;</span> <span style=color:#4070a0>&#34;--format&#34;</span> <span style=color:#4070a0>&#34;{{.Image}} {{.Labels}}&#34;</span>)
</span></span><span style=display:flex><span>       <span style=color:#bb60d5>str/split-lines</span>
</span></span><span style=display:flex><span>       (<span style=color:#007020>map </span><span style=color:#bb60d5>parse-ps</span>)))</span></span></code></pre></div></div><p>I ended up adding <code>{{.Labels}}</code> too because I want to use them to ignore containers.</p><h1 id=putting-it-all-together>Putting it all together</h1><p>I have all the pieces, let&rsquo;s put them together.
First we want to get the latest tag for a given image:</p><div class=code-with-filename><code class=codeblock-name>src/core.cljs</code><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020;font-weight:700>ns </span><span style=color:#bb60d5>core</span>
</span></span><span style=display:flex><span>  (<span style=color:#517918>:require</span>
</span></span><span style=display:flex><span>    [<span style=color:#bb60d5>docker</span> <span style=color:#517918>:as</span> <span style=color:#bb60d5>d</span>]
</span></span><span style=display:flex><span>    [<span style=color:#bb60d5>regctl</span> <span style=color:#517918>:as</span> <span style=color:#bb60d5>r</span>]
</span></span><span style=display:flex><span>    [<span style=color:#bb60d5>semver</span> <span style=color:#517918>:refer</span> [<span style=color:#bb60d5>semver?</span> <span style=color:#bb60d5>semver</span> <span style=color:#bb60d5>compare-semver</span> <span style=color:#bb60d5>&gt;semver</span>]]
</span></span><span style=display:flex><span>    [<span style=color:#bb60d5>clojure.string</span> <span style=color:#517918>:as</span> <span style=color:#bb60d5>str</span>]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>latest-tag</span> [<span style=color:#bb60d5>repo</span>]
</span></span><span style=display:flex><span>  (<span style=color:#06287e>-&gt;&gt;</span> (<span style=color:#06287e>r/tags</span> <span style=color:#bb60d5>repo</span>)
</span></span><span style=display:flex><span>       (<span style=color:#007020>filter </span><span style=color:#bb60d5>semver?</span>)
</span></span><span style=display:flex><span>       (<span style=color:#007020>sort-by </span><span style=color:#bb60d5>semver</span> <span style=color:#bb60d5>compare-semver</span>)
</span></span><span style=display:flex><span>       <span style=color:#bb60d5>last</span>))</span></span></code></pre></div></div><p>Next, <code>docker ps</code> gives us both an image and a tag (but only sometimes) so let&rsquo;s parse those:</p><div class=code-with-filename><code class=codeblock-name>src/core.cljs</code><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020;font-weight:700>defn </span><span style=color:#bb60d5>name</span><span style=color:#666>&amp;</span><span style=color:#bb60d5>tag</span> [<span style=color:#bb60d5>full-name</span>]
</span></span><span style=display:flex><span>  (<span style=color:#007020;font-weight:700>let </span>[[<span style=color:#007020>name </span><span style=color:#bb60d5>tag</span>] (<span style=color:#06287e>str/split</span> <span style=color:#bb60d5>full-name</span> <span style=color:#666>#</span><span style=color:#4070a0>&#34;:&#34;</span>)]
</span></span><span style=display:flex><span>    {<span style=color:#517918>:name</span> <span style=color:#007020>name </span><span style=color:#517918>:tag</span> <span style=color:#bb60d5>tag</span>}))</span></span></code></pre></div></div><p>I&rsquo;m not super happy with that function name, but something like <code>image-name</code> seemed like it should really split out the <code>:registry</code> and <code>:repo</code> too which I don&rsquo;t want to do here.</p><p>Now that we <em>actually</em> have all the pieces, let&rsquo;s get our list of images.
Note that I&rsquo;ve ignored images that don&rsquo;t have tags. That&rsquo;s fine for my purposes.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020;font-weight:700>let </span>[<span style=color:#bb60d5>images</span> (<span style=color:#06287e>-&gt;&gt;</span> (<span style=color:#06287e>d/ps</span>)
</span></span><span style=display:flex><span>                  (<span style=color:#007020>remove </span><span style=color:#666>#</span>(<span style=color:#007020>-&gt; </span><span style=color:#bb60d5>%</span> <span style=color:#517918>:labels</span> (<span style=color:#007020>get </span><span style=color:#4070a0>&#34;version-checker.ignore&#34;</span>)))
</span></span><span style=display:flex><span>                  (<span style=color:#007020>map </span>(<span style=color:#007020>comp </span><span style=color:#bb60d5>name</span><span style=color:#666>&amp;</span><span style=color:#bb60d5>tag</span> <span style=color:#517918>:image</span>))
</span></span><span style=display:flex><span>                  (<span style=color:#007020>remove </span>(<span style=color:#007020>complement </span><span style=color:#517918>:tag</span>)))]
</span></span><span style=display:flex><span>  <span style=color:#bb60d5>...</span>)
</span></span></code></pre></div><p>Finally for each image let&rsquo;s get the <code>latest-tag</code> then see if that&rsquo;s newer than our current tag:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#007020;font-weight:700>let </span>[<span style=color:#bb60d5>images</span> (<span style=color:#06287e>-&gt;&gt;</span> (<span style=color:#06287e>d/ps</span>)
</span></span><span style=display:flex><span>                  (<span style=color:#007020>remove </span><span style=color:#666>#</span>(<span style=color:#007020>-&gt; </span><span style=color:#bb60d5>%</span> <span style=color:#517918>:labels</span> (<span style=color:#007020>get </span><span style=color:#4070a0>&#34;version-checker.ignore&#34;</span>)))
</span></span><span style=display:flex><span>                  (<span style=color:#007020>map </span>(<span style=color:#007020>comp </span><span style=color:#bb60d5>name</span><span style=color:#666>&amp;</span><span style=color:#bb60d5>tag</span> <span style=color:#517918>:image</span>))
</span></span><span style=display:flex><span>                  (<span style=color:#007020>remove </span>(<span style=color:#007020>complement </span><span style=color:#517918>:tag</span>)))]
</span></span><span style=display:flex><span>  (<span style=color:#007020>doseq </span>[{<span style=color:#517918>:keys</span> [<span style=color:#007020>name </span><span style=color:#bb60d5>tag</span>]} <span style=color:#bb60d5>images</span>]
</span></span><span style=display:flex><span>    (<span style=color:#007020>println </span><span style=color:#4070a0>&#34;Checking: &#34;</span> <span style=color:#007020>name </span><span style=color:#4070a0>&#34;:&#34;</span> <span style=color:#bb60d5>tag</span>)
</span></span><span style=display:flex><span>    (<span style=color:#007020;font-weight:700>let </span>[<span style=color:#bb60d5>latest-tag</span> (<span style=color:#06287e>latest-tag</span> <span style=color:#bb60d5>name</span>)]
</span></span><span style=display:flex><span>      (<span style=color:#007020>when </span>(<span style=color:#06287e>&gt;semver</span> (<span style=color:#06287e>semver</span> <span style=color:#bb60d5>latest-tag</span>) (<span style=color:#06287e>semver</span> <span style=color:#bb60d5>tag</span>))
</span></span><span style=display:flex><span>        (<span style=color:#007020>println </span><span style=color:#4070a0>&#34;Later tag found:&#34;</span> <span style=color:#bb60d5>latest-tag</span>)))))
</span></span></code></pre></div><p>And that&rsquo;s it!</p><p>Other than deployment and notifications. Maybe another time&mldr;</p><p>The complete code can be found <a href=https://github.com/Akeboshiwind/whale-watcher>here</a>.</p></content><p></p></main><footer></footer></body></html>