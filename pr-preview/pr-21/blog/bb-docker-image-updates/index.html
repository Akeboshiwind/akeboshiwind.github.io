<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett"><!-- Favicon --><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><!-- SEO --><title>Solving Container Update Woes with Clojure and Babashka | Blog by the Rocks</title><meta name="description" content="Solving Container Update Woes with Clojure and Babashka"><link rel="canonical" href="https://blog.bythe.rocks/pr-preview/pr-21/blog/bb-docker-image-updates/"><!-- RSS --><link rel="alternate" type="application/rss+xml" href="/pr-preview/pr-21/blog/rss.xml" title="Blog by the Rocks"><!-- Open Graph --><meta property="og:type" content="article"><meta property="og:url" content="https://blog.bythe.rocks/pr-preview/pr-21/blog/bb-docker-image-updates/"><meta property="og:title" content="Solving Container Update Woes with Clojure and Babashka | Blog by the Rocks"><meta property="og:description" content="Solving Container Update Woes with Clojure and Babashka"><meta property="og:site_name" content="Blog by the Rocks"><meta property="article:published_time" content="2023-10-15T00:00:00.000Z"><!-- Twitter --><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Solving Container Update Woes with Clojure and Babashka | Blog by the Rocks"><meta name="twitter:description" content="Solving Container Update Woes with Clojure and Babashka"><style>:root{--width: 720px;--font-main: Verdana, sans-serif;--font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;--bg: #fff;--text: #444;--heading: #222;--link: #3273dc;--link-visited: #8b6fcb;--code-bg: #f2f2f2;--code-text: #222;--border: #ddd}@media(prefers-color-scheme:dark){:root{--bg: #01242e;--text: #ddd;--heading: #eee;--link: #8cc2dd;--link-visited: #8b6fcb;--code-bg: #000;--code-text: #ddd;--border: #444}}*{box-sizing:border-box}html{font-family:var(--font-main);font-size:16px;line-height:1.6;color:var(--text);background:var(--bg)}body{margin:0 auto;padding:1.25rem;max-width:var(--width)}h1,h2,h3,h4,h5,h6{color:var(--heading);line-height:1.3;margin:1.5em 0 .5em}h1{font-size:1.75rem}h2{font-size:1.5rem}h3{font-size:1.25rem}a{color:var(--link);text-decoration:none}a:hover{text-decoration:underline}a:visited{color:var(--link-visited)}p{margin:1em 0}code{font-family:var(--font-mono);font-size:.9em;padding:.15em .3em;background:var(--code-bg);border-radius:3px}pre{background:var(--code-bg);padding:1em;border-radius:5px;overflow-x:auto;margin:1em 0}pre code{padding:0;background:none}ul,ol{padding-left:1.5em}li{margin:.25em 0}blockquote{border-left:3px solid var(--border);margin:1em 0;padding-left:1em;color:var(--text);font-style:italic}table{width:100%;border-collapse:collapse;margin:1em 0}th,td{border:1px solid var(--border);padding:.5em;text-align:left}img{max-width:100%;height:auto}hr{border:0;border-top:1px dashed var(--border);margin:2em 0}time{font-family:var(--font-mono);font-size:.9rem;color:var(--text)}header{margin-bottom:2em}header nav{display:flex;gap:1rem;flex-wrap:wrap}header .site-title{font-size:1.25rem;font-weight:700;color:var(--heading)}header .site-title:hover{text-decoration:none}footer{margin-top:3em;padding:1em 0;text-align:center;font-size:.875rem;color:var(--text);opacity:.7}.post-list{list-style:none;padding:0}.post-list li{display:flex;gap:1rem;margin:.5em 0;align-items:baseline}.post-list time{flex-shrink:0;width:7rem}.post-list a:visited{color:var(--link-visited)}.draft-marker{color:#c00;font-size:.8em;font-style:italic;margin-left:.5em}.code-with-filename{position:relative;margin:1em 0}.codeblock-name{font-family:var(--font-mono);font-size:.75em;color:#888;position:absolute;top:.5em;left:1em;z-index:1}.code-with-filename pre{padding-top:2em!important}.admonition{margin:1.5em 0;padding:.8em 1em;border-left:4px solid;border-radius:4px}.admonition-title{font-weight:700;margin-bottom:.5em}.admonition-content p:last-child{margin-bottom:0}.admonition-info{background:#5595d61a;border-color:#5595d6}.admonition-info .admonition-title{color:#5595d6}.admonition-warning{background:#ffb9001a;border-color:#ffb900}.admonition-warning .admonition-title{color:#ffb900}.admonition-danger{background:#e74c3c1a;border-color:#e74c3c}.admonition-danger .admonition-title{color:#e74c3c}.admonition-success{background:#2ecc711a;border-color:#2ecc71}.admonition-success .admonition-title{color:#2ecc71}.admonition-note{background:#95a5a61a;border-color:#95a5a6}.admonition-note .admonition-title{color:#95a5a6}@media(prefers-color-scheme:dark){.admonition-info{background:#5595d626}.admonition-info .admonition-title{color:#78aee2}.admonition-warning{background:#ffb90026}.admonition-warning .admonition-title{color:#ffc426}.admonition-danger{background:#e74c3c26}.admonition-danger .admonition-title{color:#e95e4f}.admonition-success{background:#2ecc7126}.admonition-success .admonition-title{color:#40d47e}.admonition-note{background:#95a5a626}.admonition-note .admonition-title{color:#a4b2b3}}
</style></head> <body> <header> <a href="/pr-preview/pr-21/" class="site-title">Blog by the Rocks</a> <nav> <a href="/pr-preview/pr-21/">Home</a><a href="/pr-preview/pr-21/blog/">Blog</a><a href="/pr-preview/pr-21/tools/">Tools</a><a href="/pr-preview/pr-21/blog/rss.xml">Feed</a> </nav> </header> <main>  <article> <h1> Solving Container Update Woes with Clojure and Babashka  </h1> <p> <time datetime="2023-10-15"> 2023-10-15 </time> </p> <p>At home I run a small server for running home assistant and other small projects, but I’ve been running into a problem recently: updates.</p>
<p>All the containers I have running in my system run with specific version tags.
I do this because I prefer to manually update each container as a new version comes out.
That way I’m up to date on new features (and can stay mostly on top of breaking changes).</p>
<p>The problem with this setup is that solutions like <a href="https://containrrr.dev/watchtower/">watchtower</a> &amp; <a href="https://github.com/crazy-max/diun">duin</a> (which are otherwise excellent) will <strong>not</strong> check for new tags.
These solutions also seemed way more complicated than they needed to be for my purposes.</p>
<p>All I want to do is:</p>
<ul>
<li>Look for updates</li>
<li>Notify me via telegram (so easy to integrate)</li>
<li>And possibly have some way of ignoring containers.</li>
</ul>
<h1 id="the-solution">The solution</h1>
<p>Write my own of course, that never goes wrong.</p>
<p>I started by looking for some tools to actually query the data that I wanted:</p>
<ul>
<li>The list of labels for upstream docker containers</li>
<li>The list of locally running containers &amp; their tags</li>
</ul>
<p>For the later just using the <code>docker</code> cli seemed like the simplest choice.
The former took a bit more searching.
At first I tried to look for a REST API and found that both dockerhub and github had one, but as they’re different so I’d have to write (and maintain) two interfaces.
Instead I looked at other tools and came across <a href="https://github.com/regclient/regclient">regclient</a> which provides <code>regctl tags ls</code> which was <em>exactly</em> what I was looking for (as you’ll soon see).</p>
<h1 id="regctl">Regctl</h1>
<p>Let’s first look at the output:</p>
<blockquote>
<p><strong>Note:</strong> I actually ran it via docker rather than install it: <code>docker container run -i --rm ghcr.io/regclient/regctl:latest tag ls ubuntu</code></p>
</blockquote>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> regctl</span><span style="color:#9ECBFF"> tags</span><span style="color:#9ECBFF"> ls</span><span style="color:#9ECBFF"> ubuntu</span></span>
<span class="line"><span style="color:#B392F0">10.04</span></span>
<span class="line"><span style="color:#B392F0">12.04</span></span>
<span class="line"><span style="color:#B392F0">12.04.5</span></span>
<span class="line"><span style="color:#B392F0">12.10</span></span>
<span class="line"><span style="color:#B392F0">13.04</span></span>
<span class="line"><span style="color:#B392F0">13.10</span></span>
<span class="line"><span style="color:#B392F0">14.04</span></span>
<span class="line"><span style="color:#B392F0">14.04.1</span></span>
<span class="line"><span style="color:#79B8FF">...</span></span></code></pre>
<p>A newline separated list, what could be easier?
Let’s parse it:</p>
<div class="code-with-filename"> <code class="codeblock-name">src/regctl.clj</code> <pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="clojure"><code><span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">ns</span><span style="color:#B392F0"> regctl</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#79B8FF">:require</span></span>
<span class="line"><span style="color:#E1E4E8">    [babashka.process </span><span style="color:#79B8FF">:refer</span><span style="color:#E1E4E8"> [sh]]</span></span>
<span class="line"><span style="color:#E1E4E8">    [clojure.string </span><span style="color:#79B8FF">:as</span><span style="color:#E1E4E8"> str]))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">defn</span><span style="color:#B392F0"> regctl</span><span style="color:#E1E4E8"> [&amp; args]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">-&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">apply</span><span style="color:#E1E4E8"> sh </span><span style="color:#9ECBFF">&quot;regctl&quot;</span><span style="color:#E1E4E8"> args)</span></span>
<span class="line"><span style="color:#79B8FF">      :out</span><span style="color:#E1E4E8">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">defn</span><span style="color:#B392F0"> tags</span><span style="color:#E1E4E8"> [repo]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">-&gt;&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">regctl</span><span style="color:#9ECBFF"> &quot;tag&quot;</span><span style="color:#9ECBFF"> &quot;ls&quot;</span><span style="color:#E1E4E8"> repo)</span></span>
<span class="line"><span style="color:#E1E4E8">       str/split-lines</span></span>
<span class="line"><span style="color:#E1E4E8">       (</span><span style="color:#B392F0">remove</span><span style="color:#E1E4E8"> empty?)))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#B392F0">comment</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">count</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">tags</span><span style="color:#9ECBFF"> &quot;debian&quot;</span><span style="color:#E1E4E8">)) </span><span style="color:#6A737D">; =&gt; 1893</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">count</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">tags</span><span style="color:#9ECBFF"> &quot;ghcr.io/akeboshiwind/rss-filter&quot;</span><span style="color:#E1E4E8">)) </span><span style="color:#6A737D">; =&gt; 6</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">count</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">tags</span><span style="color:#9ECBFF"> &quot;does-not-exist&quot;</span><span style="color:#E1E4E8">)) </span><span style="color:#6A737D">; =&gt; 0</span></span>
<span class="line"><span style="color:#E1E4E8">  ,)</span></span></code></pre> </div>
<p>Of course there’s no error handling here, but I said I wanted this to be simple right?</p>
<h1 id="parsing-versions">Parsing versions</h1>
<p>So, given that I want to check for updates I’ll need to know which tag is the latest version.
But how do I tell which tag <strong>is</strong> the latest version? They’re just strings after all.</p>
<p>Different docker repos use all sorts of different systems, but most of them provide a plain <a href="https://semver.org/">semver</a> version tag.
For those that don’t I’ll figure out something in the future I guess.</p>
<p>Writing some code to parse versions wasn’t too hard, but it was fiddly getting the comparison right:</p>
<div class="code-with-filename"> <code class="codeblock-name">src/semver.clj</code> <pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="clojure"><code><span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">ns</span><span style="color:#B392F0"> semver</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">defn</span><span style="color:#B392F0"> semver?</span><span style="color:#E1E4E8"> [tag]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">boolean</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">re-matches</span><span style="color:#DBEDFF"> #&quot;^v?</span><span style="color:#85E89D;font-weight:bold">\d</span><span style="color:#DBEDFF">+(</span><span style="color:#85E89D;font-weight:bold">\.\d</span><span style="color:#DBEDFF">+(</span><span style="color:#85E89D;font-weight:bold">\.\d</span><span style="color:#DBEDFF">+)?)?$&quot;</span><span style="color:#E1E4E8"> tag)))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">defn</span><span style="color:#B392F0"> semver</span><span style="color:#E1E4E8"> [tag]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#F97583">when-let</span><span style="color:#E1E4E8"> [match (</span><span style="color:#B392F0">re-find</span><span style="color:#DBEDFF"> #&quot;^v?(</span><span style="color:#85E89D;font-weight:bold">\d</span><span style="color:#DBEDFF">+)(</span><span style="color:#85E89D;font-weight:bold">\.</span><span style="color:#DBEDFF">(</span><span style="color:#85E89D;font-weight:bold">\d</span><span style="color:#DBEDFF">+)(</span><span style="color:#85E89D;font-weight:bold">\.</span><span style="color:#DBEDFF">(</span><span style="color:#85E89D;font-weight:bold">\d</span><span style="color:#DBEDFF">+))?)?$&quot;</span></span>
<span class="line"><span style="color:#E1E4E8">                             tag)]</span></span>
<span class="line"><span style="color:#E1E4E8">    (</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> [[_ major _ minor _ patch] match]</span></span>
<span class="line"><span style="color:#E1E4E8">      {</span><span style="color:#79B8FF">:major</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">Integer/parseInt</span><span style="color:#E1E4E8"> major)</span></span>
<span class="line"><span style="color:#79B8FF">       :minor</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> minor (</span><span style="color:#B392F0">Integer/parseInt</span><span style="color:#E1E4E8"> minor) </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#79B8FF">       :patch</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> patch (</span><span style="color:#B392F0">Integer/parseInt</span><span style="color:#E1E4E8"> patch) </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)})))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">defn</span><span style="color:#B392F0"> compare-semver</span><span style="color:#E1E4E8"> [a b]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> [major (</span><span style="color:#B392F0">compare</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">:major</span><span style="color:#E1E4E8"> a) (</span><span style="color:#79B8FF">:major</span><span style="color:#E1E4E8"> b))]</span></span>
<span class="line"><span style="color:#E1E4E8">    (</span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">not=</span><span style="color:#E1E4E8"> major </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      major</span></span>
<span class="line"><span style="color:#E1E4E8">      (</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> [minor (</span><span style="color:#B392F0">compare</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">:minor</span><span style="color:#E1E4E8"> a) (</span><span style="color:#79B8FF">:minor</span><span style="color:#E1E4E8"> b))]</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#F97583">if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">not=</span><span style="color:#E1E4E8"> minor </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">          minor</span></span>
<span class="line"><span style="color:#E1E4E8">          (</span><span style="color:#B392F0">compare</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">:patch</span><span style="color:#E1E4E8"> a) (</span><span style="color:#79B8FF">:patch</span><span style="color:#E1E4E8"> b)))))))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">defn</span><span style="color:#B392F0"> &gt;semver</span><span style="color:#E1E4E8"> [a b]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">compare-semver</span><span style="color:#E1E4E8"> a b) </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))</span></span></code></pre> </div>
<p>I’m not happy with that regex, maybe using a parser (for this and for docker later) would have been clearer?
Or maybe just using a library someone else wrote?
But I really wanted to get away with not using any libraries so this is fine.</p>
<p>Now I can filter, sort &amp; so on to my hearts content:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="clojure"><code><span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> [tags [</span><span style="color:#9ECBFF">&quot;1&quot;</span><span style="color:#9ECBFF"> &quot;1.2&quot;</span><span style="color:#9ECBFF"> &quot;1.2.3&quot;</span></span>
<span class="line"><span style="color:#9ECBFF">            &quot;v1&quot;</span><span style="color:#9ECBFF"> &quot;v1.2&quot;</span><span style="color:#9ECBFF"> &quot;v1.2.3&quot;</span></span>
<span class="line"><span style="color:#9ECBFF">            &quot;12&quot;</span><span style="color:#9ECBFF"> &quot;12.23&quot;</span><span style="color:#9ECBFF"> &quot;12.23.34&quot;</span></span>
<span class="line"><span style="color:#9ECBFF">            &quot;test&quot;</span><span style="color:#9ECBFF"> &quot;1.2.3-SNAPSHOT&quot;</span><span style="color:#9ECBFF"> &quot;1.2.3.4&quot;</span><span style="color:#E1E4E8">]]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">println</span><span style="color:#9ECBFF"> &quot;count:&quot;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">count</span><span style="color:#E1E4E8"> tags))</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">println</span><span style="color:#9ECBFF"> &quot;filtered:&quot;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">-&gt;&gt;</span><span style="color:#E1E4E8"> tags (</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8"> semver?) count))</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">println</span><span style="color:#9ECBFF"> &quot;latest:&quot;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">-&gt;&gt;</span><span style="color:#E1E4E8"> tags</span></span>
<span class="line"><span style="color:#E1E4E8">                          (</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8"> semver?)</span></span>
<span class="line"><span style="color:#E1E4E8">                          (</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8"> semver)</span></span>
<span class="line"><span style="color:#E1E4E8">                          (</span><span style="color:#B392F0">sort</span><span style="color:#E1E4E8"> compare-semver)</span></span>
<span class="line"><span style="color:#E1E4E8">                          last))</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">println</span><span style="color:#9ECBFF"> &quot;(&gt; </span><span style="color:#79B8FF">\&quot;</span><span style="color:#9ECBFF">1.2.3</span><span style="color:#79B8FF">\&quot;</span><span style="color:#79B8FF"> \&quot;</span><span style="color:#9ECBFF">1.0</span><span style="color:#79B8FF">\&quot;</span><span style="color:#9ECBFF">):&quot;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">&gt;semver</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">semver</span><span style="color:#9ECBFF"> &quot;1.2.3&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                                             (</span><span style="color:#B392F0">semver</span><span style="color:#9ECBFF"> &quot;1.0&quot;</span><span style="color:#E1E4E8">))))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">; (out) count: 12</span></span>
<span class="line"><span style="color:#6A737D">; (out) filtered: 9</span></span>
<span class="line"><span style="color:#6A737D">; (out) latest: {:major 12, :minor 23, :patch 34}</span></span>
<span class="line"><span style="color:#6A737D">; (out) (&gt; &quot;1.2.3&quot; &quot;1.0&quot;): true</span></span></code></pre>
<h1 id="docker">Docker</h1>
<p>Next we’re on to docker itself.
It posed a bit of difficulty first because I didn’t really want to parse this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> docker</span><span style="color:#9ECBFF"> ps</span></span>
<span class="line"><span style="color:#B392F0">CONTAINER</span><span style="color:#9ECBFF"> ID</span><span style="color:#9ECBFF">   IMAGE</span><span style="color:#9ECBFF">                              COMMAND</span><span style="color:#9ECBFF">                  CREATED</span><span style="color:#9ECBFF">             STATUS</span><span style="color:#9ECBFF">             PORTS</span><span style="color:#9ECBFF">                    NAMES</span></span>
<span class="line"><span style="color:#B392F0">739ac2d78713</span><span style="color:#9ECBFF">   ubuntu:20.04</span><span style="color:#9ECBFF">                       &quot;/bin/bash&quot;</span><span style="color:#9ECBFF">              About</span><span style="color:#9ECBFF"> an</span><span style="color:#9ECBFF"> hour</span><span style="color:#9ECBFF"> ago</span><span style="color:#9ECBFF">   Up</span><span style="color:#9ECBFF"> About</span><span style="color:#9ECBFF"> an</span><span style="color:#9ECBFF"> hour</span><span style="color:#9ECBFF">                            quirky_fermat</span></span>
<span class="line"><span style="color:#B392F0">80f067bc14e8</span><span style="color:#9ECBFF">   ghcr.io/esphome/esphome:2023.9.3</span><span style="color:#9ECBFF">   &quot;/entrypoint.sh dash…&quot;</span><span style="color:#79B8FF">   3</span><span style="color:#9ECBFF"> hours</span><span style="color:#9ECBFF"> ago</span><span style="color:#9ECBFF">         Up</span><span style="color:#79B8FF"> 3</span><span style="color:#9ECBFF"> hours</span><span style="color:#9ECBFF">         6052/tcp</span><span style="color:#9ECBFF">                 interesting_galileo</span></span>
<span class="line"><span style="color:#B392F0">8fef78050a03</span><span style="color:#9ECBFF">   postgres</span><span style="color:#9ECBFF">                           &quot;docker-entrypoint.s…&quot;</span><span style="color:#79B8FF">   3</span><span style="color:#9ECBFF"> hours</span><span style="color:#9ECBFF"> ago</span><span style="color:#9ECBFF">         Up</span><span style="color:#79B8FF"> 3</span><span style="color:#9ECBFF"> hours</span><span style="color:#9ECBFF">         0.0.0.0:5432</span><span style="color:#E1E4E8">-</span><span style="color:#F97583">&gt;</span><span style="color:#9ECBFF">5432/tcp</span><span style="color:#9ECBFF">   silly_carson</span></span></code></pre>
<p>It turns out there’s a lovely <code>--format</code> option that let’s to format the output exactly how you’d want to:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> docker</span><span style="color:#9ECBFF"> ps</span><span style="color:#79B8FF"> --format</span><span style="color:#9ECBFF"> &#39;{{.Image}}&#39;</span></span>
<span class="line"><span style="color:#B392F0">ubuntu:20.04</span></span>
<span class="line"><span style="color:#B392F0">ghcr.io/esphome/esphome:2023.9.3</span></span>
<span class="line"><span style="color:#B392F0">postgres</span></span></code></pre>
<p>Time to parse that using clojure:</p>
<div class="code-with-filename"> <code class="codeblock-name">src/docker.clj</code> <pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="clojure"><code><span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">ns</span><span style="color:#B392F0"> docker</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#79B8FF">:require</span></span>
<span class="line"><span style="color:#E1E4E8">    [babashka.process </span><span style="color:#79B8FF">:refer</span><span style="color:#E1E4E8"> [sh]]</span></span>
<span class="line"><span style="color:#E1E4E8">    [clojure.string </span><span style="color:#79B8FF">:as</span><span style="color:#E1E4E8"> str]))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">defn</span><span style="color:#B392F0"> docker</span><span style="color:#E1E4E8"> [&amp; args]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">-&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">apply</span><span style="color:#E1E4E8"> sh </span><span style="color:#9ECBFF">&quot;docker&quot;</span><span style="color:#E1E4E8"> args)</span></span>
<span class="line"><span style="color:#79B8FF">      :out</span><span style="color:#E1E4E8">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">defn</span><span style="color:#B392F0"> parse-ps</span><span style="color:#E1E4E8"> [line]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> [[image labels] (</span><span style="color:#B392F0">str/split</span><span style="color:#E1E4E8"> line </span><span style="color:#DBEDFF">#&quot;</span><span style="color:#85E89D;font-weight:bold">\s</span><span style="color:#DBEDFF">+&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        labels (</span><span style="color:#F97583">when-not</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">empty?</span><span style="color:#E1E4E8"> labels)</span></span>
<span class="line"><span style="color:#E1E4E8">                 (</span><span style="color:#B392F0">-&gt;&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">str/split</span><span style="color:#E1E4E8"> labels </span><span style="color:#DBEDFF">#&quot;,&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                      (</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8"> #(</span><span style="color:#B392F0">str/split</span><span style="color:#E1E4E8"> % </span><span style="color:#DBEDFF">#&quot;=&quot;</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#6A737D">                      ;; Set a default value for labels without a value</span></span>
<span class="line"><span style="color:#E1E4E8">                      (</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">fn</span><span style="color:#E1E4E8"> [[k v]] [k (</span><span style="color:#B392F0">or</span><span style="color:#E1E4E8"> v </span><span style="color:#9ECBFF">&quot;&quot;</span><span style="color:#E1E4E8">)]))</span></span>
<span class="line"><span style="color:#E1E4E8">                      (</span><span style="color:#B392F0">into</span><span style="color:#E1E4E8"> {})))]</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span><span style="color:#79B8FF">:image</span><span style="color:#E1E4E8"> image</span></span>
<span class="line"><span style="color:#79B8FF">     :labels</span><span style="color:#E1E4E8"> labels}))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">defn</span><span style="color:#B392F0"> ps</span><span style="color:#E1E4E8"> []</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">-&gt;&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">docker</span><span style="color:#9ECBFF"> &quot;ps&quot;</span><span style="color:#9ECBFF"> &quot;--format&quot;</span><span style="color:#9ECBFF"> &quot;{{.Image}} {{.Labels}}&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">       str/split-lines</span></span>
<span class="line"><span style="color:#E1E4E8">       (</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8"> parse-ps)))</span></span></code></pre> </div>
<p>I ended up adding <code>{{.Labels}}</code> too because I want to use them to ignore containers.</p>
<h1 id="putting-it-all-together">Putting it all together</h1>
<p>I have all the pieces, let’s put them together.
First we want to get the latest tag for a given image:</p>
<div class="code-with-filename"> <code class="codeblock-name">src/core.clj</code> <pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="clojure"><code><span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">ns</span><span style="color:#B392F0"> core</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#79B8FF">:require</span></span>
<span class="line"><span style="color:#E1E4E8">    [docker </span><span style="color:#79B8FF">:as</span><span style="color:#E1E4E8"> d]</span></span>
<span class="line"><span style="color:#E1E4E8">    [regctl </span><span style="color:#79B8FF">:as</span><span style="color:#E1E4E8"> r]</span></span>
<span class="line"><span style="color:#E1E4E8">    [semver </span><span style="color:#79B8FF">:refer</span><span style="color:#E1E4E8"> [semver? semver compare-semver &gt;semver]]</span></span>
<span class="line"><span style="color:#E1E4E8">    [clojure.string </span><span style="color:#79B8FF">:as</span><span style="color:#E1E4E8"> str]))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">defn</span><span style="color:#B392F0"> latest-tag</span><span style="color:#E1E4E8"> [repo]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">-&gt;&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">r/tags</span><span style="color:#E1E4E8"> repo)</span></span>
<span class="line"><span style="color:#E1E4E8">       (</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8"> semver?)</span></span>
<span class="line"><span style="color:#E1E4E8">       (</span><span style="color:#B392F0">sort-by</span><span style="color:#E1E4E8"> semver compare-semver)</span></span>
<span class="line"><span style="color:#E1E4E8">       last))</span></span></code></pre> </div>
<p>Next, <code>docker ps</code> gives us both an image and a tag (but only sometimes) so let’s parse those:</p>
<div class="code-with-filename"> <code class="codeblock-name">src/core.clj</code> <pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="clojure"><code><span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">defn</span><span style="color:#B392F0"> name</span><span style="color:#E1E4E8">&amp;</span><span style="color:#B392F0">tag</span><span style="color:#E1E4E8"> [full-name]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> [[name tag] (</span><span style="color:#B392F0">str/split</span><span style="color:#E1E4E8"> full-name </span><span style="color:#DBEDFF">#&quot;:&quot;</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span><span style="color:#79B8FF">:name</span><span style="color:#E1E4E8"> name </span><span style="color:#79B8FF">:tag</span><span style="color:#E1E4E8"> tag}))</span></span></code></pre> </div>
<p>I’m not super happy with that function name, but something like <code>image-name</code> seemed like it should really split out the <code>:registry</code> and <code>:repo</code> too which I don’t want to do here.</p>
<p>Now that we <em>actually</em> have all the pieces, let’s get our list of images.
Note that I’ve ignored images that don’t have tags. That’s fine for my purposes.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="clojure"><code><span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> [images (</span><span style="color:#B392F0">-&gt;&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">d/ps</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                  (</span><span style="color:#B392F0">remove</span><span style="color:#E1E4E8"> #(</span><span style="color:#B392F0">-&gt;</span><span style="color:#E1E4E8"> % </span><span style="color:#79B8FF">:labels</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">get</span><span style="color:#9ECBFF"> &quot;version-checker.ignore&quot;</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">                  (</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">comp</span><span style="color:#E1E4E8"> name&amp;tag </span><span style="color:#79B8FF">:image</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">                  (</span><span style="color:#B392F0">remove</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">complement</span><span style="color:#79B8FF"> :tag</span><span style="color:#E1E4E8">)))]</span></span>
<span class="line"><span style="color:#E1E4E8">  ...)</span></span></code></pre>
<p>Finally for each image let’s get the <code>latest-tag</code> then see if that’s newer than our current tag:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="clojure"><code><span class="line"><span style="color:#E1E4E8">(</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> [images (</span><span style="color:#B392F0">-&gt;&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">d/ps</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                  (</span><span style="color:#B392F0">remove</span><span style="color:#E1E4E8"> #(</span><span style="color:#B392F0">-&gt;</span><span style="color:#E1E4E8"> % </span><span style="color:#79B8FF">:labels</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">get</span><span style="color:#9ECBFF"> &quot;version-checker.ignore&quot;</span><span style="color:#E1E4E8">)))</span></span>
<span class="line"><span style="color:#E1E4E8">                  (</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">comp</span><span style="color:#E1E4E8"> name&amp;tag </span><span style="color:#79B8FF">:image</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">                  (</span><span style="color:#B392F0">remove</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">complement</span><span style="color:#79B8FF"> :tag</span><span style="color:#E1E4E8">)))]</span></span>
<span class="line"><span style="color:#E1E4E8">  (</span><span style="color:#B392F0">doseq</span><span style="color:#E1E4E8"> [{</span><span style="color:#79B8FF">:keys</span><span style="color:#E1E4E8"> [name tag]} images]</span></span>
<span class="line"><span style="color:#E1E4E8">    (</span><span style="color:#B392F0">println</span><span style="color:#9ECBFF"> &quot;Checking: &quot;</span><span style="color:#E1E4E8"> name </span><span style="color:#9ECBFF">&quot;:&quot;</span><span style="color:#E1E4E8"> tag)</span></span>
<span class="line"><span style="color:#E1E4E8">    (</span><span style="color:#F97583">let</span><span style="color:#E1E4E8"> [latest-tag (</span><span style="color:#B392F0">latest-tag</span><span style="color:#E1E4E8"> name)]</span></span>
<span class="line"><span style="color:#E1E4E8">      (</span><span style="color:#F97583">when</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">&gt;semver</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">semver</span><span style="color:#E1E4E8"> latest-tag) (</span><span style="color:#B392F0">semver</span><span style="color:#E1E4E8"> tag))</span></span>
<span class="line"><span style="color:#E1E4E8">        (</span><span style="color:#B392F0">println</span><span style="color:#9ECBFF"> &quot;Later tag found:&quot;</span><span style="color:#E1E4E8"> latest-tag)))))</span></span></code></pre>
<p>And that’s it!</p>
<p>Other than deployment and notifications. Maybe another time…</p>
<p>The complete code can be found <a href="https://github.com/Akeboshiwind/whale-watcher">here</a>.</p>  <p> <a href="https://github.com/Akeboshiwind/akeboshiwind.github.io/discussions/1">Discuss this post</a> </p> </article>  </main> <footer> <p>&copy; 2026 Blog by the Rocks</p> </footer> </body></html>